"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8610],{1220:(e,t,i)=>{i.d(t,{H:()=>c});var r=i(81856),a=i(91838);i(57845),i(61939),i(33638);var s=i(12709),n=i(71017),l=i(92713),o=i(86942),u=i(33498),h=i(82698);let f=class extends n.A.ClonableMixin(l.A){constructor(e){super(e),this.name=void 0,this.method="none",this.value=void 0,this.bandIds=void 0,this.renderer=void 0}};(0,r._)([(0,a.MZ)({type:String,json:{write:{isRequired:!0}}})],f.prototype,"name",void 0),(0,r._)([(0,a.MZ)({type:["raster-function-template","variable","none"],json:{write:{isRequired:!0}}}),(0,u.e)({rasterFunctionTemplate:"raster-function-template",variable:"variable",none:"none"})],f.prototype,"method",void 0),(0,r._)([(0,a.MZ)({type:String,json:{write:{isRequired:!0}}})],f.prototype,"value",void 0),(0,r._)([(0,a.MZ)({type:[o.jz],json:{write:{isRequired:!0}}})],f.prototype,"bandIds",void 0),(0,r._)([(0,a.MZ)({types:h.uy,json:{write:!0,origins:{"web-scene":{types:h.Gj,write:{overridePolicy:e=>({enabled:e&&"vector-field"!==e.type&&"flow"!==e.type})}}}}})],f.prototype,"renderer",void 0);let p=f=(0,r._)([(0,s.$)("esri.renderers.support.RasterPresetRenderer")],f),c=e=>{let t=class extends e{constructor(){super(...arguments),this.activePresetRendererName=null,this.presetRenderers=null}};return(0,r._)([(0,a.MZ)({type:String,json:{name:"layerDefinition.activePresetRendererName",write:{allowNull:!0}}})],t.prototype,"activePresetRendererName",void 0),(0,r._)([(0,a.MZ)({type:[p],json:{name:"layerDefinition.presetRenderers",write:!0}})],t.prototype,"presetRenderers",void 0),t=(0,r._)([(0,s.$)("esri.layers.mixins.RasterPresetRendererMixin")],t)}},11559:(e,t,i)=>{i.d(t,{A:()=>o});var r=i(81856),a=i(92713),s=i(91838);i(57845),i(61939),i(33638);var n=i(12709);let l=class extends a.A{get affectsPixelSize(){return!1}forwardTransform(e){return e}inverseTransform(e){return e}};(0,r._)([(0,s.MZ)()],l.prototype,"affectsPixelSize",null),(0,r._)([(0,s.MZ)({json:{write:!0}})],l.prototype,"spatialReference",void 0);let o=l=(0,r._)([(0,n.$)("esri.layers.support.rasterTransforms.BaseRasterTransform")],l)},51122:(e,t,i)=>{var r;i.d(t,{u:()=>r}),function(e){e[e.KILOBYTES=1024]="KILOBYTES",e[e.MEGABYTES=1048576]="MEGABYTES",e[e.GIGABYTES=0x40000000]="GIGABYTES"}(r||(r={}))},58610:(e,t,i)=>{i.r(t),i.d(t,{default:()=>eB});var r=i(81856),a=i(39267),s=i(71017),n=i(32391),l=i(61939),o=i(21892),u=i(92753),h=i(45257),f=i(91838),p=i(86942),c=i(57845);i(33638);var d=i(12709),m=i(64171),y=i(81877),g=i(24743),w=i(60349),x=i(78218),v=i(2043),b=i(54882),I=i(1220),_=i(6255),A=i(23281),S=i(70442),T=i(76572),R=i(80824),M=i(11984),C=i(76809),O=i(72076),F=i(82245),P=i(70152),k=i(61414),D=i(91463),N=i(28105),E=i(93409),L=i(50518);function B(e){return["x","e","east","long","longitude"].includes(e.toLowerCase())}function z(e){return["y","n","west","lat","latitude"].includes(e.toLowerCase())}function J(e){let t=(0,N.Z0)();return t?e[t]??Object.values(e)[0]:Object.values(e)[0]}function V(){return Math.round(255*Math.random())}var $=i(22580),U=i(65018),j=i(24088),G=i(93782),H=i(51725);let Z=class extends F.A{constructor(){super(...arguments),this.datasetFormat="MEMORY",this.source=null}get url(){return""}fetchRawTile(e,t,i,r={}){if(!this._pixelBlockTiles){let{rasterInfo:a}=this,[s,n]=a.storageInfo.tileInfo.size,{sliceId:l}=r,{pixelBlocks:o}=this.source,u={pixelBlock:null==l?o[0]:o[l],useBilinear:"thematic"!==a.dataType,tileSize:{width:s,height:n},level:e,row:t,col:i};return Promise.resolve(this.rasterJobHandler?this.rasterJobHandler.clipTile(u,r):(0,G.J$)(u))}return Promise.resolve(this._pixelBlockTiles.get(`${e}/${t}/${i}`))}async _open(e){let t=this.source,{pixelBlocks:i,attributeTable:r,statistics:a,histograms:s,name:n,nativeExtent:l,transform:o}=t,u=i[0],{width:h,height:f,pixelType:p}=u,c=t.extent??new k.A({xmin:-.5,ymin:.5,xmax:h-.5,ymax:f-.5,spatialReference:new D.A({wkid:3857})}),d=t.isPseudoSpatialReference??!t.extent,m={x:c.width/h,y:c.height/f},y={...t.keyProperties};r&&(y.DataType="Thematic");let g=new U.A({width:h,height:f,pixelType:p,extent:c,nativeExtent:l,attributeTable:r,transform:o,pixelSize:m,spatialReference:c.spatialReference,bandCount:u.pixels.length,keyProperties:y,multidimensionalInfo:t.multidimensionalInfo,statistics:a,isPseudoSpatialReference:d,histograms:s});this.ioConfig.skipMapInfo&&this.updateImageSpaceRasterInfo(g),this.createRemoteDatasetStorageInfo(g,512,512),this._set("rasterInfo",g),this.updateTileInfo(),g.multidimensionalInfo?await this._buildMDimStats(t.pixelBlocks,g.multidimensionalInfo):await this._buildInMemoryRaster(u,{width:512,height:512},e),g.multidimensionalInfo||(this.source=null),this.datasetName=n}async _buildInMemoryRaster(e,t,i){let{rasterInfo:r}=this,a=r.storageInfo.maximumPyramidLevel??0,s="thematic"!==r.dataType,l=this.rasterJobHandler?this.rasterJobHandler.split({pixelBlock:e,tileSize:t,maximumPyramidLevel:a,useBilinear:s},i):Promise.resolve((0,G.lD)(e,t,a,s)),o=null!=r.statistics,h=null!=r.histograms,f=this.ioConfig.skipStatistics||o?Promise.resolve({statistics:null,histograms:null}):this.rasterJobHandler?this.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:e},i):Promise.resolve((0,H.f4)(e)),p=await (0,u.Lx)([l,f]);if(!p[0].value&&p[1].value)throw new n.A("inmemory-raster:open","failed to build in memory raster");this._pixelBlockTiles=p[0].value,o||(r.statistics=p[1].value?.statistics),h||(r.histograms=p[1].value?.histograms)}async _buildMDimStats(e,t,i){for(let r=0;r<t.variables.length;r++){let a=t.variables[r];if(a.statistics)continue;let s=a.dimensions.map(e=>new $.A({variableName:a.name,dimensionName:e.name,values:[e.values?.[0]??e.extent?.[0]],isSlice:!0})),n=(0,j.NG)(s,t),l=null==n?null:e[n];if(null==l)continue;let o=this.rasterJobHandler?await this.rasterJobHandler.computeStatisticsHistograms({pixelBlock:l},i):(0,H.eH)(l);a.statistics=o.statistics,a.histograms||(a.histograms=o.histograms)}}};(0,r._)([(0,f.MZ)({type:String,json:{write:!0}})],Z.prototype,"datasetFormat",void 0),(0,r._)([(0,f.MZ)()],Z.prototype,"source",void 0),(0,r._)([(0,f.MZ)()],Z.prototype,"url",null);let q=Z=(0,r._)([(0,d.$)("esri.layers.support.rasterDatasets.InMemoryRaster")],Z);var W=i(49570);let X=class extends F.A{constructor(){super(...arguments),this.datasetFormat="CovJSON"}fetchRawTile(e,t,i,r={}){return this._inMemoryRaster.fetchRawTile(e,t,i,r)}async _open(e){let{extent:t,pixelBlocks:i,multidimensionalInfo:r,attributeTable:a,bandNames:s}=await this._fetchData(e),{statistics:n,histograms:l}=(0,H.eH)(i[0]),o=s?.map(e=>({BandName:e})),u=new q({source:{extent:t,pixelBlocks:i,attributeTable:a?W.A.fromJSON(a):null,multidimensionalInfo:r,statistics:n,histograms:l,keyProperties:{DataType:a?"Thematic":r?"Scientific":"Generic",BandProperties:o},isPseudoSpatialReference:!1}});await u.open(),this._inMemoryRaster=u;let h=this.source?"":this.url.slice(this.url.lastIndexOf("/")+1);this._set("datasetName",h.slice(0,h.indexOf("."))),this._set("rasterInfo",u.rasterInfo)}async _fetchData(e){let t=this.source??(await this.request(this.url,{signal:e?.signal})).data,i="imagery-tile-layer:open-coverage-json";if("coverage"!==t.type?.toLowerCase()||"grid"!==t.domain?.domainType?.toLowerCase())throw new n.A(i,"Only coverage with Grid domain type is supported");if(!t.ranges)throw new n.A(i,"Missing ranges in the grid coverage data");if(!t.domain.referencing?.length)throw new n.A(i,"Missing domain referencing in the grid coverage data");let r=Object.values(t.ranges);for(let e=0;e<r.length;e++){let{axisNames:t,shape:a,type:s,values:l}=r[e];if(!("ndarray"===s.toLowerCase()&&l?.length&&t?.length&&a?.length))throw new n.A(i,"Only ranges with valid NdArray, axisNames, shape, and inline values are supported");if(!(B(t[t.length-1])&&z(t[t.length-2])))throw new n.A(i,"Only row-major ordered pixel values are supported. X axis must be the last axis.")}return function(e){let{width:t,height:i,extent:r,dimensions:a}=function(e){let{axes:t}=e.domain,i=Object.keys(t),r=[],a=[],s=-1,n=-1,l=[];for(let e=0;e<i.length;e++){let o=i[e];B(o)?s=e:z(o)&&(n=e);let u=t[o],h=[];if("values"in u){u.values.forEach(e=>h.push("string"==typeof e?new Date(e).getTime():e));let e=h[1]-h[0];r.push([h[0]-.5*e,h[h.length-1]+.5*e]),a.push(e)}else{let{start:e,stop:t,num:i}=u,s=(t-e)/(i-1);r.push([e-.5*s,t+.5*s]),a.push(s);for(let t=0;t<i;t++)h.push(e+s*t)}l.push({name:o,values:h,extent:[h[0],h[h.length-1]]})}s>-1&&-1===n?n=+(0===s):n>-1&&-1===s?s=+(0===n):-1===n&&-1===s&&(s=0,n=1),l=l.filter((e,t)=>t!==s&&t!==n);let{referencing:o}=e.domain,u=o.find(e=>e.coordinates.includes(i[s])).system.id,h=u?.slice(u.lastIndexOf("/")+1),f=null==h||"CRS84"===h?4326:Number(h),p=new D.A({wkid:f}),[c,d]=r[s],[m,y]=r[n],g=new k.A({xmin:c,xmax:d,ymin:m,ymax:y,spatialReference:p});return{width:Math.round(g.width/a[s]),height:Math.round(g.height/a[n]),extent:g,dimensions:l}}(e),{ranges:s}=e,n=Object.keys(s).sort((e,t)=>e<t?-1:1),l=[];for(let e=0;e<n.length;e++){let t=n[e];a?.length&&l.push({name:t,dimensions:a})}let o=function(e){let t={},{parameters:i}=e;if(!i)return t;for(let[e,r]of Object.entries(i)){let{type:i,description:a,unit:s,categoryEncoding:n,observedProperty:l}=r;if("Parameter"===i&&(t[e]={},a&&(t[e].description=J(a)),s&&(t[e].unit=s.label?J(s.label):null,t[e].symbol=s.symbol?.value),n)){let i=Object.entries(n).map((e,t)=>({OID:t,Value:Number(e[1]),ClassName:e[0].slice(e[0].lastIndexOf("/")+1),Count:1})),r=!1;l?.categories?.length&&(l.categories.forEach(e=>{if(!e.id)return;let t=e.id.slice(e.id.lastIndexOf("/")+1),a=i.find(e=>e.ClassName===t);if(a&&(a.Label=e.label?J(e.label):null,e.preferredColor)){let t=P.A.fromHex(e.preferredColor);t&&(r=!0,a.Red=t.r,a.Green=t.g,a.Blue=t.b)}}),r&&i.forEach(e=>{null==e.Red&&(e.Red=V(),e.Green=V(),e.Blue=V())}));let a={objectIdFieldName:"",fields:[{name:"OID",type:"esriFieldTypeOID",alias:"OID",domain:null},{name:"Value",type:"esriFieldTypeInteger",alias:"Value",domain:null},{name:"Count",type:"esriFieldTypeDouble",alias:"Count",domain:null},{name:"ClassName",type:"esriFieldTypeString",alias:"ClassName",domain:null,length:50},{name:"Label",type:"esriFieldTypeString",alias:"Label",domain:null,length:50}],features:i.map(e=>({attributes:e}))};r&&a.fields.push({name:"Red",type:"esriFieldTypeInteger",alias:"Red",domain:null},{name:"Green",type:"esriFieldTypeInteger",alias:"Green",domain:null},{name:"Blue",type:"esriFieldTypeInteger",alias:"Blue",domain:null}),t[e].attributeTable=a}}return t}(e);l.forEach(e=>o[e.name]&&Object.assign(e,o[e.name]));let u=l.length?{variables:l}:void 0,h=[];for(let e=0;e<n.length;e++){let{values:r,dataType:l,axisNames:o,shape:u}=s[n[e]],f=u.length>2?e*u.slice(0,-2).reduce((e,t)=>e*t):0,p=o.slice(0,-2),c=u.slice(0,-2),d="float"===l?"f32":function(e){let t=Number.MAX_VALUE,i=-Number.MAX_VALUE;for(let r=0;r<e.length;r++){let a=e[r];null!=a&&(a<t&&(t=a),a>i&&(i=a))}return(0,L.X1)(t,i)}(r),m=t*i,y=r.length/m;for(let s=0;s<y;s++){let n=E.A.createEmptyBand(d,m),l=new Uint8Array(m).fill(255),o=!1,u=s*m;for(let e=0;e<m;e++){let t=r[u+e];null==t?(l[e]=0,o=!0):n[e]=t}if(0===e||a?.length){let e=new E.A({width:t,height:i,mask:o?l:null,pixels:[n],pixelType:d});(e.updateStatistics(),a?.length)?h[function(e,t,i){var r;let a=e.map((e,i)=>({name:e,count:t[i]})).sort((e,t)=>e.name>t.name?-1:1),s=(r=1,e=>r*=e.count),n=[...a.slice(1),{name:"",count:1}].reverse().map(s).reverse(),l=0;for(let r=e.length-1;r>=0;r--)l+=n[a.findIndex(({name:t})=>t===e[r])]*(i%t[r]),i=Math.floor(i/t[r]);return l}(p,c,s)+f]=e:h.push(e)}else{let e=h[s];e.pixels.push(n),o?e.mask&&(e.mask=E.A.combineBandMasks([e.mask,l])):e.mask=o?l:null}}}return{extent:r,pixelBlocks:h,multidimensionalInfo:u,attributeTable:Object.values(o).find(e=>e.attributeTable)?.attributeTable,bandNames:u?void 0:n}}(t)}};(0,r._)([(0,f.MZ)({type:String,json:{write:!0}})],X.prototype,"datasetFormat",void 0),(0,r._)([(0,f.MZ)({constructOnly:!0})],X.prototype,"source",void 0);let Y=X=(0,r._)([(0,d.$)("esri.layers.support.rasterDatasets.CovJSONRaster")],X);var K=i(31461),Q=i(71760),ee=i(48298),et=i(84325);function ei(e,t){if(!e||!t)return null;let i=[];for(let r=0;r<e.length;r++)i.push(e[r]),i.push(t[r]);return i}function er(e){if(!e)return null;let t=Number(e);if(!isNaN(t)&&0!==t)return new D.A({wkid:t});if(e=String(e).trim(),(0,Q.jp)(e))return new D.A({wkt2:e});let i=e.toUpperCase();if(i.startsWith("COMPD_CS")){if(!i.includes("VERTCS")||!i.includes("GEOGCS")&&!i.startsWith("PROJCS"))return null;let r=i.indexOf("VERTCS"),a=i.indexOf("PROJCS"),s=a>-1?a:i.indexOf("GEOGCS");if(-1===s)return null;let n=e.slice(s,e.lastIndexOf("]",r)+1).trim(),l=e.slice(r,e.lastIndexOf("]")).trim();t=ea(n);let o=new D.A(t?{wkid:t}:{wkt:n}),u=ea(l);return u&&(o.vcsWkid=u),o}return i.startsWith("GEOGCS")||i.startsWith("PROJCS")?(t=ea(e),new D.A(0!==t?{wkid:t}:{wkt:e})):null}function ea(e){let t=e.replaceAll("]","[").replaceAll('"',"").split("[").map(e=>e.trim()).filter(e=>""!==e),i=t[t.length-1].split(","),r=i[0]?.toLowerCase();if(("epsg"===r||"esri"===r)&&e.endsWith('"]]')){let e=Number(i[1]);if(!isNaN(e)&&0!==e)return e}return 0}function es(e){if("pamdataset"!==e?.documentElement.tagName?.toLowerCase())return{};let t={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach(e=>{if(1===e.nodeType){if((0,ee.g7)(e,"SRS"))t.spatialReference||(t.spatialReference=er((0,ee.mX)(e)));else if((0,ee.g7)(e,"Metadata"))if("xml:ESRI"===e.getAttribute("domain")){let{spatialReference:i,transform:r}=function(e){let t=(0,ee.V6)(e,"GeodataXform"),i=er((0,ee.v7)(t,"SpatialReference/WKID")||(0,ee.mX)(t,"SpatialReference/WKT"));if("typens:PolynomialXform"!==t.getAttribute("xsi:type"))return{spatialReference:i,transform:null};let r=(0,ee.v7)(t,"PolynomialOrder")??1,a=(0,ee.Ui)(t,"CoeffX/Double"),s=(0,ee.Ui)(t,"CoeffY/Double"),n=(0,ee.Ui)(t,"InverseCoeffX/Double"),l=(0,ee.Ui)(t,"InverseCoeffY/Double"),o=ei(a,s),u=ei(n,l);return{spatialReference:i,transform:o&&u&&o.length&&u.length?new et.A({spatialReference:i,polynomialOrder:r,forwardCoefficients:o,inverseCoefficients:u}):null}}(e);t.transform=r,t.spatialReference||(t.spatialReference=i)}else(0,ee.IC)(e,"MDI").forEach(e=>t.metadata[e.getAttribute("key")]=(0,ee.mX)(e));else if((0,ee.g7)(e,"PAMRasterBand")){let i=function(e){let t,i,r,a,s=(0,ee.v7)(e,"NoDataValue"),n=(0,ee.V6)(e,"Histograms/HistItem"),l=(0,ee.v7)(n,"HistMin"),o=(0,ee.v7)(n,"HistMax"),u=(0,ee.v7)(n,"BucketCount"),h=(0,ee.mX)(n,"HistCounts")?.split("|").map(e=>Number(e));(0,ee.IC)(e,"Metadata/MDI").forEach(e=>{let s=Number(e.textContent??e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":t=s;break;case"STATISTICS_MAXIMUM":i=s;break;case"STATISTICS_MEAN":r=s;break;case"STATISTICS_STDDEV":a=s}});let f=(0,ee.v7)(e,"Metadata/SourceBandIndex");return{noDataValue:s,histogram:h?.length&&null!=l&&null!=o?{min:l,max:o,size:u||h.length,counts:h}:null,sourceBandIndex:f,statistics:null!=t&&null!=i?{min:t,max:i,avg:r,stddev:a}:null}}(e);null!=i.sourceBandIndex&&null==t.rasterBands[i.sourceBandIndex]?t.rasterBands[i.sourceBandIndex]=i:t.rasterBands.push(i)}}});let i=t.rasterBands;return i.length&&(t.statistics=i[0].statistics?i.map(e=>e.statistics).filter(K.Ru):null,t.histograms=i[0].histogram?i.map(e=>e.histogram).filter(K.Ru):null),t}var en=i(10303);let el=class extends F.A{fetchRawTile(e,t,i,r={}){return this._inMemoryRaster.fetchRawTile(e,t,i,r)}async _open(e){let t=await this._fetchData(e),{spatialReference:i,statistics:r,histograms:a,transform:s}=await this._fetchAuxiliaryData(e),n=!i;n&&(i=new D.A({wkid:3857})),a?.length&&null==r&&(r=(0,H.Pg)(a));let{width:l,height:o}=t,u=new k.A({xmin:-.5,ymin:.5-o,xmax:l-.5,ymax:.5,spatialReference:i}),h=s?s.forwardTransform(u):u,f=!0;if(s){let e=s.forwardCoefficients;e&&0===e[1]&&0===e[2]&&(s=null,u=h)}let p=new q({source:{extent:h,nativeExtent:u,transform:s,pixelBlocks:[t],statistics:r,histograms:a,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:n},ioConfig:{sampling:"closest",skipStatistics:!0}});this.ioConfig.skipMapInfo&&(p.ioConfig.skipMapInfo=!0),await p.open(),p.source=null,this._set("rasterInfo",p.rasterInfo),this._inMemoryRaster=p}async _fetchData(e){let{data:t}=await this.request(this.url,{responseType:"array-buffer",signal:e?.signal}),i=(0,en.g)(t).toUpperCase();if("JPG"!==i&&"PNG"!==i&&"GIF"!==i&&"BMP"!==i)throw new n.A("image-aux-raster:open","the data is not a supported format");this._set("datasetFormat",i);let r=i.toLowerCase(),a="gif"===r||"bmp"===r||!(0,c.A)("ios"),s=await this.decodePixelBlock(t,{format:r,useCanvas:a,hasNoZlibMask:!0});if(null==s)throw new n.A("image-aux-raster:open","the data cannot be decoded");return s}async _fetchAuxiliaryData(e){let t=e?.signal,{skipExtensions:i=[],skipMapInfo:r}=this.ioConfig,a=r||i.includes("aux.xml")?null:this.request(this.url+".aux.xml",{responseType:"xml",signal:t}),s=this.datasetFormat,n="JPG"===s?"jgw":"PNG"===s?"pgw":"BMP"===s?"bpw":null,l=n&&i.includes(n)?null:this.request(this.url.slice(0,this.url.lastIndexOf("."))+"."+n,{responseType:"text",signal:t}),o=await (0,u.Lx)([a,l]);if(t?.aborted)throw(0,u.NK)();let h=es(o[0].value?.data);if(!h.transform){let e=o[1].value?o[1].value.data.split("\n").slice(0,6).map(e=>Number(e)):null;h.transform=6===e?.length?new et.A({forwardCoefficients:[e[4],e[5],e[0],-e[1],e[2],-e[3]]}):null}return h}};(0,r._)([(0,f.MZ)({type:String,json:{write:!0}})],el.prototype,"datasetFormat",void 0);let eo=el=(0,r._)([(0,d.$)("esri.layers.support.rasterDatasets.ImageAuxRaster")],el);var eu=i(40941),eh=i(90525),ef=i(39960),ep=i(8946),ec=i(33768),ed=i(74020),em=i(96464),ey=i(71270);let eg=class extends F.A{constructor(){super(...arguments),this._levelOffset=0,this._tilemapCache=null,this._slices=null,this.datasetFormat="RasterTileServer",this.tileType=null}async fetchRawTile(e,t,i,r={}){let{storageInfo:a,extent:s}=this.rasterInfo,{transposeInfo:n}=a,l=null!=n&&!!r.transposedVariableName;if(this._slices&&!l&&null==r.sliceId)return null;let o=l?0:a.maximumPyramidLevel-e+this._levelOffset,u=`${this.url}/tile/${o}/${t}/${i}`,h=this._slices?l?{variable:r.transposedVariableName}:{sliceId:r.sliceId||0}:null,{data:f}=await this.request(u,{query:h,responseType:"array-buffer",signal:r.signal});if(!f)return null;let p=l?n.tileSize:a.tileInfo.size,c=await this.decodePixelBlock(f,{width:p[0],height:p[1],planes:null,pixelType:null,isPoint:"Elevation"===this.tileType,returnInterleaved:l,noDataValue:this.rasterInfo.noDataValue});if(null==c)return null;let d=a.blockBoundary[e];if("jpg"!==a.compression||i>d.minCol&&i<d.maxCol&&t>d.minRow&&t<d.maxRow)return c;let{origin:m,blockWidth:y,blockHeight:g}=a,{x:w,y:x}=this.getPyramidPixelSize(e),v=Math.round((s.xmin-m.x)/w)%y,b=Math.round((s.xmax-m.x)/w)%y||y,I=Math.round((m.y-s.ymax)/x)%g,_=Math.round((m.y-s.ymin)/x)%g||g,A=i===d.minCol?v:0,S=t===d.minRow?I:0,T=i===d.maxCol?b:y,R=t===d.maxRow?_:g;return(0,G.z$)(c,{x:A,y:S},{width:T-A,height:R-S}),c}getSliceIndex(e){if(!this._slices||null==e||0===e.length)return null;for(let t=0;t<this._slices.length;t++){let i=this._slices[t].multidimensionalDefinition;if(i.length===e.length&&!i.some(t=>{let i=e.find(e=>t.variableName===e.variableName&&e.dimensionName===t.dimensionName);return!i||(Array.isArray(t.values[0])?`${t.values[0][0]}-${t.values[0][1]}`:t.values[0])!==(Array.isArray(i.values[0])?`${i.values[0][0]}-${i.values[0][1]}`:i.values[0])}))return t}return null}async fetchVariableStatisticsHistograms(e,t){let i=this.request(this.url+"/statistics",{query:{variable:e,f:"json"},signal:t}).then(e=>e.data?.statistics),r=this.request(this.url+"/histograms",{query:{variable:e,f:"json"},signal:t}).then(e=>e.data?.histograms),a=await Promise.all([i,r]);return a[0]&&a[0].forEach(e=>{e.avg=e.mean,e.stddev=e.standardDeviation}),a[1]?.[0]?.counts?.length||(a[1]=null),{statistics:a[0]||null,histograms:a[1]||null}}async computeBestPyramidLevelForLocation(e,t={}){if(!this._tilemapCache)return 0;let i=this.identifyPixelLocation(e,0,t.datumTransformation);if(null===i)return null;let r=0,{maximumPyramidLevel:a}=this.rasterInfo.storageInfo,s=a-r+this._levelOffset,n=i.srcLocation;for(;s>=0;){try{if("available"===await this._tilemapCache.fetchAvailability(s,i.row,i.col,t))break}catch{}if(s--,r++,null===(i=this.identifyPixelLocation(n,r,t.datumTransformation)))return null}return -1===s||null==i?null:r}async _open(e){let t,i=e?.signal,r=this.sourceJSON?{data:this.sourceJSON}:await this.request(this.url,{query:{f:"json"},signal:i});r.ssl&&(this.url=this.url.replace(/^http:/i,"https:"));let a=r.data;if(this.sourceJSON=a,!a)throw new n.A("imageserverraster:open","cannot initialize tiled image service, missing service info");if(!a.tileInfo)throw new n.A("imageserverraster:open","use ImageryLayer to open non-tiled image services");this._fixScaleInServiceInfo(),this.tileType=a.cacheType,null==this.tileType&&(["jpg","jpeg","png","png8","png24","png32","mixed"].includes(a.tileInfo.format.toLowerCase())?this.tileType="Map":"lerc"===a.tileInfo.format.toLowerCase()?this.tileType="Elevation":this.tileType="Raster"),this.datasetName=a.name?.slice(a.name.indexOf("/")+1)??"";let s=await this._fetchRasterInfo({signal:i});if(null==s)throw new n.A("image-server-raster:open","cannot initialize image service");(0,ey.E9)(s,a);let l="Map"===this.tileType?function(e,t){if(!e)return null;let{minScale:i,maxScale:r,minLOD:a,maxLOD:s}=t;if(null!=a&&null!=s)return ec.A.fromJSON({...e,lods:e.lods.filter(({level:e})=>null!=e&&e>=a&&e<=s)});if(0!==i&&0!==r){let t=e=>Math.round(1e4*e)/1e4,a=i?t(i):1/0,s=r?t(r):-1/0;return ec.A.fromJSON({...e,lods:e.lods.filter(e=>{let i=t(e.scale);return i<=a&&i>=s})})}return ec.A.fromJSON(e)}(a.tileInfo,a):ec.A.fromJSON(a.tileInfo);(0,eu.Lw)(l);let[o,u]=this._computeMinMaxLOD(s,l),{extent:h,pixelSize:f}=s,p=.5/s.width*f.x,c=Math.max(f.x,f.y),{lods:d}=l;("Map"!==this.tileType&&0!==a.maxScale||Math.abs(f.x-f.y)>p||!d.some(e=>Math.abs(e.resolution-c)<p))&&(f.x=f.y=o.resolution,s.width=Math.ceil((h.xmax-h.xmin)/f.x-.1),s.height=Math.ceil((h.ymax-h.ymin)/f.y-.1));let m=o.level-u.level,[y,g]=l.size,w=[],x=[];d.forEach((e,t)=>{e.level>=u.level&&e.level<=o.level&&w.push({x:e.resolution,y:e.resolution}),t<d.length-1&&x.push(Math.round(10*e.resolution/d[t+1].resolution)/10)}),w.sort((e,t)=>e.x-t.x);let v=this.computeBlockBoundary(h,y,g,l.origin,w,m),b=w.length>1?w.slice(1):null;a.transposeInfo&&(t={tileSize:[a.transposeInfo.rows,a.transposeInfo.cols],packetSize:s.keyProperties?._yxs.PacketSize??0});let I=x.length<=1||x.length>=3&&x.slice(0,-1).every(e=>e===x[0])?x[0]??2:Math.round(10/(u.resolution/o.resolution)**(-1/m))/10;if(s.storageInfo=new ep.A({blockWidth:l.size[0],blockHeight:l.size[1],pyramidBlockWidth:l.size[0],pyramidBlockHeight:l.size[1],pyramidResolutions:b,pyramidScalingFactor:I,compression:l.format,origin:l.origin,firstPyramidLevel:1,maximumPyramidLevel:m,tileInfo:l,transposeInfo:t,blockBoundary:v}),function(e){let{extent:t,spatialReference:i}=e;t.xmin>-1&&t.xmax>181&&i?.wkid&&i.isGeographic&&(e.nativeExtent=e.extent,e.transform=new em.A,e.extent=e.transform.forwardTransform(t))}(s),this._set("rasterInfo",s),a.capabilities.toLowerCase().includes("tilemap")){let e={tileInfo:s.storageInfo.tileInfo,parsedUrl:(0,eh.An)(this.url),url:this.url,tileServers:[]};this._tilemapCache=new ed.d({layer:e})}}async _fetchRasterInfo(e){let t=this.sourceJSON;if("Map"===this.tileType){let e=t.fullExtent||t.extent,i=Math.ceil((e.xmax-e.xmin)/t.pixelSizeX-.1),r=Math.ceil((e.ymax-e.ymin)/t.pixelSizeY-.1),a=D.A.fromJSON(t.spatialReference||e.spatialReference),s=new ef.A({x:t.pixelSizeX,y:t.pixelSizeY,spatialReference:a});return new U.A({width:i,height:r,bandCount:3,extent:k.A.fromJSON(e),spatialReference:a,pixelSize:s,pixelType:"u8",statistics:null,keyProperties:{DataType:"processed"}})}let{signal:i}=e,r=(0,ey.Tw)(this.url,this.sourceJSON,{signal:i,query:this.ioConfig.customFetchParameters}),a=t.hasMultidimensions?this.request(`${this.url}/slices`,{query:{f:"json"},signal:i}).then(e=>e.data?.slices).catch(()=>null):null,s=await Promise.all([r,a]);return this._slices=s[1],s[0]}_fixScaleInServiceInfo(){let{sourceJSON:e}=this;e.minScale&&e.minScale<0&&(e.minScale=0),e.maxScale&&e.maxScale<0&&(e.maxScale=0)}_computeMinMaxLOD(e,t){let{pixelSize:i}=e,r=.5/e.width*i.x,{lods:a}=t,s=t.lodAt(Math.max.apply(null,a.map(e=>e.level))),n=t.lodAt(Math.min.apply(null,a.map(e=>e.level))),{tileType:l}=this;if("Map"===l)return this._levelOffset=a[0].level,[s,n];if("Raster"===l)return[a.find(e=>e.resolution===i.x)??s,n];let{minScale:o,maxScale:u}=this.sourceJSON,h=s;u>0&&((h=a.find(e=>Math.abs(e.scale-u)<r))||(h=a.filter(e=>e.scale>u).sort((e,t)=>e.scale>t.scale?1:-1)[0]??s));let f=n;return o>0&&(f=a.find(e=>Math.abs(e.scale-o)<r)??n,this._levelOffset=f.level-n.level),[h,f]}};(0,r._)([(0,f.MZ)({type:String,json:{write:!0}})],eg.prototype,"datasetFormat",void 0),(0,r._)([(0,f.MZ)()],eg.prototype,"tileType",void 0);let ew=eg=(0,r._)([(0,d.$)("esri.layers.support.rasterDatasets.ImageServerRaster")],eg);var ex=i(15225);let ev=new Map;ev.set("Int8","s8"),ev.set("UInt8","u8"),ev.set("Int16","s16"),ev.set("UInt16","u16"),ev.set("Int32","s32"),ev.set("UInt32","u32"),ev.set("Float32","f32"),ev.set("Float64","f32"),ev.set("Double64","f32");let eb=new Map;eb.set("none",{blobExtension:".til",isOneSegment:!0,decoderFormat:"bip"}),eb.set("lerc",{blobExtension:".lrc",isOneSegment:!1,decoderFormat:"lerc"}),eb.set("deflate",{blobExtension:".pzp",isOneSegment:!0,decoderFormat:"deflate"}),eb.set("jpeg",{blobExtension:".pjg",isOneSegment:!0,decoderFormat:"jpg"});let eI=class extends F.A{constructor(){super(...arguments),this._files=null,this._storageIndex=null,this.datasetFormat="MRF"}async fetchRawTile(e,t,i,r={}){let{blockWidth:a,blockHeight:s,blockBoundary:n}=this.rasterInfo.storageInfo,l=n[e];if(!l||l.maxRow<t||l.maxCol<i||l.minRow>t||l.minCol>i)return null;let{bandCount:o,pixelType:u}=this.rasterInfo,{ranges:h,actualTileWidth:f,actualTileHeight:p}=this._getTileLocation(e,t,i);if(!h||0===h.length)return null;if(0===h[0].from&&0===h[0].to){let e=new Uint8Array(a*s);return new E.A({width:a,height:s,pixels:void 0,mask:e,validPixelCount:0})}let{bandIds:c}=this.ioConfig,d=this._getBandSegmentCount(),m=[],y=0;for(y=0;y<d;y++)c&&!c.includes(y)||m.push(this.request(this._files.data,{range:{from:h[y].from,to:h[y].to},responseType:"array-buffer",signal:r.signal}));let g=await Promise.all(m),w=new Uint8Array(g.map(e=>e.data.byteLength).reduce((e,t)=>e+t)),x=[],v=0;for(y=0;y<d;y++)x.push(v),w.set(new Uint8Array(g[y].data),v),v+=g[y].data.byteLength;let b=eb.get(this.rasterInfo.storageInfo.compression).decoderFormat,I=await this.decodePixelBlock(w.buffer,{width:a,height:s,format:b,planes:c?.length||o,offsets:x,pixelType:u});if(null==I)return null;let{noDataValue:_}=this.rasterInfo;if(null!=_&&"lerc"!==b&&!I.mask&&null!=(_=_[0])){let e=I.width*I.height,t=new Uint8Array(e);if(Math.abs(_)>1e24)for(y=0;y<e;y++)Math.abs((I.pixels[0][y]-_)/_)>1e-6&&(t[y]=1);else for(y=0;y<e;y++)I.pixels[0][y]!==_&&(t[y]=1);I.mask=t}let A=0,S=0;if(f!==a||p!==s){let e=I.mask;if(e)for(y=0;y<s;y++)if(S=y*a,y<p)for(A=f;A<a;A++)e[S+A]=0;else for(A=0;A<a;A++)e[S+A]=0;else for(I.mask=e=new Uint8Array(a*s),y=0;y<p;y++)for(S=y*a,A=0;A<f;A++)e[S+A]=1}return I}async _open(e){this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);let t=e?e.signal:null,i=await this.request(this.url,{responseType:"xml",signal:t}),{rasterInfo:r,files:a}=this._parseHeader(i.data),{skipMapInfo:s,skipExtensions:n=[]}=this.ioConfig;if(!n.includes("aux.xml")&&!s){let t=await this._fetchAuxiliaryData(e);null!=t&&(r.statistics=t.statistics??r.statistics,r.histograms=t.histograms,t.histograms&&null==r.statistics&&(r.statistics=(0,H.Pg)(t.histograms)))}s&&this.updateImageSpaceRasterInfo(r),this._set("rasterInfo",r),this._files=a;let l=await this.request(a.index,{responseType:"array-buffer",signal:t});this._storageIndex=function(e){let t,i,r,a,s,n;if(e.byteLength%16>0)throw Error("invalid array buffer must be multiples of 16");if(ex.Z){for(i=new Uint8Array(e),r=new Uint8Array(a=new ArrayBuffer(e.byteLength)),s=0;s<e.byteLength/4;s++)for(n=0;n<4;n++)r[4*s+n]=i[4*s+3-n];t=new Uint32Array(a)}else t=new Uint32Array(e);return t}(l.data);let{blockWidth:o,blockHeight:u}=this.rasterInfo.storageInfo,h=this.rasterInfo.storageInfo.pyramidScalingFactor,{width:f,height:p}=this.rasterInfo,c=[],d=this._getBandSegmentCount(),m=0,y=-1;for(;m<this._storageIndex.length;){y++;let e=Math.ceil(f/o/h**y)-1,t=Math.ceil(p/u/h**y)-1;m+=(e+1)*(t+1)*d*4,c.push({maxRow:t,maxCol:e,minCol:0,minRow:0})}this.rasterInfo.storageInfo.blockBoundary=c,y>0&&(this.rasterInfo.storageInfo.firstPyramidLevel=1,this.rasterInfo.storageInfo.maximumPyramidLevel=y),this.updateTileInfo()}_getBandSegmentCount(){return eb.get(this.rasterInfo.storageInfo.compression).isOneSegment?1:this.rasterInfo.bandCount}_getTileLocation(e,t,i){let{blockWidth:r,blockHeight:a,pyramidScalingFactor:s}=this.rasterInfo.storageInfo,{width:n,height:l}=this.rasterInfo,o=this._getBandSegmentCount(),u,h,f,p=0,c=0;for(f=0;f<e;f++)p+=(u=Math.ceil(n/r/(c=s**f)))*(h=Math.ceil(l/a/c));u=Math.ceil(n/r/(c=s**e)),h=Math.ceil(l/a/c),p+=t*u+i,p*=4*o;let d=this._storageIndex.subarray(p,p+4*o),m=0,y=0,g=[];for(let e=0;e<o;e++)y=(m=0x100000000*d[4*e]+d[4*e+1])+0x100000000*d[4*e+2]+d[4*e+3],g.push({from:m,to:y});return{ranges:g,actualTileWidth:i<u-1?r:Math.ceil(n/c)-r*(u-1),actualTileHeight:t<h-1?a:Math.ceil(l/c)-a*(h-1)}}_parseHeader(e){let t,i,r=(0,ee.V6)(e,"MRF_META/Raster");if(!r)throw new n.A("mrf:open","not a valid MRF format");let a=(0,ee.V6)(r,"Size"),s=parseInt(a.getAttribute("x"),10),l=parseInt(a.getAttribute("y"),10),o=parseInt(a.getAttribute("c"),10),u=((0,ee.mX)(r,"Compression")||"none").toLowerCase();if(!eb.has(u))throw new n.A("mrf:open","currently does not support compression "+u);let h=(0,ee.mX)(r,"DataType")||"UInt8",f=ev.get(h);if(null==f)throw new n.A("mrf:open","currently does not support pixel type "+h);let p=(0,ee.V6)(r,"PageSize"),c=parseInt(p.getAttribute("x"),10),d=parseInt(p.getAttribute("y"),10),m=(0,ee.V6)(r,"DataValues");if(m&&null!=(i=m.getAttribute("NoData"))&&(t=i.trim().split(" ").map(e=>parseFloat(e))),(0,ee.V6)(e,"MRF_META/CachedSource"))throw new n.A("mrf:open","currently does not support MRF referencing other data files");let y=(0,ee.V6)(e,"MRF_META/GeoTags"),g=(0,ee.V6)(y,"BoundingBox"),w,x=!1;if(null!=g){let e=parseFloat(g.getAttribute("minx")),t=parseFloat(g.getAttribute("miny")),i=parseFloat(g.getAttribute("maxx")),r=parseFloat(g.getAttribute("maxy")),a=(0,ee.mX)(y,"Projection")||"",s=D.A.WGS84;if("LOCAL_CS[]"!==a)if(a.toLowerCase().startsWith("epsg:")){let e=Number(a.slice(5));isNaN(e)||0===e||(s=new D.A({wkid:e}))}else s=er(a)??D.A.WGS84;else x=!0,s=new D.A({wkid:3857});(w=new k.A(e,t,i,r)).spatialReference=s}else x=!0,w=new k.A({xmin:-.5,ymin:.5-l,xmax:s-.5,ymax:.5,spatialReference:new D.A({wkid:3857})});let v=(0,ee.V6)(e,"MRF_META/Rsets"),b=parseInt(v?.getAttribute("scale")||"2",10),I=w.spatialReference,_=new ep.A({origin:new ef.A({x:w.xmin,y:w.ymax,spatialReference:I}),blockWidth:c,blockHeight:d,pyramidBlockWidth:c,pyramidBlockHeight:d,compression:u,pyramidScalingFactor:b}),A=new ef.A({x:w.width/s,y:w.height/l,spatialReference:I}),S=new U.A({width:s,height:l,extent:w,isPseudoSpatialReference:x,spatialReference:I,bandCount:o,pixelType:f,pixelSize:A,noDataValue:t,storageInfo:_}),T=(0,ee.mX)(e,"datafile"),R=(0,ee.mX)(e,"IndexFile");return{rasterInfo:S,files:{mrf:this.url,index:R||this.url.replace(".mrf",".idx"),data:T||this.url.replace(".mrf",eb.get(u).blobExtension)}}}async _fetchAuxiliaryData(e){try{let{data:t}=await this.request(this.url+".aux.xml",{responseType:"xml",signal:e?.signal});return es(t)}catch{return null}}};(0,r._)([(0,f.MZ)()],eI.prototype,"_files",void 0),(0,r._)([(0,f.MZ)()],eI.prototype,"_storageIndex",void 0),(0,r._)([(0,f.MZ)({type:String,json:{write:!0}})],eI.prototype,"datasetFormat",void 0);let e_=eI=(0,r._)([(0,d.$)("esri.layers.support.rasterDatasets.MRFRaster")],eI);var eA=i(46052);class eS{static get supportedVersions(){return[5]}static parse(e){let t,i=new DataView(e),r=3&i.getUint8(0);if(3!==r)return{header:{version:r},recordSet:null};let a=i.getUint32(4,!0),s=i.getUint16(8,!0),n=i.getUint16(10,!0),l=32,o=[],u=[];if(3===r){for(;13!==i.getUint8(l);)t=String.fromCharCode(i.getUint8(l+11)).trim(),o.push({name:(0,eA.w)(new Uint8Array(e,l,11)),type:t,typeName:["String","Date","Double","Boolean","String","Integer"][["C","D","F","L","M","N"].indexOf(t)],length:i.getUint8(l+16)}),l+=32;if(l+=1,o.length>0)for(;u.length<a&&e.byteLength-l>n;){let t=[];32===i.getUint8(l)?(l+=1,o.forEach(i=>{if("C"===i.type)t.push((0,eA.w)(new Uint8Array(e,l,i.length)).trim());else if("N"===i.type)t.push(parseInt(String.fromCharCode.apply(null,new Uint8Array(e,l,i.length)).trim(),10));else if("F"===i.type)t.push(parseFloat(String.fromCharCode.apply(null,new Uint8Array(e,l,i.length)).trim()));else if("D"===i.type){let r=String.fromCharCode.apply(null,new Uint8Array(e,l,i.length)).trim();t.push(new Date(parseInt(r.slice(0,4),10),parseInt(r.slice(4,6),10)-1,parseInt(r.slice(6,8),10)))}l+=i.length}),u.push(t)):l+=n}}return{header:{version:r,recordCount:a,headerByteCount:s,recordByteCount:n},fields:o,records:u,recordSet:function(e){let t=e.fields,i=e.records,r=t.some(e=>"oid"===e.name.toLowerCase())?"OBJECTID":"OID",a=[{name:r,type:"esriFieldTypeOID",alias:"OID"}].concat(t.map(e=>({name:e.name,type:"esriFieldType"+e.typeName,alias:e.name}))),s=a.map(e=>e.name),n=[],l=0,o=0;return i.forEach(e=>{let t={};for(t[r]=l++,o=1;o<s.length;o++)t[s[o]]=e[o-1];n.push({attributes:t})}),{displayFieldName:"",fields:a,features:n}}({fields:o,records:u})}}}var eT=i(85381),eR=i(15982);let eM=(e,t)=>e.get(t)?.values,eC=(e,t)=>e.get(t)?.values?.[0],eO=class extends F.A{constructor(){super(...arguments),this._files=null,this._headerInfo=null,this._bufferSize=1048576,this.datasetFormat="TIFF"}async fetchRawTile(e,t,i,r={}){if(!this._headerInfo?.isSupported||this.isBlockOutside(e,t,i))return null;let a=await this._fetchRawTiffTile(e,t,i,!1,r);if(null!=a&&this._headerInfo.hasMaskBand){let s=await this._fetchRawTiffTile(e,t,i,!0,r);null!=s&&s.pixels[0]instanceof Uint8Array&&(a.mask=s.pixels[0])}return a}async _open(e){let t=e?e.signal:null,{data:i}=await this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",signal:t});if(!i)throw new n.A("tiffraster:open","failed to open url "+this.url);this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1,this.url.lastIndexOf("."));let{littleEndian:r,firstIFDPos:a,isBigTiff:s}=(0,eT.uT)(i),o=[];await this._readIFDs(o,i,r,a,0,s?8:4,t);let{imageInfo:u,rasterInfo:h}=function(e){let t=(0,eT.uc)(e),{width:i,height:r,tileWidth:a,tileHeight:s,planes:n,pixelType:l,compression:o,firstPyramidLevel:u,maximumPyramidLevel:h,pyramidBlockWidth:f,pyramidBlockHeight:p,pyramidResolutions:c,tileBoundary:d,affine:m,metadata:y}=t,g=er(t.extent.spatialReference?.wkt||t.extent.spatialReference?.wkid),w=!!t.isPseudoGeographic;null==g&&(w=!0,g=new D.A({wkid:3857}));let x=new k.A({...t.extent,spatialReference:g}),v=new ef.A(x?{x:x.xmin,y:x.ymax,spatialReference:g}:{x:0,y:0}),b=new ep.A({blockWidth:a,blockHeight:s,pyramidBlockWidth:f,pyramidBlockHeight:p,compression:o,origin:v,firstPyramidLevel:u,maximumPyramidLevel:h,pyramidResolutions:c,blockBoundary:d}),I=new ef.A({x:(x.xmax-x.xmin)/i,y:(x.ymax-x.ymin)/r,spatialReference:g}),_=y?{BandProperties:y.bandProperties,DataType:y.dataType}:{},A=null,S=eC(e[0],"PHOTOMETRICINTERPRETATION"),T=eM(e[0],"COLORMAP");if(S<=3&&T?.length>3&&T.length%3==0){A=[];let e=T.length/3;for(let t=0;t<e;t++)A.push([t,T[t]>>>8,T[t+e]>>>8,T[t+2*e]>>>8])}let R=new U.A({width:i,height:r,bandCount:n,pixelType:l,pixelSize:I,storageInfo:b,spatialReference:g,isPseudoSpatialReference:w,keyProperties:_,extent:x,colormap:A,statistics:y?y.statistics:null});if(m?.length&&(R.nativeExtent=new k.A({xmin:-.5,ymin:.5-r,xmax:i-.5,ymax:.5,spatialReference:g}),R.transform=new et.A({polynomialOrder:1,forwardCoefficients:[m[2]+m[0]/2,m[5]-m[3]/2,m[0],m[3],-m[1],-m[4]]}),R.extent=R.transform.forwardTransform(R.nativeExtent),R.pixelSize=new ef.A({x:(x.xmax-x.xmin)/i,y:(x.ymax-x.ymin)/r,spatialReference:g}),b.origin.x=-.5,b.origin.y=.5),c){let{x:e,y:t}=R.pixelSize;c.forEach(i=>{i.x*=e,i.y*=t})}return{imageInfo:t,rasterInfo:R}}(o),f=(0,eT.zS)(o),p=(0,eT.r9)(o);if(this._headerInfo={littleEndian:r,isBigTiff:s,ifds:o,pyramidIFDs:f,maskIFDs:p,...u},this._set("rasterInfo",h),!u.isSupported)throw new n.A("tiffraster:open","this tiff is not supported: "+u.message);if(!u.tileWidth)throw new n.A("tiffraster:open","none-tiled tiff is not optimized for access, convert to COG and retry.");h.isPseudoSpatialReference&&l.A.getLogger(this).warn("The spatial reference for this tiff is unsupported. Only EPSG spatial reference codes and Esri WKTs are supported.");let c=o[0].get("PREDICTOR")?.values?.[0];if(3===o[0].get("SAMPLEFORMAT")?.values?.[0]&&2===c)throw new n.A("tiffraster:open","unsupported horizontal difference encoding. Predictor=3 is supported for floating point data");let{skipMapInfo:d,skipExtensions:m=[]}=this.ioConfig;if(!m.includes("aux.xml")&&!d){let t=await this._fetchAuxiliaryMetaData(e);null!=t&&function(e,t){if(t.statistics=e.statistics??t.statistics,t.histograms=e.histograms,e.histograms&&null==t.statistics&&(t.statistics=(0,H.Pg)(e.histograms)),e.transform&&null==t.transform){t.transform=e.transform,t.nativeExtent=t.extent;let i=t.transform.forwardTransform(t.nativeExtent);t.pixelSize=new ef.A({x:(i.xmax-i.xmin)/t.width,y:(i.ymax-i.ymin)/t.height,spatialReference:t.spatialReference}),t.extent=i}t.isPseudoSpatialReference&&e.spatialReference&&(t.spatialReference=e.spatialReference,t.extent.spatialReference=t.nativeExtent.spatialReference=t.storageInfo.origin.spatialReference=t.spatialReference)}(t,h)}m.includes("vat.dbf")||1!==h.bandCount||"u8"!==h.pixelType||d||(h.attributeTable=await this._fetchAuxiliaryTable(e),null!=h.attributeTable&&(h.keyProperties.DataType="thematic")),d&&this.updateImageSpaceRasterInfo(h),this.updateTileInfo()}async _readIFDs(e,t,i,r,a,s=4,n){if(!r)return null;(r>=t.byteLength||r<0)&&(t=(await this.request(this.url,{range:{from:r+a,to:r+a+this._bufferSize},responseType:"array-buffer",signal:n})).data,a=r+a,r=0);let l=await this._readIFD(t,i,r,a,eR.A.tiffTags,s,n);if(e.push(l.ifd),!l.nextIFD)return null;await this._readIFDs(e,t,i,l.nextIFD-a,a,s,n)}async _readIFD(e,t,i,r,a=eR.A.tiffTags,s=4,n){if(!e)return null;let l=(0,eT.JM)(e,t,i,r,a,s);if(l.success){let i=[];if(l.ifd?.forEach(e=>{e.values||i.push(e)}),i.length>0){let a=i.map(e=>e.offlineOffsetSize).filter(K.Ru),s=Math.min.apply(null,a.map(e=>e[0]));if(Math.min.apply(null,a.map(e=>e[0]+e[1]))-s<=this._bufferSize){let{data:a}=await this.request(this.url,{range:{from:s,to:s+this._bufferSize},responseType:"array-buffer",signal:n});e=a,r=s,i.forEach(i=>(0,eT.Cr)(e,t,i,r))}}if(l.ifd?.has("GEOKEYDIRECTORY")){let i=l.ifd.get("GEOKEYDIRECTORY"),a=i?.values;if(a&&a.length>4){let s=a[0]+"."+a[1]+"."+a[2],l=await this._readIFD(e,t,i.valueOffset+6-r,r,eR.A.geoKeys,2,n);i.data=l.ifd,i.data&&i.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[s]})}}return l}if(l.requiredBufferSize&&l.requiredBufferSize!==e.byteLength)return(e=(await this.request(this.url,{range:{from:r,to:r+l.requiredBufferSize+4},responseType:"array-buffer",signal:n})).data).byteLength<l.requiredBufferSize?null:this._readIFD(e,t,0,r,eR.A.tiffTags,4,n)}async _fetchRawTiffTile(e,t,i,r,a={}){let s,n,l,o=this._getTileLocation(e,t,i,r);if(!o)return null;let{ranges:u,actualTileWidth:h,actualTileHeight:f,ifd:p}=o,c=u.map(e=>this.request(this.url,{range:e,responseType:"array-buffer",signal:a.signal})),d=await Promise.all(c),m=d.map(e=>e.data.byteLength).reduce((e,t)=>e+t),y=1===d.length?d[0].data:new ArrayBuffer(m),g=[0],w=[0];if(d.length>1){let e=new Uint8Array(y);for(let t=0,i=0;t<d.length;t++){let r=d[t].data;e.set(new Uint8Array(r),i),g[t]=i,i+=r.byteLength,w[t]=r.byteLength}}let{blockWidth:x,blockHeight:v}=this.getBlockWidthHeight(e),b=await this.decodePixelBlock(y,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:p,offsets:g,sizes:w},width:x,height:v,planes:null,pixelType:null});if(null==b)return null;if(h!==x||f!==v){let e=b.mask;if(e)for(s=0;s<v;s++)if(l=s*x,s<f)for(n=h;n<x;n++)e[l+n]=0;else for(n=0;n<x;n++)e[l+n]=0;else for(b.mask=e=new Uint8Array(x*v),s=0;s<f;s++)for(l=s*x,n=0;n<h;n++)e[l+n]=1}return b}_getTileLocation(e,t,i,r=!1){let{firstPyramidLevel:a,blockBoundary:s}=this.rasterInfo.storageInfo,n=0===e?0:e-(a-1),{_headerInfo:l}=this;if(!l)return null;let o=r?l.maskIFDs[n]:0===n?l?.ifds[0]:l?.pyramidIFDs[n-1];if(!o)return null;let u=(0,eT.XO)(o,l),h=eM(o,"TILEOFFSETS");if(void 0===h)return null;let f=eM(o,"TILEBYTECOUNTS"),{minRow:p,minCol:c,maxRow:d,maxCol:m}=s[n];if(t>d||i>m||t<p||i<c)return null;let y=eC(o,"IMAGEWIDTH"),g=eC(o,"IMAGELENGTH"),w=eC(o,"TILEWIDTH"),x=eC(o,"TILELENGTH"),v=[];if(u){let{bandCount:e}=this.rasterInfo;for(let r=0;r<e;r++){let e=r*(d+1)*(m+1)+t*(m+1)+i;v[r]={from:h[e],to:h[e]+f[e]-1}}}else{let e=t*(m+1)+i;v.push({from:h[e],to:h[e]+f[e]-1})}for(let e=0;e<v.length;e++)if(null==v[e].from||!v[e].to||v[e].to<0)return null;return{ranges:v,ifd:o,actualTileWidth:i===m&&y%w||w,actualTileHeight:t===d&&g%x||x}}async _fetchAuxiliaryMetaData(e){try{let{data:t}=await this.request(this.url+".aux.xml",{responseType:"xml",signal:e?.signal});return es(t)}catch{return null}}async _fetchAuxiliaryTable(e){try{let{data:t}=await this.request(this.url+".vat.dbf",{responseType:"array-buffer",signal:e?.signal}),i=eS.parse(t);return i?.recordSet?W.A.fromJSON(i.recordSet):null}catch{return null}}};(0,r._)([(0,f.MZ)()],eO.prototype,"_files",void 0),(0,r._)([(0,f.MZ)()],eO.prototype,"_headerInfo",void 0),(0,r._)([(0,f.MZ)()],eO.prototype,"_bufferSize",void 0),(0,r._)([(0,f.MZ)({type:String,json:{write:!0}})],eO.prototype,"datasetFormat",void 0);let eF=eO=(0,r._)([(0,d.$)("esri.layers.support.rasterDatasets.TIFFRaster")],eO),eP=new Map;eP.set("MRF",{desc:"Meta Raster Format",constructor:e_}),eP.set("TIFF",{desc:"GeoTIFF",constructor:eF}),eP.set("RasterTileServer",{desc:"Raster Tile Server",constructor:ew}),eP.set("JPG",{desc:"JPG Raster Format",constructor:eo}),eP.set("PNG",{desc:"PNG Raster Format",constructor:eo}),eP.set("GIF",{desc:"GIF Raster Format",constructor:eo}),eP.set("BMP",{desc:"BMP Raster Format",constructor:eo}),eP.set("CovJSON",{desc:"COVJSON Raster Format",constructor:Y}),eP.set("MEMORY",{desc:"In Memory Raster Format",constructor:q});class ek{static get supportedFormats(){let e=new Set;return eP.forEach((t,i)=>e.add(i)),e}static async open(e){let{url:t,ioConfig:i,source:r,sourceJSON:a}=e,s=e.datasetFormat??i?.datasetFormat;null==s&&(t.includes(".")?s=t.slice(t.lastIndexOf(".")+1).toUpperCase():"coverage"===r?.type?.toLowerCase()?s="CovJSON":r?.extent&&r.pixelblocks&&(s="MEMORY")),"OVR"===s||"TIF"===s?s="TIFF":"JPG"===s||"JPEG"===s||"JFIF"===s?s="JPG":"COVJSON"===s&&(s="CovJSON"),t.toLowerCase().includes("/imageserver")&&!t.toLowerCase().includes("/wcsserver")&&(s="RasterTileServer");let l={url:t,source:r,sourceJSON:a,datasetFormat:s,ioConfig:i??{bandIds:null,sampling:null}};if(Object.keys(l).forEach(e=>{null==l[e]&&delete l[e]}),s){if(!this.supportedFormats.has(s))throw new n.A("rasterfactory:open","not a supported format "+s);if("CRF"===s)throw new n.A("rasterfactory:open",`cannot open raster: ${t}`);let i=new(0,eP.get(s).constructor)(l);return await i.open({signal:e.signal}),i}let o=Array.from(eP.keys()).filter(e=>"CovJSON"!==e&&"Memory"!==e),u=0,h=()=>{if(!(s=o[u++])||"CRF"===s)return null;let t=new(0,eP.get(s).constructor)(l);return t.open({signal:e.signal}).then(()=>t).catch(()=>h())};return h()}static register(e,t,i){eP.has(e.toUpperCase())||eP.set(e.toUpperCase(),{desc:t,constructor:i})}}var eD=i(18801),eN=i(52438),eE=i(84090);let eL=class extends(0,g.dM)((0,A.j)((0,v.q)((0,b.A)((0,I.H)((0,w.d)((0,x.o)((0,S.e)((0,y.b)((0,_.J)((0,o.P)(s.A.ClonableMixin(m.A)))))))))))){constructor(...e){super(...e),this._primaryRasters=[],this.legendEnabled=!0,this.isReference=null,this.listMode="show",this.sourceJSON=null,this.version=null,this.type="imagery-tile",this.operationalLayerType="ArcGISTiledImageServiceLayer",this.popupEnabled=!0,this.popupTemplate=null,this.fields=null,this.source=void 0,this._debouncedSaveOperations=(0,u.sg)(async(e,t,r)=>{let{save:a,saveAs:s}=await i.e(4611).then(i.bind(i,64611));switch(e){case eE.X.SAVE:return a(this,t);case eE.X.SAVE_AS:return s(this,r,t)}})}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}load(e){let t=null!=e?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"]},e).catch(u.QP).then(()=>this._openRaster(t))),Promise.resolve(this)}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){let e=[(0,M.rZ)("Pixel Value"),(0,M.dy)("Raw Pixel Value")],t=this.raster?.rasterInfo??this.serviceRasterInfo,i=t?.attributeTable;if(i){let t=(0,M.jC)(i);e.push(...t)}let r=t?.dataType,a=t?.multidimensionalInfo;if(("vector-magdir"===r||"vector-uv"===r)&&null!=a){let t=a.variables[0].unit?.trim(),i=(0,M.DV)(t),r=(0,M.y6)();e.push(i,r)}if(a){let t=(0,M.AL)(a);e.push(...t)}return e}createPopupTemplate(e){let{rasterFields:t}=this,i=e?.visibleFieldNames??new Set(t.map(({name:e})=>e).filter(e=>e!==M.F_.rawServicePixelValue)),r=(0,eN.tn)({fields:t,title:this.title},{...e,visibleFieldNames:i}),{rasterInfo:a}=this.raster;return r?.fieldInfos&&a&&(0,M.h4)(r.fieldInfos,a),r}async generateRasterInfo(e,t){if(e=(0,p.PZ)(C.A,e),await this.load(),!e||"none"===e.functionName?.toLowerCase())return this.serviceRasterInfo;try{let{rasterInfo:i}=await this._openFunctionRaster(e,t);return i}catch(e){if(e instanceof n.A)throw e;throw new n.A("imagery-tile-layer","the given raster function is not supported")}}async save(e){return this._debouncedSaveOperations(eE.X.SAVE,e)}async saveAs(e,t){return this._debouncedSaveOperations(eE.X.SAVE_AS,t,e)}write(e,t){let i=this._primaryRasters[0]??this.raster;if(this.loaded?"RasterTileServer"===i.datasetFormat&&("Raster"===i.tileType||"Map"===i.tileType):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))return super.write(e,t);if(t?.messages){let e=`${t.origin}/${t.layerContainerType||"operational-layers"}`;t.messages.push(new n.A("layer:unsupported",`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${e}'`,{layer:this}))}return null}async _openRaster(e){let t=!1;if(this.raster)await this._openFromRaster(this.raster,e),(t="Function"===this.raster.datasetFormat)||!this.rasterFunction||(this._primaryRasters=[this.raster],await this._initializeWithFunctionRaster(this.rasterFunction));else{let{url:t,rasterFunction:i,source:r}=this;if(!t&&!r)throw new n.A("imagery-tile-layer:open","missing url or source parameter");r?await this._openFromSource(r,e):i?await this._openFromUrlWithRasterFunction(t,i,e):await this._openFromUrl(t,e)}let i=this.raster.rasterInfo;if(!i)throw new n.A("imagery-tile-layer:load","cannot load resources on "+this.url);if(this._set("serviceRasterInfo",t?i:this._primaryRasters[0].rasterInfo),this._set("spatialReference",i.spatialReference),this.sourceJSON=this.sourceJSON||this.raster.sourceJSON,null!=this.sourceJSON){let e="Map"===this.raster.tileType&&null!=this.sourceJSON.minLOD&&null!=this.sourceJSON.maxLOD?this.sourceJSON:{...this.sourceJSON,minScale:0,maxScale:0};this.read(e,{origin:"service"})}else this.read({tileInfo:this.serviceRasterInfo?.storageInfo.tileInfo.toJSON()},{origin:"service"});this.title||(this.title=this.raster.datasetName),"Map"===this.raster.tileType&&(this.popupEnabled=!1),this._configDefaultSettings(),this.addHandles((0,h.wB)(()=>this.customParameters,e=>{this.raster&&(this.raster.ioConfig.customFetchParameters=e)}))}async _openFromRaster(e,t){e.rasterInfo||await e.open({signal:t}),this._primaryRasters="Function"===e.datasetFormat?e.primaryRasters.rasters:[e],this.url||(this.url=this._primaryRasters[0].url)}async _openFromUrlWithRasterFunction(e,t,i){let r=[e];t&&(0,eD.UD)(t.toJSON(),r);let a=await Promise.all(r.map(e=>ek.open({url:e,sourceJSON:this.sourceJSON,ioConfig:{sampling:"closest",...this.ioConfig,customFetchParameters:this.customParameters},signal:i}))),s=a.findIndex(e=>null==e);if(s>-1)throw new n.A("imagery-tile-layer:open",`cannot open raster: ${r[s]}`);return this._primaryRasters=a,this._initializeWithFunctionRaster(t)}async _openFromUrl(e,t){let i=await ek.open({url:e,sourceJSON:this.sourceJSON,ioConfig:{sampling:"closest",...this.ioConfig,customFetchParameters:this.customParameters},signal:t});if(null==i)throw new n.A("imagery-tile-layer:open",`cannot open raster: ${e}`);this._primaryRasters=[i],this.raster=i}async _openFromSource(e,t){let i="the tiled imagery data source is not supported",r="coverage"===e.type?.toLowerCase()?"CovJSON":e.extent&&e.pixelBlock?"MEMORY":null;if(!r)throw new n.A("imagery-tile-layer:open",i);"MEMORY"===r&&(e={...e,pixelBlock:void 0,pixelBlocks:[e.pixelBlock]});let a=await ek.open({url:"",source:e,datasetFormat:r,ioConfig:{sampling:"closest",...this.ioConfig,customFetchParameters:this.customParameters},signal:t});if(null==a)throw new n.A("imagery-tile-layer:open",i);this._primaryRasters=[a],this.rasterFunction?await this._initializeWithFunctionRaster(this.rasterFunction):this.raster=a}async _openFunctionRaster(e,t){let i={raster:this._primaryRasters[0]};this._primaryRasters.length>1&&this._primaryRasters.forEach(e=>i[e.url]=e);let r=(0,eD.vt)(e.functionDefinition?.toJSON()??e.toJSON(),i),a=new O.A({rasterFunction:r});return await a.open(t),a}async _initializeWithFunctionRaster(e,t){try{this.raster=await this._openFunctionRaster(e,t)}catch(e){e instanceof n.A&&l.A.getLogger(this).error("imagery-tile-layer:open",e.message),l.A.getLogger(this).warn("imagery-tile-layer:open","the raster function cannot be applied and is removed"),this._set("rasterFunction",null),this.raster=this._primaryRasters[0]}}};(0,r._)([(0,f.MZ)({clonable:!1})],eL.prototype,"_primaryRasters",void 0),(0,r._)([(0,f.MZ)(T.fV)],eL.prototype,"legendEnabled",void 0),(0,r._)([(0,f.MZ)({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],eL.prototype,"isReference",void 0),(0,r._)([(0,f.MZ)({type:["show","hide"]})],eL.prototype,"listMode",void 0),(0,r._)([(0,f.MZ)({json:{read:!0,write:!0}})],eL.prototype,"blendMode",void 0),(0,r._)([(0,f.MZ)({type:C.A,json:{name:"renderingRule",write:!0}})],eL.prototype,"rasterFunction",void 0),(0,r._)([(0,f.MZ)()],eL.prototype,"sourceJSON",void 0),(0,r._)([(0,f.MZ)({readOnly:!0,json:{origins:{service:{read:{source:"currentVersion"}}}}})],eL.prototype,"version",void 0),(0,r._)([(0,f.MZ)({readOnly:!0,json:{read:!1}})],eL.prototype,"type",void 0),(0,r._)([(0,f.MZ)({type:["ArcGISTiledImageServiceLayer"]})],eL.prototype,"operationalLayerType",void 0),(0,r._)([(0,f.MZ)({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:(e,t)=>!t.disablePopup},write:{target:"disablePopup",overridePolicy(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}},writer(e,t,i){t[i]=!e}}}})],eL.prototype,"popupEnabled",void 0),(0,r._)([(0,f.MZ)({type:a.A,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}}}}})],eL.prototype,"popupTemplate",void 0),(0,r._)([(0,f.MZ)({readOnly:!0})],eL.prototype,"defaultPopupTemplate",null),(0,r._)([(0,f.MZ)({readOnly:!0,type:[R.A]})],eL.prototype,"fields",void 0),(0,r._)([(0,f.MZ)({readOnly:!0,type:[R.A]})],eL.prototype,"rasterFields",null),(0,r._)([(0,f.MZ)({constructOnly:!0})],eL.prototype,"source",void 0);let eB=eL=(0,r._)([(0,d.$)("esri.layers.ImageryTileLayer")],eL)},71270:(e,t,i)=>{i.d(t,{E9:()=>d,Tw:()=>p,X6:()=>c});var r=i(39166),a=i(61414),s=i(39960),n=i(91463),l=i(65018),o=i(8946),u=i(86277),h=i(49570);async function f(e,t,i){let f=(0,u.Dl)(e),{rasterFunction:p,sourceJSON:c}=t||{},d=p?JSON.stringify(p.rasterFunctionDefinition||p):null,m=(0,u.lF)({...f.query,renderingRule:d,f:"json"}),y=(0,u.jV)(m,i);e=f.path;let g=c||await (0,r.A)(e,y).then(e=>e.data),w=g.hasRasterAttributeTable?(0,r.A)(`${e}/rasterAttributeTable`,y):null,x=g.hasColormap?(0,r.A)(`${e}/colormap`,y):null,v=g.hasHistograms?(0,r.A)(`${e}/histograms`,y):null,b=g.currentVersion>=10.3?(0,r.A)(`${e}/keyProperties`,y):null,I=g.hasMultidimensions?(0,r.A)(`${e}/multidimensionalInfo`,y):null,_=await Promise.allSettled([w,x,v,b,I]),A=null;if(g.minValues&&g.minValues.length===g.bandCount){A=[];for(let e=0;e<g.minValues.length;e++)A.push({min:g.minValues[e],max:g.maxValues[e],avg:g.meanValues[e],stddev:g.stdvValues[e]})}let S=a.A.fromJSON(g.extent),T=Math.ceil(S.width/g.pixelSizeX-.1),R=Math.ceil(S.height/g.pixelSizeY-.1),M=n.A.fromJSON(g.spatialReference||g.extent.spatialReference),C="fulfilled"===_[0].status?_[0].value?.data:null,O=C?.features?.length?h.A.fromJSON(C):null,F="fulfilled"===_[1].status?_[1].value?.data.colormap:null,P=F?.length?F:null,k="fulfilled"===_[2].status?_[2].value?.data.histograms:null,D=k?.[0]?.counts?.length?k:null,N="fulfilled"===_[3].status?_[3].value?.data??{}:{},E="fulfilled"===_[4].status?_[4].value?.data.multidimensionalInfo:null,L=E?.variables?.length?E:null;L&&L.variables.forEach(e=>{e.statistics?.length&&e.statistics.forEach(e=>{e.avg=e.mean,e.stddev=e.standardDeviation}),e.dimensions?.forEach(e=>{"StdTime"!==e.name||e.recurring||e.unit||(e.unit="ISO8601")})});let{defaultVariable:B,serviceDataType:z}=g;B&&B!==N.DefaultVariable&&(N.DefaultVariable=B),z?.includes("esriImageServiceDataTypeVector")&&!z.includes(N.DataType)&&(N.DataType=z.replace("esriImageServiceDataType",""));let J=g.noDataValue;g.noDataValues?.length&&g.noDataValues.some(e=>e!==J)&&(J=g.noDataValues);let V=g.transposeInfo?new o.A({blockWidth:256,blockHeight:256,pyramidBlockWidth:256,pyramidBlockHeight:256,pyramidScalingFactor:2,compression:"lerc",origin:new s.A({x:g.extent.xmin,y:g.extent.ymax,spatialReference:M}),firstPyramidLevel:1,maximumPyramidLevel:Math.max(0,Math.round(Math.log(Math.max(T,R))/Math.LN2-8)),transposeInfo:g.transposeInfo}):void 0;return new l.A({width:T,height:R,bandCount:g.bandCount,extent:a.A.fromJSON(g.extent),spatialReference:M,pixelSize:new s.A({x:g.pixelSizeX,y:g.pixelSizeY,spatialReference:M}),pixelType:g.pixelType.toLowerCase(),statistics:A,attributeTable:O,colormap:P,histograms:D,keyProperties:N,noDataValue:J,multidimensionalInfo:L,storageInfo:V})}function p(e,t,i){return f(e,{sourceJSON:t},i)}function c(e,t,i){return f(e,{rasterFunction:t},i)}function d(e,t){e.attributeTable||(t.hasRasterAttributeTable=!1),e.histograms||(t.hasHistograms=!1),e.colormap||(t.hasColormap=!1),e.multidimensionalInfo||(t.hasMultidimensions=!1)}},74020:(e,t,i)=>{i.d(t,{d:()=>S});var r,a=i(81856),s=i(39166),n=i(28690),l=i(51122),o=i(32391),u=i(19158);i(57845);var h=i(16082),f=i(87196),p=i(92753),c=i(45257),d=i(77089),m=i(90525),y=i(91838);i(61939),i(33638);var g=i(12709),w=i(99047),x=i(33715),v=i(94264),b=i(48678);class I{constructor(e){!function(e){if(!e?.location)throw new o.A("tilemap:missing-location","Location missing from tilemap response");if(!1===e.valid)throw new o.A("tilemap:invalid","Tilemap response was marked as invalid");if(!e.data)throw new o.A("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(e.data))throw new o.A("tilemap:data-mismatch","Data must be an array of numbers");if(e.data.length!==e.location.width*e.location.height)throw new o.A("tilemap:data-mismatch","Number of data items does not match width/height of tilemap")}(e);let{location:t,data:i}=e;this.location=Object.freeze((0,x.o8)(t));let r=this.location.width,a=this.location.height,s=!0,n=!0,l=function(e,t=!1){return e<=b.y9?t?Array(e).fill(0):Array(e):new Uint32Array(e)}(Math.ceil(r*a/32)),u=0;for(let e=0;e<i.length;e++){let t=e%32;i[e]?(n=!1,l[u]|=1<<t):s=!1,31===t&&++u}n?(this._availability="unavailable",this.byteSize=40):s?(this._availability="available",this.byteSize=40):(this._availability=l,this.byteSize=40+(0,v.Qf)(l))}getAvailability(e,t){if("unavailable"===this._availability||"available"===this._availability)return this._availability;let i=(e-this.location.top)*this.location.width+(t-this.location.left),r=i>>5,a=this._availability;return r<0||r>a.length?"unknown":a[r]&1<<i%32?"available":"unavailable"}static fromDefinition(e,t){let i=e.service.request||s.A,{row:r,col:a,width:n,height:l}=e,u={query:{f:"json"}};return t=t?{...u,...t}:u,i(function(e){let t;if(e.service.tileServers?.length){let i=e.service.tileServers;t=`${i&&i.length?i[e.row%i.length]:e.service.url}/tilemap/${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`}else t=`${e.service.url}/tilemap/${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`;let i=e.service.query;return i&&(t=`${t}?${i}`),t}(e),t).then(e=>e.data).catch(e=>{if(422===e?.details?.httpStatus)return{location:{top:r,left:a,width:n,height:l},valid:!0,data:Array(n*l).fill(0)};throw e}).then(e=>{if(e.location&&(e.location.top!==r||e.location.left!==a||e.location.width!==n||e.location.height!==l))throw new o.A("tilemap:location-mismatch","Tilemap response for different location than requested",{response:e,definition:{top:r,left:a,width:n,height:l}});return I.fromJSON(e)})}static fromJSON(e){return Object.freeze(new I(e))}}function _(e){return`${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`}function A(e,t,i){return new o.A("tile-map:tile-unavailable","Tile is not available",{level:e,row:t,col:i})}let S=r=class extends n.A{constructor(e){super(e),this._pendingTilemapRequests={},this.request=s.A,this.size=32,this._prefetchingEnabled=!0}initialize(){this._tilemapCache=new h.q(2*l.u.MEGABYTES),this.addHandles((0,c.wB)(()=>{let{layer:e}=this;return[e?.parsedUrl,e?.tileServers,e?.apiKey,e?.customParameters]},()=>this._initializeTilemapDefinition(),c.Vh))}get effectiveMinLOD(){return this.minLOD??this.layer.tileInfo.lods[0].level}get effectiveMaxLOD(){return this.maxLOD??this.layer.tileInfo.lods[this.layer.tileInfo.lods.length-1].level}getAvailability(e,t,i){if(!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD)return"unavailable";let r=this._tilemapFromCache(e,t,i,this._tmpTilemapDefinition);return r?r.getAvailability(t,i):"unknown"}fetchAvailability(e,t,i,r){return!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD?Promise.reject(A(e,t,i)):this._fetchTilemap(e,t,i,r).catch(e=>e).then(r=>{if(r instanceof I){let a=r.getAvailability(t,i);if("unavailable"===a)throw A(e,t,i);return a}if((0,p.zf)(r))throw r;return"unknown"})}fetchAvailabilityUpsample(e,t,i,r,a){r.level=e,r.row=t,r.col=i;let s=this.layer.tileInfo;s.updateTileInfo(r);let n=this.fetchAvailability(e,t,i,a).catch(e=>{if((0,p.zf)(e))throw e;if(s.upsampleTile(r))return this.fetchAvailabilityUpsample(r.level,r.row,r.col,r,a);throw e});return this._fetchAvailabilityUpsamplePrefetch(r.id,e,t,i,a,n),n}async _fetchAvailabilityUpsamplePrefetch(e,t,i,a,s,n){if(!this._prefetchingEnabled||null==e)return;let l=`prefetch-${e}`;if(this.hasHandles(l))return;let o=new AbortController;n.then(()=>o.abort(),()=>o.abort());let h=!1,f=(0,u.hA)(()=>{h||(h=!0,o.abort())});if(this.addHandles(f,l),await (0,d.md)(10,o.signal).catch(()=>{}),h||(h=!0,this.removeHandles(l)),(0,p.G4)(o))return;let c=new w.U(e,t,i,a),m={...s,signal:o.signal},y=this.layer.tileInfo;for(let e=0;r._prefetches.length<r._maxPrefetch&&y.upsampleTile(c);++e){let e=this.fetchAvailability(c.level,c.row,c.col,m);r._prefetches.push(e);let t=()=>{r._prefetches.removeUnordered(e)};e.then(t,t)}}_fetchTilemap(e,t,i,r){if(!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD)return Promise.reject(new o.A("tilemap-cache:level-unavailable",`Level ${e} is unavailable in the service`));let a=this._tmpTilemapDefinition,s=this._tilemapFromCache(e,t,i,a);if(s)return Promise.resolve(s);let n=r?.signal;return r={...r,signal:null},new Promise((e,t)=>{(0,p.u7)(n,()=>t((0,p.NK)()));let i=_(a),s=this._pendingTilemapRequests[i];if(!s){s=I.fromDefinition(a,r).then(e=>(this._tilemapCache.put(i,e,e.byteSize),e));let e=()=>{delete this._pendingTilemapRequests[i]};this._pendingTilemapRequests[i]=s,s.then(e,e)}s.then(e,t)})}_initializeTilemapDefinition(){if(!this.layer.parsedUrl)return;let{parsedUrl:e,apiKey:t,customParameters:i}=this.layer;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:e.path,query:(0,m.x0)({...e.query,...i,token:t??e.query?.token}),tileServers:this.layer.tileServers,request:this.request},width:this.size,height:this.size,level:0,row:0,col:0}}_tilemapFromCache(e,t,i,r){r.level=e,r.row=t-t%this.size,r.col=i-i%this.size;let a=_(r);return this._tilemapCache.get(a)}get test(){}};S._maxPrefetch=4,S._prefetches=new f.A({initialSize:r._maxPrefetch}),(0,a._)([(0,y.MZ)({constructOnly:!0})],S.prototype,"layer",void 0),(0,a._)([(0,y.MZ)({constructOnly:!0})],S.prototype,"minLOD",void 0),(0,a._)([(0,y.MZ)({constructOnly:!0})],S.prototype,"maxLOD",void 0),(0,a._)([(0,y.MZ)({constructOnly:!0})],S.prototype,"request",void 0),(0,a._)([(0,y.MZ)({constructOnly:!0})],S.prototype,"size",void 0),S=r=(0,a._)([(0,g.$)("esri.layers.support.TilemapCache")],S)},84325:(e,t,i)=>{i.d(t,{A:()=>y});var r,a=i(81856),s=i(91838);i(57845),i(61939),i(33638);var n=i(33498),l=i(53480),o=i(12709),u=i(7780),h=i(61414),f=i(39960),p=i(11559);function c(e,t,i){let{x:r,y:a}=t;if(i<2)return{x:e[0]+r*e[2]+a*e[4],y:e[1]+r*e[3]+a*e[5]};if(2===i){let t=r*r,i=a*a,s=r*a;return{x:e[0]+r*e[2]+a*e[4]+t*e[6]+s*e[8]+i*e[10],y:e[1]+r*e[3]+a*e[5]+t*e[7]+s*e[9]+i*e[11]}}let s=r*r,n=a*a,l=r*a,o=s*r,u=s*a,h=r*n,f=a*n;return{x:e[0]+r*e[2]+a*e[4]+s*e[6]+l*e[8]+n*e[10]+o*e[12]+u*e[14]+h*e[16]+f*e[18],y:e[1]+r*e[3]+a*e[5]+s*e[7]+l*e[9]+n*e[11]+o*e[13]+u*e[15]+h*e[17]+f*e[19]}}function d(e,t,i){let{xmin:r,ymin:a,xmax:s,ymax:n,spatialReference:l}=t,o=[];if(i<2)o.push({x:r,y:n}),o.push({x:s,y:n}),o.push({x:r,y:a}),o.push({x:s,y:a});else{let e=10;for(let t=0;t<e;t++)o.push({x:r,y:a+(n-a)*t/(e-1)}),o.push({x:s,y:a+(n-a)*t/(e-1)});e=8;for(let t=1;t<=e;t++)o.push({x:r+(s-r)*t/e,y:a}),o.push({x:r+(s-r)*t/e,y:n})}let u=(o=o.map(t=>c(e,t,i))).map(e=>e.x),f=o.map(e=>e.y);return new h.A({xmin:Math.min.apply(null,u),xmax:Math.max.apply(null,u),ymin:Math.min.apply(null,f),ymax:Math.max.apply(null,f),spatialReference:l})}let m=r=class extends p.A{constructor(){super(...arguments),this.polynomialOrder=1,this.type="polynomial"}readForwardCoefficients(e,t){let{coeffX:i,coeffY:r}=t;if(!i?.length||!r?.length||i.length!==r.length)return null;let a=[];for(let e=0;e<i.length;e++)a.push(i[e]),a.push(r[e]);return a}writeForwardCoefficients(e,t,i){let r=[],a=[];for(let t=0;t<e?.length;t++)t%2==0?r.push(e[t]):a.push(e[t]);t.coeffX=r,t.coeffY=a}get inverseCoefficients(){let e=this._get("inverseCoefficients"),t=this._get("forwardCoefficients");return!e&&t&&this.polynomialOrder<2&&(e=function(e){let[t,i,r,a,s,n]=e,l=r*n-s*a,o=s*a-r*n;return[(s*i-t*n)/l,(r*i-t*a)/o,n/l,a/o,-s/l,-r/o]}(t)),e}set inverseCoefficients(e){this._set("inverseCoefficients",e)}readInverseCoefficients(e,t){let{inverseCoeffX:i,inverseCoeffY:r}=t;if(!i?.length||!r?.length||i.length!==r.length)return null;let a=[];for(let e=0;e<i.length;e++)a.push(i[e]),a.push(r[e]);return a}writeInverseCoefficients(e,t,i){let r=[],a=[];for(let t=0;t<e?.length;t++)t%2==0?r.push(e[t]):a.push(e[t]);t.inverseCoeffX=r,t.inverseCoeffY=a}get affectsPixelSize(){return this.polynomialOrder>0}forwardTransform(e){if("point"===e.type){let t=c(this.forwardCoefficients,e,this.polynomialOrder);return new f.A({x:t.x,y:t.y,spatialReference:e.spatialReference})}return d(this.forwardCoefficients,e,this.polynomialOrder)}inverseTransform(e){if("point"===e.type){let t=c(this.inverseCoefficients,e,this.polynomialOrder);return new f.A({x:t.x,y:t.y,spatialReference:e.spatialReference})}return d(this.inverseCoefficients,e,this.polynomialOrder)}clone(){return new r({polynomialOrder:this.polynomialOrder,forwardCoefficients:this.forwardCoefficients?[...this.forwardCoefficients]:null,inverseCoefficients:this.inverseCoefficients?[...this.inverseCoefficients]:null})}};(0,a._)([(0,s.MZ)({json:{write:!0}})],m.prototype,"polynomialOrder",void 0),(0,a._)([(0,s.MZ)()],m.prototype,"forwardCoefficients",void 0),(0,a._)([(0,l.w)("forwardCoefficients",["coeffX","coeffY"])],m.prototype,"readForwardCoefficients",null),(0,a._)([(0,u.K)("forwardCoefficients")],m.prototype,"writeForwardCoefficients",null),(0,a._)([(0,s.MZ)({json:{write:!0}})],m.prototype,"inverseCoefficients",null),(0,a._)([(0,l.w)("inverseCoefficients",["inverseCoeffX","inverseCoeffY"])],m.prototype,"readInverseCoefficients",null),(0,a._)([(0,u.K)("inverseCoefficients")],m.prototype,"writeInverseCoefficients",null),(0,a._)([(0,s.MZ)()],m.prototype,"affectsPixelSize",null),(0,a._)([(0,n.e)({PolynomialXform:"polynomial"})],m.prototype,"type",void 0);let y=m=r=(0,a._)([(0,o.$)("esri.layers.support.rasterTransforms.PolynomialTransform")],m)},94264:(e,t,i)=>{i.d(t,{Qf:()=>o,Qh:()=>n,RS:()=>a,ez:()=>h,i5:()=>f,lM:()=>s,qK:()=>u});var r=i(48678);let a=16;function s(e){if(!e)return 0;let t=u;for(let i in e)e.hasOwnProperty(i)&&(t+=l(e[i],!1));return t}function n(e){if(!e)return 0;if("number"==typeof e[0])return o(e);if(Array.isArray(e)){var t=e;let i=t.length;if(0===i||"number"==typeof t[0])return function(e,t){return h+e.length*t}(t,8);let r=h;for(let e=0;e<i;e++)r+=l(t[e]);return r}let i=u;for(let t in e)e.hasOwnProperty(t)&&(i+=l(e[t]));return i}function l(e,t=!0){switch(typeof e){case"object":return t?n(e):u;case"string":return 32+e.length;case"number":return a;case"boolean":return 4;default:return 8}}function o(...e){return e.reduce((e,t)=>{var i,s;return e+(t?(0,r.iu)(t)?t.byteLength+f:Array.isArray(t)?(i=t,s=a,h+i.length*s):0:0)},0)}let u=32,h=16,f=145},96464:(e,t,i)=>{i.d(t,{A:()=>h});var r,a=i(81856),s=i(91838);i(57845),i(61939),i(33638);var n=i(33498),l=i(12709),o=i(11559);let u=r=class extends o.A{constructor(){super(...arguments),this.type="gcs-shift",this.tolerance=1e-8}forwardTransform(e){return"point"===(e=e.clone()).type?e.x>180+this.tolerance&&(e.x-=360):e.xmin>=180-this.tolerance?(e.xmax-=360,e.xmin-=360):e.xmax>180+this.tolerance&&(e.xmin=-180,e.xmax=180),e}inverseTransform(e){return"point"===(e=e.clone()).type?e.x<-this.tolerance&&(e.x+=360):e.xmin<-this.tolerance&&(e.xmin+=360,e.xmax+=360),e}clone(){return new r({tolerance:this.tolerance})}};(0,a._)([(0,n.e)({GCSShiftXform:"gcs-shift"})],u.prototype,"type",void 0),(0,a._)([(0,s.MZ)()],u.prototype,"tolerance",void 0);let h=u=r=(0,a._)([(0,l.$)("esri.layers.support.rasterTransforms.GCSShiftTransform")],u)}}]);