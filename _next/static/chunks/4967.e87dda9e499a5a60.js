"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4967],{2370:(e,t,i)=>{i.d(t,{E:()=>v,w:()=>n});var s=i(31461),r=i(28255);i(57845);var l=i(87196),a=i(70115);class n{constructor(e=9,t){this._compareMinX=_,this._compareMinY=d,this._toBBox=e=>e,this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this._toBBox=t:this._initFormat(t)),this.clear()}destroy(){this.clear(),x.prune(),w.prune(),b.prune(),S.prune()}all(e){h(this._data,e)}search(e,t){let i=this._data,s=this._toBBox;if(g(e,i))for(x.clear();i;){for(let r=0,l=i.children.length;r<l;r++){let l=i.children[r],a=i.leaf?s(l):l;g(e,a)&&(i.leaf?t(l):p(e,a)?h(l,t):x.push(l))}i=x.pop()}}collides(e){let t=this._data,i=this._toBBox;if(!g(e,t))return!1;for(x.clear();t;){for(let s=0,r=t.children.length;s<r;s++){let r=t.children[s],l=t.leaf?i(r):r;if(g(e,l)){if(t.leaf||p(e,l))return!0;x.push(r)}}t=x.pop()}return!1}load(e){if(!e.length)return this;if(e.length<this._minEntries){for(let t=0,i=e.length;t<i;t++)this.insert(e[t]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(this._data.children.length)if(this._data.height===t.height)this._splitRoot(this._data,t);else{if(this._data.height<t.height){let e=this._data;this._data=t,t=e}this._insert(t,this._data.height-t.height-1,!0)}else this._data=t;return this}insert(e){return e&&this._insert(e,this._data.height-1),this}clear(){return this._data=new T([]),this}remove(e){if(!e)return this;let t,i=this._data,l=null,a=0,n=!1,h=this._toBBox(e);for(b.clear(),S.clear();i||b.length>0;){if(i||(i=b.pop(),l=b.data[b.length-1],a=S.pop()??0,n=!0),i.leaf&&-1!==(t=(0,s.qh)(i.children,(0,r.zI)(e),i.children.length,i.indexHint)))return i.children.splice(t,1),b.push(i),this._condense(b),this;n||i.leaf||!p(i,h)?l?(a++,i=l.children[a],n=!1):i=null:(b.push(i),S.push(a),a=0,l=i,i=i.children[0])}return this}toJSON(){return this._data}fromJSON(e){return this._data=e,this}_build(e,t,i,s){let r=i-t+1,l=this._maxEntries;if(r<=l){let s=new T(e.slice(t,i+1));return o(s,this._toBBox),s}s||(s=Math.ceil(Math.log(r)/Math.log(l)),l=Math.ceil(r/l**(s-1)));let a=new M([]);a.height=s;let n=Math.ceil(r/l),h=n*Math.ceil(Math.sqrt(l));m(e,t,i,h,this._compareMinX);for(let r=t;r<=i;r+=h){let t=Math.min(r+h-1,i);m(e,r,t,n,this._compareMinY);for(let i=r;i<=t;i+=n){let r=Math.min(i+n-1,t);a.children.push(this._build(e,i,r,s-1))}}return o(a,this._toBBox),a}_insert(e,t,i){let s=this._toBBox,r=i?e:s(e);b.clear();let l=function(e,t,i,s){for(;s.push(t),!0!==t.leaf&&s.length-1!==i;){let i,s=1/0,a=1/0;for(let n=0,h=t.children.length;n<h;n++){var r,l;let h=t.children[n],o=y(h),u=(r=e,(Math.max((l=h).maxX,r.maxX)-Math.min(l.minX,r.minX))*(Math.max(l.maxY,r.maxY)-Math.min(l.minY,r.minY))-o);u<a?(a=u,s=o<s?o:s,i=h):u===a&&o<s&&(s=o,i=h)}t=i||t.children[0]}return t}(r,this._data,t,b);for(l.children.push(e),c(l,r);t>=0&&b.data[t].children.length>this._maxEntries;)this._split(b,t),t--;var a=r,n=b,h=t;for(let e=h;e>=0;e--)c(n.data[e],a)}_split(e,t){let i=e.data[t],s=i.children.length,r=this._minEntries;this._chooseSplitAxis(i,r,s);let l=this._chooseSplitIndex(i,r,s);if(!l)return;let a=i.children.splice(l,i.children.length-l),n=i.leaf?new T(a):new M(a);n.height=i.height,o(i,this._toBBox),o(n,this._toBBox),t?e.data[t-1].children.push(n):this._splitRoot(i,n)}_splitRoot(e,t){this._data=new M([e,t]),this._data.height=e.height+1,o(this._data,this._toBBox)}_chooseSplitIndex(e,t,i){let s,r,l;s=r=1/0;for(let a=t;a<=i-t;a++){let t=u(e,0,a,this._toBBox),n=u(e,a,i,this._toBBox),h=function(e,t){let i=Math.max(e.minX,t.minX),s=Math.max(e.minY,t.minY);return Math.max(0,Math.min(e.maxX,t.maxX)-i)*Math.max(0,Math.min(e.maxY,t.maxY)-s)}(t,n),o=y(t)+y(n);h<s?(s=h,l=a,r=o<r?o:r):h===s&&o<r&&(r=o,l=a)}return l}_chooseSplitAxis(e,t,i){let s=e.leaf?this._compareMinX:_,r=e.leaf?this._compareMinY:d;this._allDistMargin(e,t,i,s)<this._allDistMargin(e,t,i,r)&&e.children.sort(s)}_allDistMargin(e,t,i,s){e.children.sort(s);let r=this._toBBox,l=u(e,0,t,r),a=u(e,i-t,i,r),n=f(l)+f(a);for(let s=t;s<i-t;s++){let t=e.children[s];c(l,e.leaf?r(t):t),n+=f(l)}for(let s=i-t-1;s>=t;s--){let t=e.children[s];c(a,e.leaf?r(t):t),n+=f(a)}return n}_condense(e){for(let t=e.length-1;t>=0;t--){let i=e.data[t];if(0===i.children.length)if(t>0){let r=e.data[t-1],l=r.children;l.splice((0,s.qh)(l,i,l.length,r.indexHint),1)}else this.clear();else o(i,this._toBBox)}}_initFormat(e){let t=["return a"," - b",";"];this._compareMinX=Function("a","b",t.join(e[0])),this._compareMinY=Function("a","b",t.join(e[1])),this._toBBox=Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}}function h(e,t){let i=e;for(w.clear();i;){if(!0===i.leaf)for(let e of i.children)t((0,r.zI)(e));else w.pushArray(i.children);i=w.pop()??null}}function o(e,t){u(e,0,e.children.length,t,e)}function u(e,t,i,s,r){r||(r=new T([])),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(let l,a=t;a<i;a++)l=e.children[a],c(r,e.leaf?s(l):l);return r}function c(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function _(e,t){return e.minX-t.minX}function d(e,t){return e.minY-t.minY}function y(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function f(e){return e.maxX-e.minX+(e.maxY-e.minY)}function p(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function g(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function m(e,t,i,s,r){let l=[t,i];for(;l.length;){let t=l.pop(),i=l.pop();if(t-i<=s)continue;let n=i+Math.ceil((t-i)/s/2)*s;(0,a.q)(e,n,i,t,r),l.push(i,n,n,t)}}let x=new l.A,w=new l.A,b=new l.A,S=new l.A({deallocator:void 0});class v{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class I extends v{constructor(){super(...arguments),this.height=1,this.indexHint=new s.vW}}class T extends I{constructor(e){super(),this.children=e,this.leaf=!0}}class M extends I{constructor(e){super(),this.children=e,this.leaf=!1}}},16573:(e,t,i)=>{i.d(t,{A:()=>s});class s{constructor(e){this.extent=4096,this.keys=[],this.values=[],this._pbfLayer=e.clone();let t=e.asUnsafe();for(;t.next();)switch(t.tag()){case 1:this.name=t.getString();break;case 3:this.keys.push(t.getString());break;case 4:this.values.push(t.processMessage(s._parseValue));break;case 5:this.extent=t.getUInt32();break;default:t.skip()}}getData(){return this._pbfLayer}static _parseValue(e){for(;e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getInt64();case 5:return e.getUInt64();case 6:return e.getSInt64();case 7:return e.getBool();default:e.skip()}return null}}},24967:(e,t,i)=>{i.r(t),i.d(t,{default:()=>eL});var s=i(81856),r=i(33715),l=i(61939),a=i(40941),n=i(92753),h=i(91838);i(57845);var o=i(12709),u=i(70128),c=i(39960),_=i(84766),d=i(71760),y=i(43021),f=i(90525),p=i(6675),g=i(35568);class m{constructor(e,t){this._width=0,this._height=0,this._free=[],this._width=e,this._height=t,this._free.push(new g.A(0,0,e,t))}get width(){return this._width}get height(){return this._height}allocate(e,t){if(e>this._width||t>this._height)return new g.A;let i=null,s=-1;for(let r=0;r<this._free.length;++r){let l=this._free[r];e<=l.width&&t<=l.height&&(null===i||l.y<=i.y&&l.x<=i.x)&&(i=l,s=r)}return null===i?new g.A:(this._free.splice(s,1),i.width<i.height?(i.width>e&&this._free.push(new g.A(i.x+e,i.y,i.width-e,t)),i.height>t&&this._free.push(new g.A(i.x,i.y+t,i.width,i.height-t))):(i.width>e&&this._free.push(new g.A(i.x+e,i.y,i.width-e,i.height)),i.height>t&&this._free.push(new g.A(i.x,i.y+t,e,i.height-t))),new g.A(i.x,i.y,e,t))}release(e){for(let t=0;t<this._free.length;++t){let i=this._free[t];if(i.y===e.y&&i.height===e.height&&i.x+i.width===e.x)i.width+=e.width;else if(i.x===e.x&&i.width===e.width&&i.y+i.height===e.y)i.height+=e.height;else if(e.y===i.y&&e.height===i.height&&e.x+e.width===i.x)i.x=e.x,i.width+=e.width;else{if(e.x!==i.x||e.width!==i.width||e.y+e.height!==i.y)continue;i.y=e.y,i.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}}var x=i(93446),w=i(87155),b=i(15494);class S{constructor(e,t,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=e,this.height=t,this._glyphSource=i,this._binPack=new m(e-4,t-4),this._glyphData.push(new Uint8Array(e*t)),this._dirties.push(!0),this._textures.push(void 0)}getGlyphItems(e,t){let i=[],s=this._glyphSource,r=new Set,l=1/256;for(let e of t){let t=Math.floor(e*l);r.add(t)}let a=[];return r.forEach(t=>{let i=e+t;if(this._rangePromises.has(i))a.push(this._rangePromises.get(i));else{let r=s.getRange(e,t).then(()=>{this._rangePromises.delete(i)},()=>{this._rangePromises.delete(i)});this._rangePromises.set(i,r),a.push(r)}}),Promise.all(a).then(()=>{let r=this._glyphIndex[e];for(let l of(r||(r={},this._glyphIndex[e]=r),t)){let t,a=r[l];if(a){i[l]={sdf:!0,rect:a.rect,metrics:a.metrics,page:a.page,code:l};continue}let n=s.getGlyph(e,l);if(!n?.metrics)continue;let h=n.metrics;if(0===h.width)t=new g.A(0,0,0,0);else{let e,i,s=h.width+6,r=h.height+6,l=s%4?4-s%4:4,a=r%4?4-r%4:4;1===l&&(l=5),1===a&&(a=5),(t=this._binPack.allocate(s+l,r+a)).isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new m(this.width-4,this.height-4),t=this._binPack.allocate(s+l,r+a));let o=this._glyphData[this._currentPage],u=n.bitmap;if(u)for(let l=0;l<r;l++){e=s*l,i=this.width*(t.y+l+1)+t.x;for(let t=0;t<s;t++)o[i+t+1]=u.at(e+t)}}r[l]={rect:t,metrics:h,tileIDs:null,page:this._currentPage},i[l]={sdf:!0,rect:t,metrics:h,page:this._currentPage,code:l},this._dirties[this._currentPage]=!0}return i})}removeGlyphs(e){for(let t in this._glyphIndex){let i,s=this._glyphIndex[t];if(s){for(let t in s)if((i=s[t]).tileIDs.delete(e),0===i.tileIDs.size){let e,r,l=this._glyphData[i.page],a=i.rect;for(let t=0;t<a.height;t++)for(e=this.width*(a.y+t)+a.x,r=0;r<a.width;r++)l[e+r]=0;delete s[t],this._dirties[i.page]=!0}}}}bind(e,t,i,s=0){if(!this._textures[i]){let t=new b.R;t.pixelFormat=x.Ab.ALPHA,t.wrapMode=x.pF.CLAMP_TO_EDGE,t.width=this.width,t.height=this.height,this._textures[i]=new w.g(e,t,new Uint8Array(this.width*this.height))}let r=this._textures[i];r.setSamplingMode(t),this._dirties[i]&&r.setData(this._glyphData[i]),e.bindTexture(r,s),this._dirties[i]=!1}destroy(){this.dispose()}dispose(){for(let e of(this._glyphData.length=0,this._binPack=null,this._textures))e&&e.dispose();this._textures.length=0}}var v=i(39166),I=i(36365);class T{constructor(e){if(this._metrics=[],!e)return void(this._allBitmaps=null);let t=new Map,i=0;for(;e.next();)if(1===e.tag()){let s=e.getMessage();for(;s.next();)if(3===s.tag()){let e,r,l,a,n,h,o,u=s.getMessage();for(;u.next();)switch(u.tag()){case 1:e=u.getUInt32();break;case 2:r=u.getBytes();break;case 3:l=u.getUInt32();break;case 4:a=u.getUInt32();break;case 5:n=u.getSInt32();break;case 6:h=u.getSInt32();break;case 7:o=u.getUInt32();break;default:u.skip()}if(u.release(),e){let s=r?.length??0;this._metrics[e]={width:l,height:a,left:n,top:h,advance:o,startOffset:i,length:s},t.set(e,r),i+=s}}else s.skip();s.release()}else e.skip();let s=new Uint8Array(i),r=this._metrics;for(let[e,i]of t){let{startOffset:t,length:l}=r[e];if(i)for(let e=0;e<l;++e)s[t+e]=i[e]}this._allBitmaps=s}getMetrics(e){return this._metrics[e]}getBitmap(e){if(!this._allBitmaps)return;let t=this._metrics[e];if(void 0===t)return;let{startOffset:i,length:s}=t;return 0!==s?new A(this._allBitmaps,i,s):void 0}}class M{constructor(){this._ranges=[]}get ranges(){return this._ranges}getRange(e){return this._ranges[e]}addRange(e,t){this._ranges[e]=t}}class C{constructor(e){this._glyphInfo={},this._baseURL=e}getRange(e,t){let i=this._getFontStack(e);if(i.getRange(t))return Promise.resolve();let s=256*t;if(this._baseURL){let r=this._baseURL.replace("{fontstack}",e).replace("{range}",s+"-"+(s+255));return(0,v.A)(r,{responseType:"array-buffer"}).then(e=>{i.addRange(t,new T(new I.A(new Uint8Array(e.data),new DataView(e.data))))}).catch(()=>{i.addRange(t,new T)})}return i.addRange(t,new T),Promise.resolve()}getGlyph(e,t){let i=this._getFontStack(e);if(!i)return;let s=Math.floor(t/256),r=i.getRange(s);return r?{metrics:r.getMetrics(t),bitmap:r.getBitmap(t)}:void 0}_getFontStack(e){let t=this._glyphInfo[e];return t||(t=this._glyphInfo[e]=new M),t}}class A{constructor(e,t,i){this._array=e,this._start=t,this.length=i}at(e){return 0<=e&&e<this.length?this._array[this._start+e]:void 0}}var D=i(66544);class R{constructor(e,t,i=0){this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,t<=0&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=e,this._pageHeight=t,i>0&&(this._maxItemSize=i),this._binPack=new m(e-4,t-4)}destroy(){this.dispose()}dispose(){for(let e of(this._binPack=null,this._mosaicsData.length=0,this._mosaicRects={},this._textures))e&&e.dispose();this._textures.length=0}getWidth(e){return e>=this._size.length?-1:this._size[e][0]}getHeight(e){return e>=this._size.length?-1:this._size[e][1]}getPageSize(e){return e>=this._size.length?null:this._size[e]}setSpriteSource(e){if(this.dispose(),this.pixelRatio=e.devicePixelRatio,0===this._mosaicsData.length){this._binPack=new m(this._pageWidth-4,this._pageHeight-4);let e=new Uint32Array(Math.floor(this._pageWidth)*Math.floor(this._pageHeight));this._mosaicsData[0]=e,this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0)}this._sprites=e}getSpriteItem(e,t=!1){let i,s,r=this._mosaicRects[e];if(r)return r;if(!this._sprites||"loaded"!==this._sprites.loadStatus||(e&&e.startsWith("dasharray-")?([i,s]=this._rasterizeDash(e),t=!0):i=this._sprites.getSpriteInfo(e),!i?.width||!i.height||i.width<0||i.height<0))return null;let l=i.width,a=i.height,[n,h,o]=this._allocateImage(l,a);return n.width<=0?null:(this._copy(n,i,h,o,t,s),r={type:"sprite",rect:n,width:l,height:a,sdf:i.sdf,simplePattern:!1,rasterizationScale:i.pixelRatio??1,samplingMode:"Linear",page:h},this._mosaicRects[e]=r,r)}getSpriteItems(e){let t={};for(let i of e)t[i.name]=this.getSpriteItem(i.name,i.repeat);return t}getMosaicItemPosition(e,t){let i=this.getSpriteItem(e,t),s=i?.rect;if(!s)return null;s.width=i.width,s.height=i.height;let r=i.width,l=i.height;return{tl:[s.x+2,s.y+2],br:[s.x+2+r,s.y+2+l],page:i.page}}bind(e,t,i=0,s=0){if(i>=this._size.length||i>=this._mosaicsData.length)return;if(!this._textures[i]){let t=new b.R;t.wrapMode=x.pF.CLAMP_TO_EDGE,t.width=this._size[i][0],t.height=this._size[i][1],this._textures[i]=new w.g(e,t,new Uint8Array(this._mosaicsData[i].buffer))}let r=this._textures[i];r.setSamplingMode(t),this._dirties[i]&&r.setData(new Uint8Array(this._mosaicsData[i].buffer)),e.bindTexture(r,s),this._dirties[i]=!1}static _copyBits(e,t,i,s,r,l,a,n,h,o,u){let c=s*t+i,_=n*l+a;if(u){_-=l;for(let a=-1;a<=o;c=((++a+o)%o+s)*t+i,_+=l)for(let t=-1;t<=h;t++)r[_+t]=e[c+(t+h)%h]}else for(let i=0;i<o;i++){for(let t=0;t<h;t++)r[_+t]=e[c+t];c+=t,_+=l}}_copy(e,t,i,s,r,l){if(!this._sprites||"loaded"!==this._sprites.loadStatus||i>=this._mosaicsData.length)return;let a=new Uint32Array(l?l.buffer:this._sprites.image.buffer),n=this._mosaicsData[i],h=l?t.width:this._sprites.width;R._copyBits(a,h,t.x,t.y,n,s[0],e.x+2,e.y+2,t.width,t.height,r),this._dirties[i]=!0}_allocateImage(e,t){e+=2,t+=2;let i=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<i){let i=new g.A(0,0,e,t);return this._mosaicsData.push(new Uint32Array(e*t)),this._dirties.push(!0),this._size.push([e,t]),this._textures.push(void 0),[i,this._mosaicsData.length-1,[e,t]]}let s=e%4?4-e%4:4,r=t%4?4-t%4:4;1===s&&(s=5),1===r&&(r=5);let l=this._binPack.allocate(e+s,t+r);return l.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new m(this._pageWidth-4,this._pageHeight-4),this._allocateImage(e,t)):[l,this._currentPage,[this._pageWidth,this._pageHeight]]}_rasterizeDash(e){let t=e.match(/\[(.*?)\]/);if(!t)return null;let i=t[1].split(",").map(Number),s=e.slice(e.lastIndexOf("-")+1),[r,l,a]=(0,D.k2)(i,s);return[{x:0,y:0,width:l,height:a,sdf:!0,pixelRatio:1},new Uint8Array(r.buffer)]}}var P=i(79378);class L{constructor(e,t,i,s){this._layer=e,this._styleRepository=t,this.devicePixelRatio=i,this._sourceDataMaxLOD=s,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._spriteSourceAbortController=null,this._startOptionsInputSignal=null,this._inputSignalEventListener=null}destroy(){this._connection?.close(),this._connection=null,this._styleRepository=null,this._layer=null,this._spriteMosaic?.destroy(),this._spriteMosaic=null,this._glyphMosaic=null,this._spriteSourceAbortController=(0,a.DC)(this._spriteSourceAbortController),this._spriteSourcePromise=null,this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,this._inputSignalEventListener=null}get spriteMosaic(){return this._spriteSourcePromise.then(()=>this._spriteMosaic)}get glyphMosaic(){return this._glyphMosaic}async start(e){this._requestSprite(e);let t=this._layer.currentStyleInfo.glyphsUrl,i=new C(t?(0,f.a6)(t,{...this._layer.customParameters,token:this._layer.apiKey}):null);this._glyphMosaic=new S(1024,1024,i),this._broadcastPromise=(0,p.ho)("WorkerTileHandler",{client:this,schedule:e.schedule,signal:e.signal}).then(t=>{this._layer&&(this._connection?.close(),this._connection=t,this._layer&&!this._connection.closed)&&Promise.all(t.broadcast("setStyle",{style:this._layer.currentStyleInfo.style,sourceDataMaxLOD:this._sourceDataMaxLOD},e)).catch(e=>(0,n.jH)(e))})}_requestSprite(e){var t;this._spriteSourceAbortController?.abort();let i=new AbortController;this._spriteSourceAbortController=i;let s=e?.signal;this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,s&&(this._inputSignalEventListener=(t=i,()=>t.abort()),s.addEventListener("abort",this._inputSignalEventListener,{once:!0}));let{signal:r}=i,l={...e,signal:r};this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,l),this._spriteSourcePromise.then(e=>{(0,n.QP)(r),this._spriteMosaic=new R(1024,1024,250),this._spriteMosaic.setSpriteSource(e)})}async updateStyle(e){let t=[];for(let i of e)i.type===y.$q.SPRITES_CHANGED?t.push({type:y.$q.SPRITES_CHANGED,data:{spriteSource:null}}):t.push(i);return await this._broadcastPromise,this._broadcastPromise=Promise.all(this._connection.broadcast("updateStyle",t)),this._broadcastPromise}setSpriteSource(e){let t=new R(1024,1024,250);return t.setSpriteSource(e),this._spriteMosaic=t,this._spriteSourcePromise=Promise.resolve(e),this._spriteSourceAbortController=null,t}async setStyle(e,t,i){await this._broadcastPromise,this._styleRepository=e,this._sourceDataMaxLOD=i,this._requestSprite();let s=new C(this._layer.currentStyleInfo.glyphsUrl?(0,f.a6)(this._layer.currentStyleInfo.glyphsUrl,{...this._layer.customParameters,token:this._layer.apiKey}):null);return this._glyphMosaic=new S(1024,1024,s),this._broadcastPromise=Promise.all(this._connection.broadcast("setStyle",{style:t,sourceDataMaxLOD:this._sourceDataMaxLOD})),this._broadcastPromise}async fetchTileData(e,t){let i=await this._getRefKeys(e,t);return this._getSourcesData(Object.keys(this._layer.sourceNameToSource),i,t)}async fetchTilePBFs(e){let t=Object.keys(this._layer.sourceNameToSource),i={},s=await this._getRefKeys(e,i),r=[],l=[];for(let e=0;e<s.length;e++)if(null==s[e].value||null==t[e])l.push(null);else{let a=s[e].value,n=this._getTilePayload(a,t[e],i);n.then(e=>{r.push({...e,key:a})}),l.push(n)}return Promise.all(l).then(()=>r)}async parseTileData(e,t){let i=e&&e.data;if(!i)return null;let{sourceName2DataAndRefKey:s,transferList:r}=i;return 0===Object.keys(s).length?null:this._broadcastPromise.then(()=>this._connection.invoke("createTileAndParse",{key:e.key.id,sourceName2DataAndRefKey:s,styleLayerUIDs:e.styleLayerUIDs},{...t,transferList:r}))}async getSprites(e){return await this._spriteSourcePromise,this._spriteMosaic.getSpriteItems(e)}getGlyphs(e){return this._glyphMosaic.getGlyphItems(e.font,e.codePoints)}async _getTilePayload(e,t,i){let s=P.A.pool.acquire(e.id),r=this._layer.sourceNameToSource[t],{level:l,row:a,col:h}=s;P.A.pool.release(s);try{return{protobuff:await r.requestTile(l,a,h,i),sourceName:t}}catch(e){if((0,n.zf)(e))throw e;return{protobuff:null,sourceName:t}}}async _getRefKeys(e,t){let i=this._layer.sourceNameToSource,s=[];for(let r in i){let l=i[r].getRefKey(e,t);s.push(l)}return(0,n.Lx)(s)}_getSourcesData(e,t,i){let s=[];for(let r=0;r<t.length;r++)if(null==t[r].value||null==e[r])s.push(null);else{let l=t[r].value,a=this._getTilePayload(l,e[r],i);s.push(a)}return(0,n.Lx)(s).then(e=>{let i={},s=[];for(let r=0;r<e.length;r++){let l=e[r].value;if(l&&l.protobuff&&l.protobuff.byteLength>0){let e=t[r].value.id;i[l.sourceName]={refKey:e,protobuff:l.protobuff},s.push(l.protobuff)}}return{sourceName2DataAndRefKey:i,transferList:s}})}}var k=i(16082),U=i(39137);let O=(e,t)=>e+1/(1<<2*t);class E{constructor(e,t){this._tiles=new Map,this._tileCache=new k.q(40,e=>e.dispose()),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this._container=t}destroy(){for(let e of this._tiles.values())e.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(e){this._updateCacheSize(e);let t=this.tileInfoView,i=t.getTileCoverage(e.state,0,!0,"smallest");if(!i)return!0;let{spans:s,lodInfo:r}=i,{level:l}=r,a=this._tiles,n=new Set,h=new Set;for(let{row:e,colFrom:t,colTo:i}of s)for(let s=t;s<=i;s++){let t=P.A.getId(l,e,r.normalizeCol(s),r.getWorldForColumn(s)),i=this._getOrAcquireTile(t);n.add(t),i.processed()?this._addToContainer(i):h.add(new P.A(t))}for(let[e,t]of a)t.isCoverage=n.has(e);for(let e of h)this._findPlaceholdersForMissingTiles(e,n);let o=!1;for(let[e,s]of a)s.neededForCoverage=n.has(e),s.neededForCoverage||s.isHoldingForFade&&t.intersects(i,s.key)&&n.add(e),s.isFading&&(o=!0);for(let e of this._tiles.keys())n.has(e)||this._releaseTile(e);return U.A.pool.release(i),!o}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}getIntersectingTiles(e,t,i,s,r){let l=[0,0],a=[0,0];s.toMap(l,e-i,t+i),s.toMap(a,e+i,t-i);let n=Math.min(l[0],a[0]),h=Math.min(l[1],a[1]),o=Math.max(l[0],a[0]),u=Math.max(l[1],a[1]),c=(0,_.fA)(n,h,o,u),d=(0,_.vt)(),y=[];for(let e of this._visibleTiles.values())this.tileInfoView.getTileBounds(d,e.key),(0,_.HY)(c,d)&&y.push(e);if(null!=r&&r.length>0){let e=new Set(y.map(e=>e.id)),t=r.filter(t=>!e.has(t.tileKey.id)).map(e=>this._visibleTiles.get(e.tileKey.id)).filter(e=>void 0!==e);y.push(...t)}return y}_findPlaceholdersForMissingTiles(e,t){let i=[];for(let s of this._tiles.values())this._addPlaceholderChild(i,s,e,t);1e-6>Math.abs(1-i.reduce(O,0))||this._addPlaceholderParent(e.id,t)}_addPlaceholderChild(e,t,i,s){t.key.level<=i.level||!t.hasData()||function(e,t){let i=t.level-e.level;return e.row===t.row>>i&&e.col===t.col>>i&&e.world===t.world}(i,t.key)&&(this._addToContainer(t),s.add(t.id),e.push(t.key.level-i.level))}_addPlaceholderParent(e,t){let i=this._tiles,s=e;for(;;){if(!(s=function(e){let[t,i,s,r]=e.split("/"),l=parseInt(t,10);return 0===l?null:`${l-1}/${parseInt(i,10)>>1}/${parseInt(s,10)>>1}/${parseInt(r,10)}`}(s))||t.has(s))return;let e=i.get(s);if(e?.hasData())return this._addToContainer(e),void t.add(e.id)}}_getOrAcquireTile(e){let t=this._tiles.get(e);return t||((t=this._tileCache.pop(e))||(t=this.acquireTile(new P.A(e))),this._tiles.set(e,t),t)}_releaseTile(e){let t=this._tiles.get(e);this.releaseTile(t),this._removeFromContainer(t),this._tiles.delete(e),t.hasData()?this._tileCache.put(e,t,1):t.dispose()}_addToContainer(e){let t,i=[],s=this._container;if(s.contains(e))return;let r=this._visibleTiles;for(let s of r.values())this._canConnectDirectly(e,s)&&i.push(s),null==t&&this._canConnectDirectly(s,e)&&(t=s);if(null!=t){for(let s of i)t.childrenTiles.delete(s),e.childrenTiles.add(s),s.parentTile=e;t.childrenTiles.add(e),e.parentTile=t}else for(let t of i)e.childrenTiles.add(t),t.parentTile=e;r.set(e.id,e),s.addChild(e)}_removeFromContainer(e){if(this._visibleTiles.delete(e.id),this._container.removeChild(e),null!=e.parentTile)for(let t of(e.parentTile.childrenTiles.delete(e),e.childrenTiles))null!=e.parentTile&&e.parentTile.childrenTiles.add(t);for(let t of e.childrenTiles)t.parentTile=e.parentTile;e.parentTile=null,e.childrenTiles.clear()}_canConnectDirectly(e,t){let i=e.key,{level:s,row:r,col:l,world:a}=t.key,n=this._visibleTiles;for(;s>0;){if(s--,r>>=1,l>>=1,i.level===s&&i.row===r&&i.col===l&&i.world===a)return!0;if(n.has(`${s}/${r}/${l}/${a}`))break}return!1}_updateCacheSize(e){let t=e.state.size;if(t[0]===this._viewSize[0]&&t[1]===this._viewSize[1])return;let i=Math.ceil(t[0]/512)+1,s=Math.ceil(t[1]/512)+1;this._viewSize[0]=t[0],this._viewSize[1]=t[1],this._tileCache.maxSize=5*i*s}}var V=i(6815),F=i(19284),z=i(94264),B=i(61849),q=i(88161);i(16643);var H=i(61070);class N{constructor(e,t){this.sourceTile=t,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}}class Y{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}}function W(e,t,i,s,r,l){let a=i-r;if(a>=0)return(t>>a)+(s-(l<<a))*(e>>a);let n=-a;return t-(l-(s<<n))*(e>>n)<<n}class Q{constructor(e,t,i){this._rows=Math.ceil(t/i),this._columns=Math.ceil(e/i),this._cellSize=i,this.cells=Array(this._rows);for(let e=0;e<this._rows;e++){this.cells[e]=Array(this._columns);for(let t=0;t<this._columns;t++)this.cells[e][t]=[]}}getCell(e,t){let i=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._rows-1),s=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[i]&&this.cells[i][s]||null}getCellSpan(e,t,i,s){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}var G=i(62233),X=i(84172);class J{constructor(e,t){this.layerUIDs=[],this.isDestroyed=!1,this._data=e;let i=1,s=new Uint32Array(e);this.layerUIDs=[];let r=s[i++];for(let e=0;e<r;e++)this.layerUIDs[e]=s[i++];this.bufferDataOffset=i,t&&(this.layer=t.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return null==this._data}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this._data=null,this.isDestroyed=!0)}prepareForRendering(e){null!=this._data&&(this.doPrepareForRendering(e,this._data,this.bufferDataOffset),this._data=null)}}class $ extends J{constructor(e,t){super(e,t),this.type=y.NP.LINE,this.lineIndexStart=0,this.lineIndexCount=0;let i=new Uint32Array(e),s=this.bufferDataOffset;this.lineIndexStart=i[s++],this.lineIndexCount=i[s++];let r=i[s++];if(r>0){this.patternMap=new Map;for(let e=0;e<r;e++){let e=i[s++],t=i[s++],r=i[s++];this.patternMap.set(e,[t,r])}}this.bufferDataOffset=s}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.cachedMemory??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=(0,a.WD)(this.vao)}doPrepareForRendering(e,t,i){let s=new Uint32Array(t),r=new Int32Array(s.buffer),l=s[i++],a=G.g.createVertex(e,x._U.STATIC_DRAW,new Int32Array(r.buffer,4*i,l));i+=l;let n=s[i++],h=G.g.createIndex(e,x._U.STATIC_DRAW,new Uint32Array(s.buffer,4*i,n));i+=n;let o=this.layer.lineMaterial;this.vao=new X.Z(e,o.getAttributeLocations(),o.getLayoutInfo(),new Map([["geometry",a]]),h)}}class K extends J{constructor(e,t){super(e,t),this.type=y.NP.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;let i=new Uint32Array(e),s=this.bufferDataOffset;this.fillIndexStart=i[s++],this.fillIndexCount=i[s++],this.outlineIndexStart=i[s++],this.outlineIndexCount=i[s++];let r=i[s++];if(r>0){this.patternMap=new Map;for(let e=0;e<r;e++){let e=i[s++],t=i[s++],r=i[s++];this.patternMap.set(e,[t,r])}}this.bufferDataOffset=s}get usedMemory(){return(this.data?.byteLength??0)+(this.fillVAO?.cachedMemory??0)+(this.outlineVAO?.cachedMemory??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=(0,a.WD)(this.fillVAO),this.outlineVAO=(0,a.WD)(this.outlineVAO)}doPrepareForRendering(e,t,i){let s=new Uint32Array(t),r=new Int32Array(s.buffer),l=s[i++],a=G.g.createVertex(e,x._U.STATIC_DRAW,new Int32Array(r.buffer,4*i,l));i+=l;let n=s[i++],h=G.g.createIndex(e,x._U.STATIC_DRAW,new Uint32Array(s.buffer,4*i,n));i+=n;let o=s[i++],u=G.g.createVertex(e,x._U.STATIC_DRAW,new Int32Array(r.buffer,4*i,o));i+=o;let c=s[i++],_=G.g.createIndex(e,x._U.STATIC_DRAW,new Uint32Array(s.buffer,4*i,c));i+=c;let d=this.layer,y=d.fillMaterial,f=d.outlineMaterial;this.fillVAO=new X.Z(e,y.getAttributeLocations(),y.getLayoutInfo(),new Map([["geometry",a]]),h),this.outlineVAO=new X.Z(e,f.getAttributeLocations(),f.getLayoutInfo(),new Map([["geometry",u]]),_)}}class j extends J{constructor(e,t,i){super(e,t),this.type=y.NP.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];let s=new Uint32Array(e),r=new Int32Array(e),l=new Float32Array(e),a=this.bufferDataOffset;this.isIconSDF=!!s[a++];let n=s[a++],h=s[a++],o=s[a++],u=new P.A(n,h,o,0),c=s[a++];for(let e=0;e<c;e++){let e=s[a++],t=s[a++],i=s[a++];this.iconPerPageElementsMap.set(e,[t,i])}let _=s[a++];for(let e=0;e<_;e++){let e=s[a++],t=s[a++],i=s[a++];this.glyphPerPageElementsMap.set(e,[t,i])}let d=s[a++],f=s[a++];this.iconOpacity=new Int32Array(d),this.textOpacity=new Int32Array(f),a=function(e,t,i,s,r,l,a){let n=t[s++];for(let h=0;h<n;h++){let n=new N(l,a);n.xTile=t[s++],n.yTile=t[s++],n.hash=t[s++],n.priority=t[s++],n.featureIndex=t[s++];let h=t[s++];for(let e=0;e<h;e++){let e=t[s++],r=t[s++],l=t[s++],a=t[s++],h=!!t[s++],o=t[s++],u=i[s++],c=i[s++],_=t[s++],d=t[s++];n.colliders.push({xTile:e,yTile:r,dxPixels:l,dyPixels:a,hard:h,partIndex:o,width:_,height:d,minLod:u,maxLod:c})}let o=e[s++];for(let t=0;t<o;t++)n.textVertexRanges.push([e[s++],e[s++]]);let u=e[s++];for(let t=0;t<u;t++)n.iconVertexRanges.push([e[s++],e[s++]]);r.push(n)}return s}(s,r,l,a,this.symbols,i,u),this.bufferDataOffset=a}get usedMemory(){return(this.data?.byteLength??0)+(this.iconVAO?.cachedMemory??0)+(this.textVAO?.cachedMemory??0)+(0,z.Qf)(this.iconOpacity)+(0,z.Qf)(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let e=0;for(let t of this.iconPerPageElementsMap.values())e+=t[1];for(let t of this.glyphPerPageElementsMap.values())e+=t[1];return e/3}doDestroy(){this.iconVAO=(0,a.WD)(this.iconVAO),this.textVAO=(0,a.WD)(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;let e=this.iconOpacity,t=this.iconVAO.vertexBuffers.get("opacity");e.length>0&&e.byteLength===t.usedMemory&&t.setSubData(e,0,0,e.length);let i=this.textOpacity,s=this.textVAO.vertexBuffers.get("opacity");i.length>0&&i.byteLength===s.usedMemory&&s.setSubData(i,0,0,i.length)}doPrepareForRendering(e,t,i){let s=new Uint32Array(t),r=new Int32Array(s.buffer),l=s[i++],a=G.g.createVertex(e,x._U.STATIC_DRAW,new Int32Array(r.buffer,4*i,l));i+=l;let n=s[i++],h=G.g.createIndex(e,x._U.STATIC_DRAW,new Uint32Array(s.buffer,4*i,n));i+=n;let o=s[i++],u=G.g.createVertex(e,x._U.STATIC_DRAW,new Int32Array(r.buffer,4*i,o));i+=o;let c=s[i++],_=G.g.createIndex(e,x._U.STATIC_DRAW,new Uint32Array(s.buffer,4*i,c));i+=c;let d=G.g.createVertex(e,x._U.STATIC_DRAW,this.iconOpacity.buffer),y=G.g.createVertex(e,x._U.STATIC_DRAW,this.textOpacity.buffer),f=this.layer,p=f.iconMaterial,g=f.textMaterial;this.iconVAO=new X.Z(e,p.getAttributeLocations(),p.getLayoutInfo(),new Map([["geometry",a],["opacity",d]]),h),this.textVAO=new X.Z(e,g.getAttributeLocations(),g.getLayoutInfo(),new Map([["geometry",u],["opacity",y]]),_)}}class Z extends J{constructor(e,t){super(e,t),this.type=y.NP.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;let i=new Uint32Array(e),s=this.bufferDataOffset;this.circleIndexStart=i[s++],this.circleIndexCount=i[s++],this.bufferDataOffset=s}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.cachedMemory??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=(0,a.WD)(this.vao)}doPrepareForRendering(e,t,i){let s=new Uint32Array(t),r=new Int32Array(s.buffer),l=s[i++],a=G.g.createVertex(e,x._U.STATIC_DRAW,new Int32Array(r.buffer,4*i,l));i+=l;let n=s[i++],h=G.g.createIndex(e,x._U.STATIC_DRAW,new Uint32Array(s.buffer,4*i,n));i+=n;let o=this.layer.circleMaterial;this.vao=new X.Z(e,o.getAttributeLocations(),o.getLayoutInfo(),new Map([["geometry",a]]),h)}}var ee=i(37724),et=i(26199);class ei extends et.Y{constructor(e,t,i,s,r,l,a,n=null){super(e,t,i,s,r,l,4096,4096),this.styleRepository=a,this._memCache=n,this.type="vector-tile",this._referenced=1,this._hasSymbolBuckets=!1,this._usedMemory=256,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this.featureIndex=null,this.triangleCount=0,this._processed=!1,this.id=e.id}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<ee.zk}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<ee.zk)}get wasRequested(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(e){let t=!1;for(let i of e){let e=this.layerData.get(i);e&&(this._usedMemory-=e.usedMemory,e.type===y.NP.SYMBOL&&this.symbols.delete(i)&&(t=!0),e.destroy(),this.layerData.delete(i))}this._memCache?.updateSize(this.key.id,this),t&&(this.featureIndex?.clear(),this.emit("symbols-changed")),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}hasFeatures(){for(let e of this.layerData.values())if(e.hasData())return!0;return!1}dispose(){"unloaded"!==this.status&&(ei._destroyRenderBuckets(this.layerData),this.layerData.clear(),this.featureIndex=null,this._usedMemory=0,this.destroy(),this.status="unloaded")}release(){0==--this._referenced&&(this.dispose(),this.stage=null)}retain(){++this._referenced}get cachedMemory(){return this._usedMemory}get usedMemory(){return this._usedMemory}get usedMemoryPerReference(){return this._usedMemory/(this._referenced||1)}changeDataImpl(e){this.featureIndex?.clear();let t=!1;if(e){let{bucketsWithData:i,emptyBuckets:s}=e,r=this._createRenderBuckets(i);if(s&&s.byteLength>0)for(let e of new Uint32Array(s))this._deleteLayerData(e);for(let[e,i]of r)this._deleteLayerData(e),i.type===y.NP.SYMBOL&&(this.symbols.set(e,i.symbols),t=!0),this._usedMemory+=i.usedMemory,this.layerData.set(e,i);this._memCache?.updateSize(this.key.id,this)}for(let e of(this._hasSymbolBuckets=!1,this.layerData.values()))e.type===y.NP.SYMBOL&&(this._hasSymbolBuckets=!0);t&&this.emit("symbols-changed")}attachWithContext(e){this.stage={context:e,trashDisplayObject(e){e.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e){super.setTransform(e);let t=this.resolution/(e.resolution*e.pixelRatio),i=this.width/this.rangeX*t,s=this.height/this.rangeY*t,r=[0,0];e.toScreen(r,[this.x,this.y]);let l=this.transforms.tileUnitsToPixels;(0,V.D_)(l),(0,V.Tl)(l,l,r),(0,V.e$)(l,l,Math.PI*e.rotation/180),(0,V.hs)(l,l,[i,s,1])}_createTransforms(){return{displayViewScreenMat3:(0,F.vt)(),tileMat3:(0,F.vt)(),tileUnitsToPixels:(0,F.vt)()}}static _destroyRenderBuckets(e){if(!e)return;let t=new Set;for(let i of e.values())t.has(i)||(i.destroy(),t.add(i));e.clear()}_createRenderBuckets(e){let t=new Map,i=new Map;for(let s of e){let e=this._deserializeBucket(s,i);for(let i of e.layerUIDs)t.set(i,e)}return t}_deserializeBucket(e,t){let i=t.get(e);if(i)return i;switch(new Uint32Array(e)[0]){case y.NP.FILL:i=new K(e,this.styleRepository);break;case y.NP.LINE:i=new $(e,this.styleRepository);break;case y.NP.SYMBOL:i=new j(e,this.styleRepository,this);break;case y.NP.CIRCLE:i=new Z(e,this.styleRepository)}return t.set(e,i),i}_deleteLayerData(e){if(!this.layerData.has(e))return;let t=this.layerData.get(e);this._usedMemory-=t.usedMemory,t.destroy(),this.layerData.delete(e)}}var es=i(33768),er=i(22303),el=i(54101);class ea{constructor(e,t,i,s,r,l){for(let a of(this._symbols=e,this._styleRepository=s,this._zoom=r,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new Q(t,i,ee.o2),this._si=Math.sin(Math.PI*l/180),this._co=Math.cos(Math.PI*l/180),e))for(let e of a.symbols)this._allNeededMatrices.has(e.tile)||this._allNeededMatrices.set(e.tile,(0,F.o8)(e.tile.transforms.tileUnitsToPixels))}work(e){let t=this._gridIndex,i=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){let s=this._symbols[this._currentLayerCursor],r=this._getProperties(s.styleLayerUID);for(;this._currentSymbolCursor<s.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-i>e)return!1;let l=s.symbols[this._currentSymbolCursor];if(!l.unique.show)continue;!function(e,t,i,s,r,l){let{iconRotationAlignment:a,textRotationAlignment:n,iconTranslate:h,iconTranslateAnchor:o,textTranslate:u,textTranslateAnchor:c}=s,_=0;for(let s of e.colliders){let[e,d]=0===s.partIndex?h:u,y=0===s.partIndex?o:c,f=s.minLod<=l&&l<=s.maxLod;_+=+!f,s.enabled=f,s.xScreen=s.xTile*r[0]+s.yTile*r[3]+r[6],s.yScreen=s.xTile*r[1]+s.yTile*r[4]+r[7],y===el.Cq.MAP?(s.xScreen+=i*e-t*d,s.yScreen+=t*e+i*d):(s.xScreen+=e,s.yScreen+=d),el.I5.VIEWPORT===(0===s.partIndex?a:n)?(s.dxScreen=s.dxPixels,s.dyScreen=s.dyPixels):(s.dxScreen=i*(s.dxPixels+s.width/2)-t*(s.dyPixels+s.height/2)-s.width/2,s.dyScreen=t*(s.dxPixels+s.width/2)+i*(s.dyPixels+s.height/2)-s.height/2)}e.colliders.length>0&&_===e.colliders.length&&(e.unique.show=!1)}(l,this._si,this._co,r,this._allNeededMatrices.get(l.tile),this._zoom);let a=l.unique;if(!a.show)continue;let{iconAllowOverlap:n,iconIgnorePlacement:h,textAllowOverlap:o,textIgnorePlacement:u}=r;for(let e of l.colliders){if(!e.enabled)continue;let i=a.parts[e.partIndex];i.show&&!(e.partIndex?o:n)&&function(e){let i=e.xScreen+e.dxScreen,s=e.yScreen+e.dyScreen,r=i+e.width,l=s+e.height,[a,n,h,o]=t.getCellSpan(i,s,r,l);for(let e=n;e<=o;e++)for(let n=a;n<=h;n++)for(let a of t.cells[e][n]){let e=a.xScreen+a.dxScreen,t=a.yScreen+a.dyScreen,n=e+a.width,h=t+a.height;if(!(r<e||i>n||l<t||s>h))return!0}return!1}(e)&&(e.hard?a.show=!1:i.show=!1)}if(a.show)for(let e of l.colliders){if(!e.enabled||(e.partIndex?u:h)||!a.parts[e.partIndex].show)continue;let t=e.xScreen+e.dxScreen,i=e.yScreen+e.dyScreen,s=t+e.width,r=i+e.height,[l,n,o,c]=this._gridIndex.getCellSpan(t,i,s,r);for(let t=n;t<=c;t++)for(let i=l;i<=o;i++)this._gridIndex.cells[t][i].push(e)}}}return!0}_getProperties(e){let t=this._styleProps.get(e);if(t)return t;let i=this._zoom,s=this._styleRepository.getStyleLayerByUID(e),r=s.getLayoutValue("symbol-placement",i)!==el.kt.POINT,l=s.getLayoutValue("icon-rotation-alignment",i);l===el.I5.AUTO&&(l=r?el.I5.MAP:el.I5.VIEWPORT);let a=s.getLayoutValue("text-rotation-alignment",i);a===el.I5.AUTO&&(a=r?el.I5.MAP:el.I5.VIEWPORT);let n=s.getPaintValue("icon-translate",i),h=s.getPaintValue("icon-translate-anchor",i),o=s.getPaintValue("text-translate",i),u=s.getPaintValue("text-translate-anchor",i),c={iconAllowOverlap:s.getLayoutValue("icon-allow-overlap",i),iconIgnorePlacement:s.getLayoutValue("icon-ignore-placement",i),textAllowOverlap:s.getLayoutValue("text-allow-overlap",i),textIgnorePlacement:s.getLayoutValue("text-ignore-placement",i),iconRotationAlignment:l,textRotationAlignment:a,iconTranslateAnchor:h,iconTranslate:n,textTranslateAnchor:u,textTranslate:o};return this._styleProps.set(e,c),c}}function en(e,t){if(e.priority-t.priority)return e.priority-t.priority;let i=e.tile.key,s=t.tile.key;return i.world-s.world?i.world-s.world:i.level-s.level?i.level-s.level:i.row-s.row?i.row-s.row:i.col-s.col?i.col-s.col:e.xTile-t.xTile?e.xTile-t.xTile:e.yTile-t.yTile}class eh{get running(){return this._running}constructor(e,t,i,s,r,l){this._visibleTiles=e,this._symbolRepository=t,this._createCollisionJob=i,this._assignTileSymbolsOpacity=s,this._symbolLayerSorter=r,this._isLayerVisible=l,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(e,t){this._screenWidth===e&&this._screenHeight===t||this.restart(),this._screenWidth=e,this._screenHeight=t}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){let t=performance.now();if(!this._selectionJob.work(e)||(this._selectionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t)))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){let t=performance.now();if(!this._collisionJob.work(e)||(this._collisionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t)))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){let t=performance.now();if(!this._opacityJob.work(e)||(this._opacityJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t)))))return!1}return this._running=!1,!0}_createSelectionJob(){let e=this._symbolRepository.uniqueSymbols;for(let t=0;t<e.length;t++){let i=e[t];for(let e=0;e<i.uniqueSymbols.length;e++)for(let t of i.uniqueSymbols[e].tileSymbols)t.selectedForRendering=!1}let t=[],i=0,s=0,r=this._isLayerVisible,l=this._symbolLayerSorter;return{work:function(l){let a,n=performance.now();for(;s<e.length;s++,i=0){let h=e[s],o=h.styleLayerUID;if(!r(o)){t[s]||(t[s]={styleLayerUID:o,symbols:[]});continue}t[s]=t[s]||{styleLayerUID:o,symbols:[]};let u=t[s];for(;i<h.uniqueSymbols.length;i++){if(a=h.uniqueSymbols[i],i%100==99&&performance.now()-n>l)return!1;let e=null,t=!1,s=!1;for(let i of a.tileSymbols)if(!s||!t){let r=i.tile;(!e||r.isCoverage||r.neededForCoverage&&!t)&&(e=i,(r.neededForCoverage||r.isCoverage)&&(s=!0),r.isCoverage&&(t=!0))}if(e.selectedForRendering=!0,s)for(let t of(u.symbols.push(e),a.show=!0,a.parts))t.show=!0;else a.show=!1}}for(let e of t)e.symbols.sort(en);return!0},get sortedSymbols(){return t.sort(l)}}}_createOpacityJob(){let e=this._assignTileSymbolsOpacity,t=this._visibleTiles,i=0;return{work(s){let r=performance.now();for(;i<t.length;i++){if(performance.now()-r>s)return!1;let l=t[i];null==l.parentTile&&function t(i,s){for(let e of i.symbols.values()){var r=e,l=s;for(let e of r){let t=e.unique;for(let e of t.parts){let i=e.targetOpacity>.5?1:-1;e.startOpacity+=i*((l-e.startTime)/ee.zk),e.startOpacity=Math.min(Math.max(e.startOpacity,0),1),e.startTime=l,e.targetOpacity=t.show&&e.show?1:0}}}for(let r of(e(i,s),i.childrenTiles))t(r,s)}(l,performance.now())}return!0}}}}class eo{constructor(e,t,i){this.tileCoordRange=e,this._visibleTiles=t,this._createUnique=i,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}get uniqueSymbols(){return null==this._uniqueSymbolLayerArray&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}get uniqueSymbolsReferences(){return this._uniqueSymbolsReferences}add(e,t){this._uniqueSymbolLayerArray=null;let i=this._tiles.get(e.id);i||(i={symbols:new Map},this._tiles.set(e.id,i));let s=new Map;if(t)for(let e of t)i.symbols.has(e)&&(s.set(e,i.symbols.get(e)),i.symbols.delete(e));else for(let[t,r]of e.layerData)i.symbols.has(t)&&(s.set(t,i.symbols.get(t)),i.symbols.delete(t));this._removeSymbols(s);let r=e.symbols,l=new Map;for(let[e,t]of r){let s=t.length;if(s>=32){let r=this.tileCoordRange;do r/=2,s/=4;while(s>8&&r>64);let a=new Q(this.tileCoordRange,this.tileCoordRange,r);for(let s of(l.set(e,{flat:t,index:a}),i.symbols.set(e,{flat:t,index:a}),t))a.getCell(s.xTile,s.yTile).push(s)}else l.set(e,{flat:t}),i.symbols.set(e,{flat:t})}this._addSymbols(e.key,r)}deleteStyleLayers(e){for(let[t,i]of(this._uniqueSymbolLayerArray=null,this._tiles)){let s=new Map;for(let t of e)i.symbols.has(t)&&(s.set(t,i.symbols.get(t)),i.symbols.delete(t));this._removeSymbols(s),0===i.symbols.size&&this._tiles.delete(t)}}removeTile(e){this._uniqueSymbolLayerArray=null;let t=this._tiles.get(e.id);if(!t)return;let i=new Map;for(let[s,r]of e.symbols)t.symbols.has(s)&&(i.set(s,t.symbols.get(s)),t.symbols.delete(s));this._removeSymbols(i),0===t.symbols.size&&this._tiles.delete(e.id)}querySymbols(e,t,i,s){let r=[];for(let s of this.uniqueSymbols){let l=s.styleLayerUID;for(let a of s.uniqueSymbols){let s=a.tileSymbols.find(e=>e.selectedForRendering);s&&function(e,t,i,s){let r,l,a,n;for(let h of e.colliders)if(e.unique.show&&e.unique.parts[h.partIndex].show&&(r=h.xScreen-s[0]+h.dxScreen,l=h.yScreen-s[1]+h.dyScreen,a=r+h.width,n=l+h.height,(0,H.w4)(i,t.x,t.y,r,l,a,n)))return!0;return!1}(s,e,t*(window.devicePixelRatio||1),i)&&r.push({vtlSymbol:s,styleLayerUID:l,tileKey:s.tile.key})}}return r}_removeSymbols(e){for(let[t,{flat:i}]of e)for(let e of i){let i=e.unique,s=i.tileSymbols,r=s.length-1;for(let t=0;t<r;t++)if(s[t]===e){s[t]=s[r];break}if(s.length=r,0===r){let e=this._uniqueSymbolsReferences.get(t);e.delete(i),0===e.size&&this._uniqueSymbolsReferences.delete(t)}e.unique=null}}_addSymbols(e,t){if(0!==t.size){for(let i of this._visibleTiles)i.parentTile||i.key.world!==e.world||i.key.level===e.level&&!i.key.equals(e)||this._matchSymbols(i,e,t);for(let[e,i]of t)for(let t of i)if(null==t.unique){let i=this._createUnique();t.unique=i,i.tileSymbols.push(t);let s=this._uniqueSymbolsReferences.get(e);s||(s=new Set,this._uniqueSymbolsReferences.set(e,s)),s.add(i)}}}_matchSymbols(e,t,i){if(e.key.level>t.level){let i=e.key.level-t.level;if(e.key.row>>i!==t.row||e.key.col>>i!==t.col)return}if(t.level>e.key.level){let i=t.level-e.key.level;if(t.row>>i!==e.key.row||t.col>>i!==e.key.col)return}if(t.equals(e.key)){for(let s of e.childrenTiles)this._matchSymbols(s,t,i);return}let s=new Map;for(let[r,l]of i){let i=[];for(let s of l){let r=W(this.tileCoordRange,s.xTile,t.level,t.col,e.key.level,e.key.col),l=W(this.tileCoordRange,s.yTile,t.level,t.row,e.key.level,e.key.row);r>=0&&r<this.tileCoordRange&&l>=0&&l<this.tileCoordRange&&i.push({symbol:s,xTransformed:r,yTransformed:l})}let a=[],n=(e.key.level<t.level?1:1<<e.key.level-t.level)+20,h=this._tiles.get(e.id).symbols.get(r);if(h){let e=h.flat;for(let t of i){let i,s=!1,r=t.xTransformed,l=t.yTransformed;i=null!=h.index?h.index.getCell(r,l):e;let o=t.symbol,u=o.hash;for(let e of i)if(u===e.hash&&Math.abs(r-e.xTile)<=n&&Math.abs(l-e.yTile)<=n){let t=e.unique;o.unique=t,t.tileSymbols.push(o),s=!0;break}s||a.push(o)}}a.length>0&&s.set(r,a)}for(let i of e.childrenTiles)this._matchSymbols(i,t,s)}_createUniqueSymbolLayerArray(){let e=this._uniqueSymbolsReferences,t=Array(e.size),i,s=0;for(let[r,l]of e){let e=Array(l.size);for(let t of(i=0,l))e[i++]=t;t[s]={styleLayerUID:r,uniqueSymbols:e},s++}return t}}class eu{constructor(e,t){this.styleRepository=e,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._offsetFromScreenCenter=[0,0],this._completed=!1,this._fading=(0,er.v)(!1),this._symbolRepository=new eo(4096,t,()=>new Y),this._symbolDeclutterer=new eh(t,this._symbolRepository,(e,t,i)=>this._createCollisionJob(e,t,i),(e,t)=>{e.allSymbolsFadingOut=!0,e.lastOpacityUpdate=t,function(e,t,i){for(let[s,r]of e.symbols)!function(e,t,i,s,r){let l=e.layerData.get(r);if(l.type===y.NP.SYMBOL){for(let t of s){let s,r=t.unique;if(t.selectedForRendering){let t=r.parts[0],l=t.startOpacity,a=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===a;let n=i?Math.floor(127*l)|a<<7:255*!!a;s=n<<24|n<<16|n<<8|n}else s=0;for(let[e,i]of t.iconVertexRanges)for(let t=e;t<e+i;t+=4)l.iconOpacity[t/4]=s;if(t.selectedForRendering){let t=r.parts[1],l=t.startOpacity,a=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===a;let n=i?Math.floor(127*l)|a<<7:255*!!a;s=n<<24|n<<16|n<<8|n}else s=0;for(let[e,i]of t.textVertexRanges)for(let t=e;t<e+i;t+=4)l.textOpacity[t/4]=s}l.lastOpacityUpdate=t,l.opacityChanged=!0}}(e,t,i,r,s)}(e,t,!0),e.decluttered=!0,e.requestRender()},(e,t)=>this.styleRepository.getStyleLayerByUID(e.styleLayerUID).z-this.styleRepository.getStyleLayerByUID(t.styleLayerUID).z,e=>{let t=this.styleRepository.getStyleLayerByUID(e);if(this._zoom+1e-6<t.minzoom||this._zoom-1e-6>=t.maxzoom)return!1;let i=t.getLayoutProperty("visibility");return!i||i.getValue()!==el.bv.NONE})}get symbolRepository(){return this._symbolRepository}_createCollisionJob(e,t,i){return this.updateDecluttererViewState(),new ea(e,t,i,this.styleRepository,this._zoom,this._viewState.rotation)}get fading(){return this._fading.value}get decluttererOffset(){return this._offsetFromScreenCenter}addTile(e){e.decluttered=!1,this._tileToHandle.set(e,e.on("symbols-changed",()=>{this._symbolRepository.add(e),this.restartDeclutter()})),this._symbolRepository.add(e),this.restartDeclutter()}removeTile(e){let t=this._tileToHandle.get(e);t&&(this._symbolRepository.removeTile(e),this.restartDeclutter(),t.remove(),this._tileToHandle.delete(e))}update(e,t){this._zoom=e,this._viewState={scale:t.scale,rotation:t.rotation,center:[t.center[0],t.center[1]],size:[t.size[0],t.size[1]]};let i=[0,0];t.toScreen(i,t.center);let s=[0,0];return t.toScreen(s,this._declutterViewState.center),this._offsetFromScreenCenter[0]=i[0]-s[0],this._offsetFromScreenCenter[1]=i[1]-s[1],this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach(e=>e.remove()),this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(e){this._symbolRepository.deleteStyleLayers(e)}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this.updateDecluttererViewState(),this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(ee.av),this._completed&&this._scheduleNotifyStable())}_scheduleNotifyStable(){null!=this._stableNotificationHandle&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout(()=>{this._stableNotificationHandle=null,this._fading.value=!1},1.5*ee.zk)}_notifyUnstable(){null!=this._stableNotificationHandle&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this._fading.value=!0}updateDecluttererViewState(){this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._offsetFromScreenCenter[0]=0,this._offsetFromScreenCenter[1]=0}}var ec=i(52548);class e_ extends et.Y{_createTransforms(){return{displayViewScreenMat3:(0,F.vt)(),tileMat3:(0,F.vt)()}}}var ed=i(50217);function ey(e,t){if(e){let i=e.getLayoutProperty("visibility");if(!i||i.getValue()!==el.bv.NONE&&(void 0===e.minzoom||e.minzoom<t+1e-6)&&(void 0===e.maxzoom||e.maxzoom>=t-1e-6))return!0}return!1}class ef extends ed.A{constructor(e){super(e),this._backgroundTiles=[],this._computeDisplayInfoView(e)}destroy(){this.removeAllChildren(),this._spriteMosaic?.dispose(),this._spriteMosaic=null,this._glyphMosaic?.dispose(),this._glyphMosaic=null,null!=this._symbolFader&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[]}get fading(){return this._symbolFader?.fading??!1}get symbolFader(){return this._symbolFader}get symbolRepository(){return this._symbolFader?.symbolRepository}setStyleResources(e,t,i,s){this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=i,this.tileInfoView=s,this._computeDisplayInfoView(s),null==this._symbolFader&&(this._symbolFader=new eu(this._styleRepository,this.children)),this._symbolFader.styleRepository=i}setSpriteMosaic(e){this._spriteMosaic?.dispose(),this._spriteMosaic=e}deleteStyleLayers(e){null!=this._symbolFader&&this._symbolFader.deleteStyleLayers(e)}createRenderParams(e){return{...super.createRenderParams(e),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}}doRender(e){this.visible&&(e.drawPhase===ec.S5.MAP||e.drawPhase===ec.S5.DEBUG)&&void 0!==this._spriteMosaic&&super.doRender(e)}addChild(e){return super.addChild(e),null!=this._symbolFader?this._symbolFader.addTile(e):e.decluttered=!0,this.requestRender(),e}removeChild(e){return null!=this._symbolFader&&this._symbolFader.removeTile(e),this.requestRender(),super.removeChild(e)}renderChildren(e){let{drawPhase:t}=e;t!==ec.S5.DEBUG?this._doRender(e):super.renderChildren(e)}removeAllChildren(){for(let e=0;e<this.children.length;e++){let t=this.children[e];null!=this._symbolFader&&this._symbolFader.removeTile(t),t.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter(e=>e.neededForCoverage&&e.hasData())}restartDeclutter(){null!=this._symbolFader&&this._symbolFader.restartDeclutter()}_doRender(e){let{context:t,state:i}=e,s=this._styleRepository;if(!s)return;let r=s.layers,l=this._displayInfo.scaleToZoom(i.scale);s.backgroundBucketIds.length>0&&(e.renderPass="background",this._renderBackgroundLayers(e,s.backgroundBucketIds,l)),super.renderChildren(e),e.drawPhase===ec.S5.MAP&&this._fade(l,i);let a=this.children.filter(e=>e.visible&&e.hasData());if(!a||0===a.length)return t.bindVAO(),t.setStencilTestEnabled(!0),void t.setBlendingEnabled(!0);for(let e of a)e.triangleCount=0;t.setStencilWriteMask(0),t.setColorMask(!0,!0,!0,!0),t.setStencilOp(x.eA.KEEP,x.eA.KEEP,x.eA.REPLACE),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setDepthTestEnabled(!0),t.setDepthWriteEnabled(!0),t.setDepthFunction(x.MT.LEQUAL),t.setClearDepth(1),t.clear(t.gl.DEPTH_BUFFER_BIT),e.renderPass="opaque";for(let t=r.length-1;t>=0;t--)this._renderStyleLayer(r[t],e,a);t.setDepthWriteEnabled(!1),t.setBlendingEnabled(!0),t.setBlendFunctionSeparate(x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA,x.dn.ONE,x.dn.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let t=0;t<r.length;t++)this._renderStyleLayer(r[t],e,a);for(let e of(t.bindVAO(),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!0),a))e.debugInfo.display.triangleCount=e.triangleCount}_fade(e,t){null!=this._symbolFader&&(this._symbolFader.update(e,t)||this.requestRender())}_renderStyleLayer(e,t,i){let s,{displayLevel:r,painter:l,renderPass:a}=t;if(void 0===e)return;let n=e.getLayoutProperty("visibility");if(n&&n.getValue()===el.bv.NONE)return;switch(e.type){case el.Dc.BACKGROUND:return;case el.Dc.FILL:if("opaque"!==a&&"translucent"!==t.renderPass)return;s="vtlFill";break;case el.Dc.LINE:if("translucent"!==a)return;s="vtlLine";break;case el.Dc.CIRCLE:if("translucent"!==a)return;s="vtlCircle";break;case el.Dc.SYMBOL:if("translucent"!==a)return;s="vtlSymbol"}if(i=e.type===el.Dc.SYMBOL?i.filter(e=>e.decluttered):i.filter(e=>e.neededForCoverage),"vtlSymbol"!==s&&(0===i.length||void 0!==e.minzoom&&e.minzoom>=r+1e-6||void 0!==e.maxzoom&&e.maxzoom<r-1e-6))return;let h=e.uid;for(let r of(t.styleLayerUID=h,t.styleLayer=e,i))if(r.layerData.has(h)){l.renderObjects(t,i,s);break}}_renderBackgroundLayers(e,t,i){let{context:s,painter:r,state:l}=e,a=this._styleRepository,n=!1;for(let e of t)if(a.getLayerById(e).type===el.Dc.BACKGROUND&&ey(a.getLayerById(e),i)){n=!0;break}if(!n)return;let h=this.tileInfoView,o=h.getTileCoverage(e.state,0,!0,"smallest"),{spans:u,lodInfo:c}=o,{level:d}=c,y=(0,_.vt)(),f=[];if(this._renderPasses){let t=this._renderPasses[0];null!=this._clippingInfos&&(t.brushes[0].prepareState(e),t.brushes[0].drawMany(e,this._clippingInfos))}let p=this._backgroundTiles,g,m=0;for(let{row:e,colFrom:t,colTo:i}of u)for(let s=t;s<=i;s++){if(m<p.length)(g=p[m]).key.set(d,e,c.normalizeCol(s),c.getWorldForColumn(s)),h.getTileBounds(y,g.key,!1),g.x=y[0],g.y=y[3],g.resolution=h.getTileResolution(d);else{let t=new P.A(d,e,c.normalizeCol(s),c.getWorldForColumn(s)),i=h.getTileBounds((0,_.vt)(),t);g=new e_(t,h.getTileResolution(d),i[0],i[3],512,512,4096,4096),p.push(g)}g.setTransform(l),f.push(g),m++}for(let l of(s.setStencilWriteMask(0),s.setColorMask(!0,!0,!0,!0),s.setStencilOp(x.eA.KEEP,x.eA.KEEP,x.eA.REPLACE),s.setStencilFunction(x.MT.EQUAL,0,255),s.setStencilTestEnabled(!0),t)){let t=a.getLayerById(l);t.type===el.Dc.BACKGROUND&&ey(t,i)&&(e.styleLayerUID=t.uid,e.styleLayer=t,r.renderObjects(e,f,"vtlBackground"))}U.A.pool.release(o)}_computeDisplayInfoView(e){let t=e.tileInfo.lods[0].scale,i=Math.max(25,e.tileInfo.lods.length),s=[];for(let e=0;e<=i;e++)s.push(t),t/=2;this._displayInfo=es.A.create({scales:s,size:512,spatialReference:e.spatialReference,numLODs:i})}}var ep=i(97135),eg=i(90304),em=i(2370),ex=i(82489),ew=i(16573),eb=i(64818);let eS=(e,t)=>{let i=e.vtlSymbol.sourceTile,s=t.vtlSymbol.sourceTile;return i.level!==s.level?i.level-s.level:i.row!==s.row?i.row-s.row:i.col!==s.col?i.col-s.col:e.styleLayerUID-t.styleLayerUID};class ev{constructor(e,t,i,s,r){this.tileKey=e,this._tileLayerData=t,this._styleRepository=i,this._tileHandler=s,this._parentLayer=r,this._index=null,this._tileKeyToPBF=new Map}static create(e,t,i,s,r){return new ev(e,t,i,s,r)}clear(){this._index?.clear(),this._tileKeyToPBF.clear()}async queryAttributes(e,t,i,s,r){if(0===this._tileLayerData.size||!this._styleRepository||!this._tileHandler)return[];null===this._index&&(this._index=new em.w(100,eI),await this._indexLayers());let l=[];return this._queryIndex(l,e,t,i,this.tileKey.level,s),r&&r?.length>0&&await this._getSymbolsAttributes(l,r),l}async _indexLayers(){let e=this.tileKey,t=this._styleRepository.layers,i=await this._getTilePayload(e);for(let[s,r]of this._tileLayerData){let l=t[s],a=i.find(e=>e.sourceName===l.source);if(!a)continue;let{protobuff:n,key:h}=a;if(r.type!==y.NP.SYMBOL){let t=1<<e.level-h.level,i=e.row-h.row*t,s=e.col-h.col*t;this._indexLayer(l,n,e.level,t,i,s)}}}_indexLayer(e,t,i,s,r,l){let a=e.sourceLayer,n=e.getFeatureFilter(),h=i+1,o=(0,H.IU)(i),u=new I.A(new Uint8Array(t),new DataView(t));for(;u.next();)if(3===u.tag()){let t=u.getMessage(),c=new ew.A(t);if(t.release(),c.name!==a)continue;let _=c.getData(),d=c.extent/s,y=d*l-o,f=d*r-o,p=y+d+2*o,g=f+d+2*o,m=d/512,x=4096/d,w=d*l,b=d*r;for(;_.nextTag(2);){let t=_.getMessage(),s=new ex.A(t,c);if(t.release(),n&&!n.filter(s,i))continue;let r=s.values||{},l=r._minzoom,a=r._maxzoom;if(l&&l>=10*h||a&&a<=10*i)continue;let o=e.getFeatureInflatedBounds(s,i,c.extent,m);null==o||o[0]>p||o[1]>g||o[2]<y||o[3]<f||(o[0]=(o[0]-w)*x,o[1]=(o[1]-b)*x,o[2]=(o[2]-w)*x,o[3]=(o[3]-b)*x,this._index.insert(new eb.e4(e,s,o,x,w,b)))}}else u.skip()}async _getSymbolsAttributes(e,t){if(!t||0===t.length)return e;let i=[];t.sort(eS);let s=t[0].styleLayerUID,r=0;for(let e=0;e<t.length;e++)s!==t[e].styleLayerUID&&(i.push({from:r,to:e,styleLayerUID:s,sourceTileKey:t[e].vtlSymbol.sourceTile}),r=e,s=t[e].styleLayerUID);i.push({from:r,to:t.length,styleLayerUID:s,sourceTileKey:t[t.length-1].vtlSymbol.sourceTile});let l=this._styleRepository.layers;for(let r of i){let i=await this._getTilePayload(r.sourceTileKey),a=l[r.styleLayerUID],n=!!a&&i.find(e=>e.sourceName===a.source);n&&this._addSymbolsAttributes(e,t.slice(r.from,r.to).map(e=>e.vtlSymbol),s,n)}return e}_addSymbolsAttributes(e,t,i,s){let r=this._styleRepository.layers,l=s.key,a=this.tileKey,n=1<<a.level-l.level,h=a.row-l.row*n,o=a.col-l.col*n;this._getSymbolAttributes(s.protobuff,t,i,n,h,o).forEach(t=>{let{attributes:s,tilePoint:l}=t;e.push({layerId:r[i].id,layerIndex:i,graphic:new ep.A({attributes:s,origin:{type:"vector-tile",layerId:r[i].id,layerIndex:i,layer:this._parentLayer}}),tilePoint:l})})}_getSymbolAttributes(e,t,i,s,r,l){let a=[],n=this._styleRepository.layers,h=0;t.sort((e,t)=>e.featureIndex-t.featureIndex);let o=new I.A(new Uint8Array(e),new DataView(e));for(;o.next();)if(3===o.tag()){let e=o.getMessage(),u=new ew.A(e);if(e.release(),u.name!==n[i].sourceLayer)continue;let c=u.getData(),_=u.extent/s,d=4096/_,y=_*l,f=_*r,p=0;for(;c.nextTag(2);){let e=c.getMessage();if(p++===t[h].featureIndex){let t=new ex.A(e,u),i=t.values,s=t.getGeometry(),r=null!=s?[d*(s[0][0].x-y),d*(s[0][0].y-f)]:null;a.push({attributes:i,tilePoint:r}),h++}if(e.release(),h===t.length)return a}}else o.skip();return a}_queryIndex(e,t,i,s,r,l){let a=8*s*(window.devicePixelRatio||1);return this._index?.search({minX:t-a,minY:i-a,maxX:t+a,maxY:i+a},a=>{let{layer:n,feature:h}=a;n.isIntersectingFeature(t,i,s,h,r,l,a)&&e.push({layerId:n.id,layerIndex:n.uid,tilePoint:null,graphic:new ep.A({attributes:h.values,origin:{type:"vector-tile",layerId:a.layer.id,layerIndex:a.layer.uid,layer:this._parentLayer}})})}),e}async _getTilePayload(e){return(0,eg.tE)(this._tileKeyToPBF,e.id,()=>this._tileHandler.fetchTilePBFs(e)).then(e=>e)}}let eI=e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]});var eT=i(26840),eM=i(88230);class eC extends B.A{constructor(){super(...arguments),this._fullCacheLodInfos=null,this._levelByScale={}}getTileParentId(e){let t=P.A.pool.acquire(e),i=0===t.level?null:P.A.getId(t.level-1,t.row>>1,t.col>>1,t.world);return P.A.pool.release(t),i}getTileCoverage(e,t,i=!0,s){let r=super.getTileCoverage(e,t,i,s);if(!r)return r;let l=1<<r.lodInfo.level;return r.spans=r.spans.filter(e=>e.row>=0&&e.row<l),r}scaleToLevel(e){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[e])return this._levelByScale[e];{let t,i,s=this._fullCacheLodInfos;if(e>s[0].scale)return s[0].level;for(let r=0;r<s.length-1;r++)if(e>(i=s[r+1]).scale)return(t=s[r]).level+(t.scale-e)/(t.scale-i.scale);return s[s.length-1].level}}_initializeFullCacheLODs(e){let t;if(0===e[0].level)t=e.map(e=>({level:e.level,resolution:e.resolution,scale:e.scale}));else{let e=this.tileInfo.size[0],i=this.tileInfo.spatialReference;t=es.A.create({size:e,spatialReference:i}).lods.map(e=>({level:e.level,resolution:e.resolution,scale:e.scale}))}for(let e=0;e<t.length;e++)this._levelByScale[t[e].scale]=t[e].level;this._fullCacheLodInfos=t}}var eA=i(85511),eD=i(80468),eR=i(25451);let eP=class extends(0,eD.A)((0,eM.e)(eA.A)){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._styeChanged=!1,this._spriteSourceChanged=!1}get fading(){return this._vectorTileContainer?.fading??!1}get hasVisibleFeatures(){for(let e of this._vectorTileContainer.children)if(e.hasFeatures())return!0;return!1}get spriteSourceChanged(){return this._spriteSourceChanged}get styleChanged(){return this._styeChanged}async hitTest(e,t){let i=this._tileHandlerPromise,s=this._vectorTileContainer?.symbolFader;if(!i||!this._isTileHandlerReady||!s)return;await i;let r=null,l=this._vectorTileContainer?.symbolRepository;l&&(r=l.querySymbols(t,2,s.decluttererOffset,{}));let a=this.view.state,n=this._tileManager.getIntersectingTiles(t.x,t.y,2,a,r);if((!n||0===n.length)&&0===r?.length)return null;e=e.clone().normalize();let h=[],o=[];for(let t of n)h.push(this._queryTile(o,e,2,this.view.state.rotation,t,r?.filter(e=>e.tileKey.id===t.id)));return await Promise.all(h),o}update(e){if(this._tileHandlerPromise&&this._isTileHandlerReady)return e.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=e.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._pauseQueues(),this._fetchQueue.state=e.state,this._parseQueue.state=e.state,this._tileManager.update(e)||this.requestUpdate(),this._resumeQueues()))}attach(){let{style:e}=this.layer.currentStyleInfo;this._styleRepository=new eT.A(e),this._tileInfoView=new eC(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new ef(this._tileInfoView),this._tileHandler=new L(this.layer,this._styleRepository,window.devicePixelRatio||1,this.layer.tileInfo.lods.length-1),this.container.addChild(this._vectorTileContainer),this._start(),this.addAttachHandles([this.layer.on("paint-change",e=>{if(this._styeChanged=!0,e.isDataDriven)this._styleChanges.push({type:y.$q.PAINTER_CHANGED,data:e}),this.requestUpdate();else{let t=this._styleRepository,i=t.getLayerById(e.layer);if(!i)return;let s=i.type===el.Dc.SYMBOL;t.setPaintProperties(e.layer,e.paint),s&&this._vectorTileContainer?.restartDeclutter(),this._vectorTileContainer?.requestRender()}}),this.layer.on("layout-change",e=>{let t=this._styleRepository,i=t.getLayerById(e.layer);if(!i)return;this._styeChanged=!0;let s=(0,u.Ui)(i.layout,e.layout);if(null!=s){if((0,u.EB)(s,"visibility")&&1===function(e){if(null==e)return 0;switch(e.type){case"partial":return Object.keys(e.diff).length;case"complete":return Math.max(Object.keys(e.oldValue).length,Object.keys(e.newValue).length);case"collection":return Object.keys(e.added).length+Object.keys(e.changed).length+Object.keys(e.removed).length}}(s))return t.setLayoutProperties(e.layer,e.layout),i.type===el.Dc.SYMBOL&&this._vectorTileContainer?.restartDeclutter(),void this._vectorTileContainer?.requestRender();this._styleChanges.push({type:y.$q.LAYOUT_CHANGED,data:e}),this.requestUpdate()}}),this.layer.on("style-layer-visibility-change",e=>{let t=this._styleRepository,i=t.getLayerById(e.layer);i&&(this._styeChanged=!0,t.setStyleLayerVisibility(e.layer,e.visibility),i.type===el.Dc.SYMBOL&&this._vectorTileContainer?.restartDeclutter(),this._vectorTileContainer?.requestRender())}),this.layer.on("style-layer-change",e=>{this._styleChanges.push({type:y.$q.LAYER_CHANGED,data:e}),this._styeChanged=!0,this.requestUpdate()}),this.layer.on("delete-style-layer",e=>{this._styleChanges.push({type:y.$q.LAYER_REMOVED,data:e}),this._styeChanged=!0,this.requestUpdate()}),this.layer.on("load-style",()=>this._loadStyle()),this.layer.on("spriteSource-change",e=>{for(let t of(this._spriteSourceChanged=!0,this._styleChanges.push({type:y.$q.SPRITES_CHANGED,data:e}),this._styleRepository.layers))switch(t.type){case el.Dc.SYMBOL:t.getLayoutProperty("icon-image")&&this._styleChanges.push({type:y.$q.LAYOUT_CHANGED,data:{layer:t.id,layout:t.layout}});break;case el.Dc.LINE:t.getPaintProperty("line-pattern")&&this._styleChanges.push({type:y.$q.PAINTER_CHANGED,data:{layer:t.id,paint:t.paint,isDataDriven:t.isPainterDataDriven()}});break;case el.Dc.FILL:t.getLayoutProperty("fill-pattern")&&this._styleChanges.push({type:y.$q.PAINTER_CHANGED,data:{layer:t.id,paint:t.paint,isDataDriven:t.isPainterDataDriven()}})}this.requestUpdate()})])}detach(){this._stop(),this.container.removeAllChildren(),this._vectorTileContainer=(0,a.pR)(this._vectorTileContainer),this._tileHandler=(0,a.pR)(this._tileHandler)}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(e){return(0,d.aI)(this.layer.tileInfo?.spatialReference,e)}canResume(){let e=super.canResume(),{currentStyleInfo:t}=this.layer;if(e&&t?.layerDefinition){let i=this.view.scale,{minScale:s,maxScale:r}=t.layerDefinition;t?.layerDefinition&&(s&&s<i&&(e=!1),r&&r>i&&(e=!1))}return e}isUpdating(){return this.fading}acquireTile(e){let t=this._createVectorTile(e);return this._updatingHandles.addPromise(this._fetchQueue.push(t.key).then(e=>this._parseQueue.push({key:t.key,data:e})).then(e=>{t.once("attach",()=>this.requestUpdate()),t.setData(e),this.requestUpdate()}).catch(e=>{(0,n.zf)(e)||l.A.getLogger(this).error(e)})),t}releaseTile(e){let t=e.key.id;this._fetchQueue.abort(t),this._parseQueue.abort(t),this.requestUpdate()}async doRefresh(){if(!this.attached)return;if(this.suspended)return this._tileManager.clear(),void this.requestUpdate();this._isTileHandlerReady=!1,this._pauseQueues(),this._clearQueues(),this._tileManager.clearCache(),this._resumeQueues();let e=this._vectorTileContainer.children,t=[];try{for(let i of e){let e=this._updatingHandles.addPromise(this._fetchQueue.push(i.key).then(e=>this._parseQueue.push({key:i.key,data:e})).then(e=>i.setData(e)).finally(()=>i.featureIndex=null));t.push(e)}await Promise.all(t)}catch(e){l.A.getLogger(this).error("error refreshing vector-tiles layer-view",e),this._resumeQueues(),this._isTileHandlerReady=!0}this._isTileHandlerReady=!0,this.requestUpdate()}_start(){if(this._stop(),this._tileManager=new E({acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;let e=new AbortController,t=this._tileHandler.start({signal:e.signal}).then(()=>{this._fetchQueue=new q.A({tileInfoView:this._tileInfoView,process:(e,t)=>this._getTileData(e,t),concurrency:15,scheduler:this.scheduler,priority:eR.W6.MAPVIEW_FETCH_QUEUE}),this._parseQueue=new q.A({tileInfoView:this._tileInfoView,process:(e,t)=>this._parseTileData(e,t),concurrency:8,scheduler:this.scheduler,priority:eR.W6.MAPVIEW_VECTOR_TILE_PARSING_QUEUE}),this.requestUpdate(),this._isTileHandlerReady=!0});this._tileHandler.spriteMosaic.then(e=>{this._vectorTileContainer.setStyleResources(e,this._tileHandler.glyphMosaic,this._styleRepository,this._tileInfoView),this.requestUpdate()}),this._tileHandlerAbortController=e,this._tileHandlerPromise=t}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;let e=this._tileHandlerAbortController;e&&e.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue=(0,a.pR)(this._fetchQueue),this._parseQueue=(0,a.pR)(this._parseQueue),this._tileManager=(0,a.pR)(this._tileManager),this._vectorTileContainer.removeAllChildren()}async _getTileData(e,t){return this._tileHandler.fetchTileData(e,t)}async _parseTileData(e,t){return this._tileHandler.parseTileData(e,t)}async _applyStyleChanges(){this._isTileHandlerReady=!1,this._pauseQueues(),this._clearQueues(),this._tileManager.clearCache();let e=this._styleChanges;try{await this._tileHandler.updateStyle(e)}catch(e){l.A.getLogger(this).error("error applying vector-tiles style update",e.message),this._resumeQueues(),this._isTileHandlerReady=!0}let t=this._styleRepository,i=new Set;e.forEach(e=>{if(e.type!==y.$q.LAYER_REMOVED)return;let s=e.data,r=t.getLayerById(s.layer);r&&i.add(r.uid)});let s=new Set;e.forEach(e=>{let i;switch(e.type){case y.$q.PAINTER_CHANGED:t.setPaintProperties(e.data.layer,e.data.paint),i=e.data.layer;break;case y.$q.LAYOUT_CHANGED:t.setLayoutProperties(e.data.layer,e.data.layout),i=e.data.layer;break;case y.$q.LAYER_REMOVED:return void t.deleteStyleLayer(e.data.layer);case y.$q.LAYER_CHANGED:t.setStyleLayer(e.data.layer,e.data.index),i=e.data.layer.id;break;case y.$q.SPRITES_CHANGED:this._vectorTileContainer.setSpriteMosaic(this._tileHandler.setSpriteSource(e.data.spriteSource))}if(i){let e=t.getLayerById(i);e&&s.add(e.uid)}});let r=this._vectorTileContainer.children;if(i.size>0){let e=Array.from(i);for(let t of(this._vectorTileContainer.deleteStyleLayers(e),r))t.deleteLayerData(e)}if(this._resumeQueues(),s.size>0){let e=Array.from(s),t=[];for(let i of r){let s=this._updatingHandles.addPromise(this._fetchQueue.push(i.key).then(t=>this._parseQueue.push({key:i.key,data:t,styleLayerUIDs:e})).then(e=>i.setData(e)).finally(()=>i.featureIndex=null));t.push(s)}await Promise.all(t)}this._styleChanges=[],this._isTileHandlerReady=!0,this.requestUpdate()}async _loadStyle(){let{style:e}=this.layer.currentStyleInfo,t=(0,r.o8)(e);this._isTileHandlerReady=!1,this._pauseQueues(),this._clearQueues(),this._styleRepository=new eT.A(t),this._vectorTileContainer.destroy(),this._tileManager.clear(),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=new AbortController;let{signal:i}=this._tileHandlerAbortController;try{this._tileHandlerPromise=this._tileHandler.setStyle(this._styleRepository,t,this.layer.tileInfo.lods.length-1),await this._tileHandlerPromise}catch(e){if(!(0,n.zf)(e))throw e}if(i.aborted)return this._resumeQueues(),this._isTileHandlerReady=!0,this._styeChanged=!1,this._spriteSourceChanged=!1,void this.requestUpdate();let s=await this._tileHandler.spriteMosaic,l=this._vectorTileContainer;this._tileInfoView=new eC(this.layer.tileInfo,this.layer.fullExtent),l.setStyleResources(s,this._tileHandler.glyphMosaic,this._styleRepository,this._tileInfoView),this._tileManager=new E({acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView},this._vectorTileContainer),this._resumeQueues(),this._isTileHandlerReady=!0,this.requestUpdate(),this._styeChanged=!1,this._spriteSourceChanged=!1}_createVectorTile(e){let t=this._tileInfoView.getTileBounds((0,_.vt)(),e),i=this._tileInfoView.getTileResolution(e.level);return new ei(e,i,t[0],t[3],512,512,this._styleRepository)}async _queryTile(e,t,i,s,r,l){if(0===r.layerData.size)return;let a=this._ensureTileIndex(r),n=this._tileInfoView.getTileBounds((0,_.vt)(),r.key,!0),h=4096*((t.x-n[0])/(n[2]-n[0])),o=4096*(1-(t.y-n[1])/(n[3]-n[1]));for(let n of(await a.queryAttributes(h,o,i,s,l)))n.graphic.geometry=this._tileToMapPoint(n.tilePoint,r.transforms.tileUnitsToPixels),e.push({type:"graphic",layer:this.layer,graphic:n.graphic,mapPoint:t.clone()});e.sort((e,t)=>t.graphic.origin.layerIndex-e.graphic.origin.layerIndex)}_tileToMapPoint(e,t){if(!e)return null;let i=e[0]*t[0]+e[1]*t[3]+t[6],s=e[0]*t[1]+e[1]*t[4]+t[7],r=this.view.state,l=[0,0];return r.toMap(l,[i,s]),new c.A({x:l[0],y:l[1],spatialReference:r.spatialReference})}_ensureTileIndex(e){let t=e.featureIndex;return t||(t=ev.create(e.key,e.layerData,this._styleRepository,this._tileHandler,this.layer),e.featureIndex=t),t}_pauseQueues(){this._fetchQueue.pause(),this._parseQueue.pause()}_resumeQueues(){this._fetchQueue.resume(),this._parseQueue.resume()}_clearQueues(){this._fetchQueue.clear(),this._parseQueue.clear()}};(0,s._)([(0,h.MZ)()],eP.prototype,"_isTileHandlerReady",void 0);let eL=eP=(0,s._)([(0,o.$)("esri.views.2d.layers.VectorTileLayerView2D")],eP)},35568:(e,t,i)=>{i.d(t,{A:()=>s});class s{constructor(e=0,t=0,i=0,s=0){this.x=e,this.y=t,this.width=i,this.height=s}get isEmpty(){return this.width<=0||this.height<=0}union(e){this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.width=Math.max(this.width,e.width),this.height=Math.max(this.height,e.height)}}},36365:(e,t,i)=>{i.d(t,{A:()=>o});var s,r=i(57845),l=i(94264),a=i(98570);!function(e){e[e.varint=0]="varint",e[e.fixed64=1]="fixed64",e[e.delimited=2]="delimited",e[e.fixed32=5]="fixed32",e[e.unknown=99]="unknown"}(s||(s={}));let n=new TextDecoder("utf-8"),h=(0,r.A)("safari")||(0,r.A)("ios")?6:(0,r.A)("ff")?12:32;class o{constructor(e,t,i=0,r=e?e.byteLength:0){this._tag=0,this._dataType=s.unknown,this._init(e,t,i,r)}_init(e,t,i,s){this._data=e,this._dataView=t,this._pos=i,this._end=s}get usedMemory(){return 64+(0,l.Qf)(this._data)}asUnsafe(){return this}clone(){return new o(this._data,this._dataView,this._pos,this._end)}pos(){return this._pos}move(e){this._pos=e}nextTag(e){for(;;){if(this._pos===this._end)return!1;let t=this._decodeVarint();if(this._tag=t>>3,this._dataType=7&t,!e||e===this._tag)break;this.skip()}return!0}next(){if(this._pos===this._end)return!1;let e=this._decodeVarint();return this._tag=e>>3,this._dataType=7&e,!0}empty(){return this._pos>=this._end}tag(){return this._tag}getInt32(){return this._decodeVarint()}getInt64(){return this._decodeVarint()}getUInt32(){let e=0xffffffff;if(e=(127&this._data[this._pos])>>>0,this._data[this._pos++]<128||(e=(e|(127&this._data[this._pos])<<7)>>>0,this._data[this._pos++]<128)||(e=(e|(127&this._data[this._pos])<<14)>>>0,this._data[this._pos++]<128)||(e=(e|(127&this._data[this._pos])<<21)>>>0,this._data[this._pos++]<128)||(e=(e|(15&this._data[this._pos])<<28)>>>0,this._data[this._pos++]<128))return e;throw Error("Varint overflow")}getUInt64(){return this._decodeVarint()}getSInt32(){let e=this.getUInt32();return e>>>1^-(1&e)}getSInt64(){return this._decodeSVarint()}getBool(){let e=0!==this._data[this._pos];return this._skip(1),e}getEnum(){return this._decodeVarint()}getFixed64(){let e=this._dataView,t=this._pos,i=e.getUint32(t,!0)+0x100000000*e.getUint32(t+4,!0);return this._skip(8),i}getSFixed64(){let e=this._dataView,t=this._pos,i=e.getUint32(t,!0)+0x100000000*e.getInt32(t+4,!0);return this._skip(8),i}getDouble(){let e=this._dataView.getFloat64(this._pos,!0);return this._skip(8),e}getFixed32(){let e=this._dataView.getUint32(this._pos,!0);return this._skip(4),e}getSFixed32(){let e=this._dataView.getInt32(this._pos,!0);return this._skip(4),e}getFloat(){let e=this._dataView.getFloat32(this._pos,!0);return this._skip(4),e}getString(){let e=this._getLength(),t=this._pos,i=this._toString(this._data,t,t+e);return this._skip(e),i}getBytes(){let e=this._getLength(),t=this._pos,i=this._toBytes(this._data,t,t+e);return this._skip(e),i}getLength(){return this._getLengthUnsafe()}processMessageWithArgs(e,t,i,s){let r=this.getMessage(),l=e(r,t,i,s);return r.release(),l}processMessage(e){let t=this.getMessage(),i=e(t);return t.release(),i}getMessage(){let e=this._getLength(),t=o.pool.acquire();return t._init(this._data,this._dataView,this._pos,this._pos+e),this._skip(e),t}release(){o.pool.release(this)}dataType(){return this._dataType}skip(){switch(this._dataType){case s.varint:this._decodeVarint();break;case s.fixed64:this._skip(8);break;case s.delimited:this._skip(this._getLength());break;case s.fixed32:this._skip(4);break;default:throw Error("Invalid data type!")}}skipLen(e){this._skip(e)}_skip(e){if(this._pos+e>this._end)throw Error("Attempt to skip past the end of buffer!");this._pos+=e}_decodeVarint(){let e=this._data,t=this._pos,i=0,s=0;if(this._end-t>=10)do{if(i|=127&(s=e[t++]),!(128&s)||(i|=(127&(s=e[t++]))<<7,!(128&s))||(i|=(127&(s=e[t++]))<<14,!(128&s))||(i|=(127&(s=e[t++]))<<21,!(128&s))||(i+=0x10000000*(127&(s=e[t++])),!(128&s))||(i+=0x800000000*(127&(s=e[t++])),!(128&s))||(i+=0x40000000000*(127&(s=e[t++])),!(128&s))||(i+=0x2000000000000*(127&(s=e[t++])),!(128&s))||(i+=0x100000000000000*(127&(s=e[t++])),!(128&s))||(i+=0x8000000000000000*(127&(s=e[t++])),!(128&s)))break;throw Error("Varint too long!")}while(0);else{let r=1;for(;t!==this._end&&128&(s=e[t]);)++t,i+=(127&s)*r,r*=128;if(t===this._end)throw Error("Varint overrun!");++t,i+=s*r}return this._pos=t,i}_decodeSVarint(){let e=this._data,t,i=0,s=0,r=1&e[this._pos];if(i|=127&(s=e[this._pos++]),!(128&s)||(i|=(127&(s=e[this._pos++]))<<7,!(128&s))||(i|=(127&(s=e[this._pos++]))<<14,!(128&s))||(i|=(127&(s=e[this._pos++]))<<21,!(128&s))||(i+=0x10000000*(127&(s=e[this._pos++])),!(128&s))||(i+=0x800000000*(127&(s=e[this._pos++])),!(128&s))||(i+=0x40000000000*(127&(s=e[this._pos++])),!(128&s)))return r?-(i+1)/2:i/2;if(t=BigInt(i)+562949953421312n*BigInt(127&(s=e[this._pos++])),!(128&s)||(t+=0x100000000000000n*BigInt(127&(s=e[this._pos++])),!(128&s))||(t+=0x8000000000000000n*BigInt(127&(s=e[this._pos++])),!(128&s)))return Number(r?-(t+1n)/2n:t/2n);throw Error("Varint too long!")}_getLength(){if(this._dataType!==s.delimited)throw Error("Not a delimited data type!");return this._decodeVarint()}_getLengthUnsafe(){return this.getUInt32()}_toString(e,t,i){if((i=Math.min(this._end,i))-t>h){let s=e.subarray(t,i);return n.decode(s)}let s="",r="";for(let l=t;l<i;++l){let t=e[l];128&t?r+="%"+t.toString(16):(s+=decodeURIComponent(r)+String.fromCharCode(t),r="")}return r.length&&(s+=decodeURIComponent(r)),s}_toBytes(e,t,i){return i=Math.min(this._end,i),new Uint8Array(e.buffer,t,i-t)}}o.pool=new a.A(o,void 0,e=>{e._data=null,e._dataView=null})},50217:(e,t,i)=>{i.d(t,{A:()=>o});var s=i(57845),r=i(52548),l=i(24080),a=i(95671),n=i(60956);let h=(e,t)=>e.key.level-t.key.level!=0?e.key.level-t.key.level:e.key.row-t.key.row!=0?e.key.row-t.key.row:e.key.col-t.key.col;class o extends l.A{constructor(e){super(),this.tileInfoView=e,this.sortFunction=h}renderChildren(e){this.setStencilReference(e),super.renderChildren(e)}createRenderParams(e){let{state:t}=e,i=super.createRenderParams(e);return i.requiredLevel=this.tileInfoView.getClosestInfoForScale(t.scale).level,i.displayLevel=this.tileInfoView.tileInfo.scaleToZoom(t.scale),i}prepareRenderPasses(e){let t=super.prepareRenderPasses(e);return t.push(e.registerRenderPass({name:"stencil",brushes:[a.A],drawPhase:r.S5.DEBUG|r.S5.MAP|r.S5.HIGHLIGHT|r.S5.LABEL,target:()=>this.getStencilTarget()})),(0,s.A)("esri-tiles-debug")&&t.push(e.registerRenderPass({name:"tileInfo",brushes:[n.A],drawPhase:r.S5.DEBUG,target:()=>this.children})),t}getStencilTarget(){return this.children}setStencilReference(e){let t=1;for(let e of this.children)e.stencilRef=t++}}},61070:(e,t,i)=>{i.d(t,{GW:()=>p,IU:()=>g,Jo:()=>a,MG:()=>l,Wh:()=>_,cP:()=>b,os:()=>u,p6:()=>f,pJ:()=>n,ru:()=>x,s3:()=>m,w4:()=>w,wV:()=>y,yM:()=>S,z0:()=>d});var s=i(60470),r=i(82459);let l=Number.POSITIVE_INFINITY,a=Math.PI,n=2*a,h=128/a,o=256/360,u=a/180,c=1/Math.LN2;function _(e,t){return(e%=t)>=0?e:e+t}function d(e){return _(e*h,256)}function y(e){return _(e*o,256)}function f(e){return Math.log(e)*c}function p(e,t,i){return e*(1-i)+t*i}function g(e){return 8+Math.max((e-14)*16,0)}function m(e,t,i){let s,r,l,a=0;for(let n of i){s=n.length;for(let i=1;i<s;++i)r=n[i-1],l=n[i],r.y>t!=l.y>t&&((l.x-r.x)*(t-r.y)-(l.y-r.y)*(e-r.x)>0?a++:a--)}return 0!==a}function x(e,t,i,r){let l,a,n,h,o=r*r;for(let r of i){let i=r.length;if(!(i<2)){l=r[0].x,a=r[0].y;for(let u=1;u<i;++u){if(n=r[u].x,h=r[u].y,(0,s.Ng)(e,t,l,a,n,h)<o)return!0;l=n,a=h}}}return!1}function w(e,t,i,s,r,l,a){let n=Math.max(s,Math.min(t,l))-t,h=Math.max(r,Math.min(i,a))-i;return n*n+h*h<=e*e}function b(e,t){if(0===t||Number.isNaN(t))return e;let i=[],s=new r.bR(0,0),l=new r.bR(0,0),a=new r.bR(0,0);for(let n=0;n<e.length;n++){let h=e[n],o=[];for(let e=0;e<h.length;e++){let i=h[e-1],n=h[e],u=h[e+1];0===e?s.setCoords(0,0):s.assignSub(n,i).normalize().rightPerpendicular(),e===h.length-1?l.setCoords(0,0):l.assignSub(u,n).normalize().rightPerpendicular(),a.assignAdd(s,l).normalize();let c=a.x*l.x+a.y*l.y;0!==c&&a.scale(1/c),o.push(r.bR.add(n,a.scale(t)))}i.push(o)}return i}function S(e,t,i,s){let l=new r.bR(e[0],e[1]);if(l.scale(s),"viewport"===t){let e=-(Math.PI/180*i),t=Math.cos(e),s=Math.sin(e);l.rotate(t,s)}return l}},62377:(e,t,i)=>{i.d(t,{T:()=>l,U:()=>r});var s=i(20538);function r(e,t,i=0){let l=(0,s.qE)(e,0,h);for(let e=0;e<4;e++){var n;t[i+e]=Math.floor(256*((n=l*a[e])-Math.floor(n)))}}function l(e,t=0){let i=0;for(let s=0;s<4;s++)i+=e[t+s]*n[s];return i}let a=[1,256,65536,0x1000000],n=[1/256,1/65536,1/0x1000000,1/0x100000000],h=l(new Uint8ClampedArray([255,255,255,255]))},66544:(e,t,i)=>{let s;i.d(t,{AH:()=>p,Kj:()=>f,Tl:()=>v,c5:()=>_,f0:()=>d,hs:()=>S,k2:()=>y});var r=i(62377),l=i(61939),a=i(20538),n=i(77700),h=i(96657),o=i(94360);let u=()=>l.A.getLogger("esri.symbols.cim.rasterizingUtils"),c=e=>"vertical"===e||"horizontal"===e||"cross"===e||"esriSFSCross"===e||"esriSFSVertical"===e||"esriSFSHorizontal"===e;function _(e,t,i){let s,r=t.style,l=(0,a.yR)(Math.ceil(i)),n=c(r)?8*l:16*l,h=2*l;e.width=n,e.height=n;let o=e.getContext("2d");o.strokeStyle="#ffffff",o.lineWidth=l,o.beginPath(),"vertical"!==r&&"cross"!==r&&"esriSFSCross"!==r&&"esriSFSVertical"!==r||(o.moveTo(n/2,-h),o.lineTo(n/2,n+h)),"horizontal"!==r&&"cross"!==r&&"esriSFSCross"!==r&&"esriSFSHorizontal"!==r||(o.moveTo(-h,n/2),o.lineTo(n+h,n/2)),"backward-diagonal"!==r&&"diagonal-cross"!==r&&"esriSFSDiagonalCross"!==r&&"esriSFSBackwardDiagonal"!==r||(o.moveTo(-h,-h),o.lineTo(n+h,n+h),o.moveTo(n-h,-h),o.lineTo(n+h,h),o.moveTo(-h,n-h),o.lineTo(h,n+h)),"forward-diagonal"!==r&&"diagonal-cross"!==r&&"esriSFSForwardDiagonal"!==r&&"esriSFSDiagonalCross"!==r||(o.moveTo(n+h,-h),o.lineTo(-h,n+h),o.moveTo(h,-h),o.lineTo(-h,h),o.moveTo(n+h,n-h),o.lineTo(n-h,n+h)),o.stroke();let u=new Uint8Array(o.getImageData(0,0,e.width,e.height).data);for(let e=0;e<u.length;e+=4)s=u[e+3]/255,u[e]=u[e]*s,u[e+1]=u[e+1]*s,u[e+2]=u[e+2]*s;return[u,e.width,e.height,l]}function d(e){e.length%2==1&&(e=[...e,...e]);let t=Math.round(e.reduce((e,t)=>e+t,0)*n.zA),i=new Float32Array(+t),s=0,l=0,a=.5,h=!0;for(let t of e){for(s=l,l+=t*n.zA;a<=l;){let e=a-.5,t=Math.min(Math.abs(a-s),Math.abs(a-l));i[e]=h?-t:t,a++}h=!h}let o=i.length,u=new Uint8Array(4*o);for(let e=0;e<o;++e){let t=i[e]/n.zA;(0,r.U)(t/n.gR*.5+.5,u,4*e)}return[u,t,1]}function y(e,t){null==e&&(e=[]);let i="Butt"===t,s="Square"===t,l=!i&&!s;e.length%2==1&&(e=[...e,...e]);let a=n.$o,h=2*a,o=0;for(let t of e)o+=t;let u=Math.round(o*a),c=new Float32Array(u*h),_=.5*a,d=0,y=0,f=.5,p=!0;for(let t of e){for(d=y,y+=t*a;f<=y;){let e=.5;for(;e<h;){let t=(e-.5)*u+f-.5,r=l?(e-a)*(e-a):Math.abs(e-a);c[t]=p?i?Math.max(Math.max(d+_-f,r),Math.max(f-y+_,r)):r:l?Math.min((f-d)*(f-d)+r,(f-y)*(f-y)+r):s?Math.min(Math.max(f-d,r),Math.max(y-f,r)):Math.min(Math.max(f-d+_,r),Math.max(y+_-f,r)),e++}f++}p=!p}let g=c.length,m=new Uint8Array(4*g);for(let e=0;e<g;++e){let t=(l?Math.sqrt(c[e]):c[e])/a;(0,r.U)(t,m,4*e)}return[m,u,h]}function f(e,t){var i,s;let{colorRamp:r,gradientType:l}=t,a="CIMFixedColorRamp"===r.type,n=t.interval||h.D.CIMGradientFill.interval,u=g(r);return a&&(u=m(u,n)),"Discrete"===l||a?(w(i=e,u,n,1,o.MZ),b(i)):(w(s=e,u,32,1,o.MZ),b(s))}function p(e,t){let{colorRamp:i,gradientType:r}=t,l=g(i),a="CIMFixedColorRamp"===i.type;if("Continuous"===r&&!a)return x(e,l);let n=t.interval??h.D.CIMGradientFill.interval;if(a)return x(e,m(l,n));let o=[];w(s??=document.createElement("canvas"),l,n,1,0);let u=s.getContext("2d").getImageData(0,0,n,1).data;for(let e=0,t=0;e<n;t=4*++e){let i=[u[t+0],u[t+1],u[t+2],u[t+3]];o.push({offset:e/n,color:i}),o.push({offset:(e+1)/n,color:i})}return x(e,o)}function g(e){let t=[];switch(e.type){case"CIMPolarContinuousColorRamp":case"CIMLinearContinuousColorRamp":"CIMPolarContinuousColorRamp"===e.type&&u().warnOnce("CIMPolarContinuousColorRamp is currently unsupported. Falling back to CIMLinearContinuousColorRamp."),t.push({offset:0,color:[e.fromColor[0],e.fromColor[1],e.fromColor[2],e.fromColor[3]/255]}),t.push({offset:1,color:[e.toColor[0],e.toColor[1],e.toColor[2],e.toColor[3]/255]});break;case"CIMFixedColorRamp":{let i=1/(e.colors.length-1),s=0;for(let r of e.colors)t.push({offset:s,color:[r[0],r[1],r[2],r[3]/255]}),s+=i;break}case"CIMMultipartColorRamp":{let i=e.weights.reduce((e,t)=>e+t,0),s=0;for(let r=0;r<e.colorRamps.length;r++){let l=e.colorRamps[r],a=e.weights[r];for(let e of g(l))t.push({offset:(s+e.offset*a)/i,color:e.color});s+=a}break}default:u().error(`Color ramp "${e.type}" currently unsupported.`)}return t}function m(e,t){let i=[],s=(e.length-1)/(t-1);for(let r=0;r<t;r++){let l=e[Math.round(r*s)].color;i.push({offset:r/t,color:l}),i.push({offset:(r+1)/t,color:l})}return i}function x(e,t,i=0){for(let{offset:s,color:r}of t)e.addColorStop(Math.min(Math.max(s,i),1-i),`rgba(${r[0]}, ${r[1]}, ${r[2]}, ${r[3]})`)}function w(e,t,i,s,r){let l=i+2*r;e.width=l,e.height=s;let a=(r+1)/l,n=e.getContext("2d",{willReadFrequently:!0});if(t.length>0){let e=n.createLinearGradient(0,0,l,s);x(e,t,a),n.fillStyle=e}else n.fillStyle="rgba(128, 128, 128, 1)";n.fillRect(0,0,l,s)}function b(e){let{width:t,height:i}=e,s=new Uint8Array(e.getContext("2d").getImageData(0,0,t,i).data);for(let e=0;e<s.length;e+=4){let t=s[e+3]/255;s[e]*=t,s[e+1]*=t,s[e+2]*=t}return[s,t,i]}function S(e,t){let i=function(e){let t=e[0]?.[0]?.[0]??0,i=e[0]?.[0]?.[1]??0,s={ymin:i,xmin:t,ymax:i,xmax:t,width:0,height:0};for(let t=0;t<e.length;t++){let i=e[t];for(let e=0;e<i.length;e++){let t=i[e][0],r=i[e][1];t<s.xmin&&(s.xmin=t),t>s.xmax&&(s.xmax=t),r<s.ymin&&(s.ymin=r),r>s.ymax&&(s.ymax=r)}}return s.width=Math.abs(s.xmax-s.xmin),s.height=Math.abs(s.ymax-s.ymin),s}(e),s=0===i.width?1:i.width,r=0===i.height?1:i.height,l=[];for(let a=0;a<e.length;a++){let n=e[a],h=[];for(let e=0;e<n.length;e++){let l=Math.round(n[e][0]-i.xmin),a=Math.round(n[e][1]-i.ymin);if(l=t.xmin+l*t.width/s,a=t.ymin+a*t.height/r,isNaN(l)||isNaN(a))throw Error("Scaled shape has NaN values");h.push([l,a])}l.push(h)}return l}function v(e,t,i){let s=[];for(let r=0;r<e.length;r++){let l=e[r],a=[];for(let e=0;e<l.length;e++){let s=l[e][0]+t,r=l[e][1]+i;if(isNaN(s)||isNaN(r))throw Error("Scaled shape has NaN values");a.push([s,r])}s.push(a)}return s}},77700:(e,t,i)=>{i.d(t,{$o:()=>s,$u:()=>a,gR:()=>l,zA:()=>r});let s=15.5,r=4,l=64,a=1024},80468:(e,t,i)=>{i.d(t,{A:()=>h});var s=i(81856),r=i(61939),l=i(92753),a=i(45257);i(57845),i(33638),i(32391);var n=i(12709);let h=e=>{let t=class extends e{initialize(){this.addHandles((0,a.on)(()=>this.layer,"refresh",e=>{this.doRefresh(e.dataChanged).catch(e=>{(0,l.zf)(e)||r.A.getLogger(this).error(e)})}),"RefreshableLayerView")}};return(0,s._)([(0,n.$)("esri.views.layers.RefreshableLayerView")],t)}},82459:(e,t,i)=>{var s,r;i.d(t,{O3:()=>n,Ox:()=>h,bR:()=>l,dC:()=>s}),!function(e){e[e.Unknown=0]="Unknown",e[e.Point=1]="Point",e[e.LineString=2]="LineString",e[e.Polygon=3]="Polygon"}(s||(s={}));class l{constructor(e,t){this.x=e,this.y=t}clone(){return new l(this.x,this.y)}equals(e,t){return e===this.x&&t===this.y}isEqual(e){return e.x===this.x&&e.y===this.y}setCoords(e,t){return this.x=e,this.y=t,this}normalize(){let e=this.x,t=this.y,i=Math.sqrt(e*e+t*t);return this.x/=i,this.y/=i,this}rightPerpendicular(){let e=this.x;return this.x=this.y,this.y=-e,this}leftPerpendicular(){let e=this.x;return this.x=-this.y,this.y=e,this}move(e,t){return this.x+=e,this.y+=t,this}assign(e){return this.x=e.x,this.y=e.y,this}assignAdd(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}assignSub(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}rotate(e,t){let i=this.x,s=this.y;return this.x=i*e-s*t,this.y=i*t+s*e,this}scale(e){return this.x*=e,this.y*=e,this}length(){let e=this.x,t=this.y;return Math.sqrt(e*e+t*t)}sub(e){return this.x-=e.x,this.y-=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}static distance(e,t){let i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)}static add(e,t){return new l(e.x+t.x,e.y+t.y)}static sub(e,t){return new l(e.x-t.x,e.y-t.y)}}class a{constructor(e,t,i){this.ratio=e,this.x=t,this.y=i}}class n{constructor(e,t,i,s=8,r=8){this._lines=[],this._starts=[],this.validateTessellation=!0,this._pixelRatio=s,this._pixelMargin=r,this._tileSize=512*s,this._dz=e,this._yPos=t,this._xPos=i}setPixelMargin(e){e!==this._pixelMargin&&(this._pixelMargin=e,this.setExtent(this._extent))}setExtent(e){this._extent=e,this._finalRatio=this._tileSize/e*(1<<this._dz);let t=this._pixelRatio*this._pixelMargin;t/=this._finalRatio;let i=e>>this._dz;t>i&&(t=i),this._margin=t,this._xmin=i*this._xPos-t,this._ymin=i*this._yPos-t,this._xmax=this._xmin+i+2*t,this._ymax=this._ymin+i+2*t}reset(e){this._type=e,this._lines=[],this._starts=[],this._line=null,this._start=0}moveTo(e,t){this._pushLine(),this._prevIsIn=this._isIn(e,t),this._moveTo(e,t,this._prevIsIn),this._prevPt=new l(e,t),this._firstPt=new l(e,t),this._dist=0}lineTo(e,t){let i,s,r,n,h,o,u,c,_=this._isIn(e,t),d=new l(e,t),y=l.distance(this._prevPt,d);if(_)this._prevIsIn?this._lineTo(e,t,!0):(i=this._prevPt,s=d,r=this._intersect(s,i),this._start=this._dist+y*(1-this._r),this._lineTo(r.x,r.y,!0),this._lineTo(s.x,s.y,!0));else if(this._prevIsIn)s=this._prevPt,i=d,r=this._intersect(s,i),this._lineTo(r.x,r.y,!0),this._lineTo(i.x,i.y,!1);else{let e=this._prevPt;if(e.x<=this._xmin&&d.x<=this._xmin||e.x>=this._xmax&&d.x>=this._xmax||e.y<=this._ymin&&d.y<=this._ymin||e.y>=this._ymax&&d.y>=this._ymax)this._lineTo(d.x,d.y,!1);else{let t=[];if((e.x<this._xmin&&d.x>this._xmin||e.x>this._xmin&&d.x<this._xmin)&&(n=(this._xmin-e.x)/(d.x-e.x),(c=e.y+n*(d.y-e.y))<=this._ymin?o=!1:c>=this._ymax?o=!0:t.push(new a(n,this._xmin,c))),(e.x<this._xmax&&d.x>this._xmax||e.x>this._xmax&&d.x<this._xmax)&&(n=(this._xmax-e.x)/(d.x-e.x),(c=e.y+n*(d.y-e.y))<=this._ymin?o=!1:c>=this._ymax?o=!0:t.push(new a(n,this._xmax,c))),(e.y<this._ymin&&d.y>this._ymin||e.y>this._ymin&&d.y<this._ymin)&&(n=(this._ymin-e.y)/(d.y-e.y),(u=e.x+n*(d.x-e.x))<=this._xmin?h=!1:u>=this._xmax?h=!0:t.push(new a(n,u,this._ymin))),(e.y<this._ymax&&d.y>this._ymax||e.y>this._ymax&&d.y<this._ymax)&&(n=(this._ymax-e.y)/(d.y-e.y),(u=e.x+n*(d.x-e.x))<=this._xmin?h=!1:u>=this._xmax?h=!0:t.push(new a(n,u,this._ymax))),0===t.length)h?o?this._lineTo(this._xmax,this._ymax,!0):this._lineTo(this._xmax,this._ymin,!0):o?this._lineTo(this._xmin,this._ymax,!0):this._lineTo(this._xmin,this._ymin,!0);else if(t.length>1&&t[0].ratio>t[1].ratio)this._start=this._dist+y*t[1].ratio,this._lineTo(t[1].x,t[1].y,!0),this._lineTo(t[0].x,t[0].y,!0);else{this._start=this._dist+y*t[0].ratio;for(let e=0;e<t.length;e++)this._lineTo(t[e].x,t[e].y,!0)}this._lineTo(d.x,d.y,!1)}}this._dist+=y,this._prevIsIn=_,this._prevPt=d}close(){if(this._line.length>2){let e=this._firstPt,t=this._prevPt;e.x===t.x&&e.y===t.y||this.lineTo(e.x,e.y);let i=this._line,s=i.length;for(;s>=4&&(i[0].x===i[1].x&&i[0].x===i[s-2].x||i[0].y===i[1].y&&i[0].y===i[s-2].y);)i.pop(),i[0].x=i[s-2].x,i[0].y=i[s-2].y,--s}}result(e=!0){return this._pushLine(),0===this._lines.length?null:(this._type===s.Polygon&&e&&o.simplify(this._tileSize,this._margin*this._finalRatio,this._lines),this._lines)}resultWithStarts(){if(this._type!==s.LineString)throw Error("Only valid for lines");this._pushLine();let e=this._lines,t=e.length;if(0===t)return null;let i=[];for(let s=0;s<t;s++)i.push({line:e[s],start:this._starts[s]||0});return i}_isIn(e,t){return e>=this._xmin&&e<=this._xmax&&t>=this._ymin&&t<=this._ymax}_intersect(e,t){let i,s,r;if(t.x>=this._xmin&&t.x<=this._xmax)r=((s=t.y<=this._ymin?this._ymin:this._ymax)-e.y)/(t.y-e.y),i=e.x+r*(t.x-e.x);else if(t.y>=this._ymin&&t.y<=this._ymax)r=((i=t.x<=this._xmin?this._xmin:this._xmax)-e.x)/(t.x-e.x),s=e.y+r*(t.y-e.y);else{s=t.y<=this._ymin?this._ymin:this._ymax;let l=((i=t.x<=this._xmin?this._xmin:this._xmax)-e.x)/(t.x-e.x),a=(s-e.y)/(t.y-e.y);l<a?(r=l,s=e.y+l*(t.y-e.y)):(r=a,i=e.x+a*(t.x-e.x))}return this._r=r,new l(i,s)}_pushLine(){this._line&&(this._type===s.Point?this._line.length>0&&(this._lines.push(this._line),this._starts.push(this._start)):this._type===s.LineString?this._line.length>1&&(this._lines.push(this._line),this._starts.push(this._start)):this._type===s.Polygon&&this._line.length>3&&(this._lines.push(this._line),this._starts.push(this._start))),this._line=[],this._start=0}_moveTo(e,t,i){this._type!==s.Polygon?i&&(e=Math.round((e-(this._xmin+this._margin))*this._finalRatio),t=Math.round((t-(this._ymin+this._margin))*this._finalRatio),this._line.push(new l(e,t))):(i||(e<this._xmin&&(e=this._xmin),e>this._xmax&&(e=this._xmax),t<this._ymin&&(t=this._ymin),t>this._ymax&&(t=this._ymax)),e=Math.round((e-(this._xmin+this._margin))*this._finalRatio),t=Math.round((t-(this._ymin+this._margin))*this._finalRatio),this._line.push(new l(e,t)),this._isH=!1,this._isV=!1)}_lineTo(e,t,i){let r,a;if(this._type!==s.Polygon)if(i){if(e=Math.round((e-(this._xmin+this._margin))*this._finalRatio),t=Math.round((t-(this._ymin+this._margin))*this._finalRatio),this._line.length>0&&(r=this._line[this._line.length-1]).equals(e,t))return;this._line.push(new l(e,t))}else this._line&&this._line.length>0&&this._pushLine();else if(i||(e<this._xmin&&(e=this._xmin),e>this._xmax&&(e=this._xmax),t<this._ymin&&(t=this._ymin),t>this._ymax&&(t=this._ymax)),e=Math.round((e-(this._xmin+this._margin))*this._finalRatio),t=Math.round((t-(this._ymin+this._margin))*this._finalRatio),this._line&&this._line.length>0){let i=(r=this._line[this._line.length-1]).x===e,s=r.y===t;if(i&&s)return;this._isH&&i||this._isV&&s?(r.x=e,r.y=t,(a=this._line[this._line.length-2]).x===e&&a.y===t?(this._line.pop(),this._line.length<=1?(this._isH=!1,this._isV=!1):(a=this._line[this._line.length-2],this._isH=a.x===e,this._isV=a.y===t)):(this._isH=a.x===e,this._isV=a.y===t)):(this._line.push(new l(e,t)),this._isH=i,this._isV=s)}else this._line.push(new l(e,t))}}class h{setExtent(e){this._ratio=4096===e?1:4096/e}get validateTessellation(){return this._ratio<1}reset(e){this._lines=[],this._line=null}moveTo(e,t){this._line&&this._lines.push(this._line),this._line=[];let i=this._ratio;this._line.push(new l(e*i,t*i))}lineTo(e,t){let i=this._ratio;this._line.push(new l(e*i,t*i))}close(){let e=this._line;e&&!e[0].isEqual(e[e.length-1])&&e.push(e[0])}result(){return this._line&&this._lines.push(this._line),0===this._lines.length?null:this._lines}}!function(e){e[e.sideLeft=0]="sideLeft",e[e.sideRight=1]="sideRight",e[e.sideTop=2]="sideTop",e[e.sideBottom=3]="sideBottom"}(r||(r={}));class o{static simplify(e,t,i){if(!i)return;let s=-t,l=e+t,a=-t,n=e+t,h=[],u=[],c=i.length;for(let e=0;e<c;++e){let t=i[e];if(!t||t.length<2)continue;let o,c=t[0],_=t.length;for(let i=1;i<_;++i)o=t[i],c.x===o.x&&(c.x<=s&&(c.y>o.y?(h.push(e),h.push(i),h.push(r.sideLeft),h.push(-1)):(u.push(e),u.push(i),u.push(r.sideLeft),u.push(-1))),c.x>=l&&(c.y<o.y?(h.push(e),h.push(i),h.push(r.sideRight),h.push(-1)):(u.push(e),u.push(i),u.push(r.sideRight),u.push(-1)))),c.y===o.y&&(c.y<=a&&(c.x<o.x?(h.push(e),h.push(i),h.push(r.sideTop),h.push(-1)):(u.push(e),u.push(i),u.push(r.sideTop),u.push(-1))),c.y>=n&&(c.x>o.x?(h.push(e),h.push(i),h.push(r.sideBottom),h.push(-1)):(u.push(e),u.push(i),u.push(r.sideBottom),u.push(-1)))),c=o}if(0===h.length||0===u.length)return;o.fillParent(i,u,h),o.fillParent(i,h,u);let _=[];o.calcDeltas(_,u,h),o.calcDeltas(_,h,u),o.addDeltas(_,i)}static fillParent(e,t,i){let s=i.length,l=t.length;for(let a=0;a<l;a+=4){let l=t[a],n=t[a+1],h=t[a+2],o=e[l][n-1],c=e[l][n],_=8092,d=-1;for(let t=0;t<s;t+=4){if(i[t+2]!==h)continue;let s=i[t],l=i[t+1],a=e[s][l-1],n=e[s][l];switch(h){case r.sideLeft:case r.sideRight:if(u(o.y,a.y,n.y)&&u(c.y,a.y,n.y)){let e=Math.abs(n.y-a.y);e<_&&(_=e,d=t)}break;case r.sideTop:case r.sideBottom:if(u(o.x,a.x,n.x)&&u(c.x,a.x,n.x)){let e=Math.abs(n.x-a.x);e<_&&(_=e,d=t)}}}t[a+3]=d}}static calcDeltas(e,t,i){let s=t.length;for(let r=0;r<s;r+=4){let s=[],l=o.calcDelta(r,t,i,s);e.push(t[r]),e.push(t[r+1]),e.push(t[r+2]),e.push(l)}}static calcDelta(e,t,i,s){let r=t[e+3];if(-1===r)return 0;let l=s.length;return l>1&&s[l-2]===r?0:(s.push(r),o.calcDelta(r,i,t,s)+1)}static addDeltas(e,t){let i=e.length,s=0;for(let t=0;t<i;t+=4){let i=e[t+3];i>s&&(s=i)}for(let l=0;l<i;l+=4){let i=t[e[l]],a=e[l+1],n=s-e[l+3];switch(e[l+2]){case r.sideLeft:i[a-1].x-=n,i[a].x-=n,1===a&&(i[i.length-1].x-=n),a===i.length-1&&(i[0].x-=n);break;case r.sideRight:i[a-1].x+=n,i[a].x+=n,1===a&&(i[i.length-1].x+=n),a===i.length-1&&(i[0].x+=n);break;case r.sideTop:i[a-1].y-=n,i[a].y-=n,1===a&&(i[i.length-1].y-=n),a===i.length-1&&(i[0].y-=n);break;case r.sideBottom:i[a-1].y+=n,i[a].y+=n,1===a&&(i[i.length-1].y+=n),a===i.length-1&&(i[0].y+=n)}}}}let u=(e,t,i)=>e>=t&&e<=i||e>=i&&e<=t},82489:(e,t,i)=>{i.d(t,{A:()=>l});var s,r=i(82459);!function(e){e[e.moveTo=1]="moveTo",e[e.lineTo=2]="lineTo",e[e.close=7]="close"}(s||(s={}));class l{constructor(e,t,i=0){this.values={},this._geometry=void 0,this._pbfGeometry=null,this.featureIndex=i;let s=t.keys,r=t.values,l=e.asUnsafe();for(;l.next();)switch(l.tag()){case 1:this.id=l.getUInt64();break;case 2:{let e=l.getMessage().asUnsafe(),t=this.values;for(;!e.empty();){let i=e.getUInt32(),l=e.getUInt32();t[s[i]]=r[l]}e.release();break}case 3:this.type=l.getUInt32();break;case 4:this._pbfGeometry=l.getMessage();break;default:l.skip()}}getGeometry(e){let t,i;if(void 0!==this._geometry)return this._geometry;if(!this._pbfGeometry)return null;let l=this._pbfGeometry.asUnsafe();this._pbfGeometry=null,e?e.reset(this.type):t=[];let a,n=s.moveTo,h=0,o=0,u=0;for(;!l.empty();){if(0===h){let e=l.getUInt32();n=7&e,h=e>>3}switch(h--,n){case s.moveTo:o+=l.getSInt32(),u+=l.getSInt32(),e?e.moveTo(o,u):t&&(i&&t.push(i),(i=[]).push(new r.bR(o,u)));break;case s.lineTo:o+=l.getSInt32(),u+=l.getSInt32(),e?e.lineTo(o,u):i&&i.push(new r.bR(o,u));break;case s.close:e?e.close():i&&!i[0].equals(o,u)&&i.push(i[0].clone());break;default:throw l.release(),Error("Invalid path operation")}}return e?a=e.result():t&&(i&&t.push(i),a=t),l.release(),this._geometry=a,a}}}}]);