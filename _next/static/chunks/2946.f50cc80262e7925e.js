"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2946],{82946:(e,t,a)=>{a.r(t),a.d(t,{default:()=>R});var i,n=a(81856),r=a(69264),o=a(54335),s=a(32391),l=a(61939),h=a(90304),d=a(21892),u=a(92753),p=a(45257),y=a(91838);a(57845),a(33638);var g=a(12709),c=a(44151),m=a(61414),f=a(39960),M=a(65442),L=a(64171),b=a(60729),w=a(78754);!function(e){e.MULTIPLIER="multiplier",e.ABSOLUTE="absolute-value"}(i||(i={}));var T=a(9753),k=a(64443),C=a(32547),N=a(93193),v=a(44966),x=a(24743),D=a(2043),E=a(23281),_=a(76572),I=a(21009),A=a(56283);let S=class extends(0,D.q)((0,x.dM)((0,E.j)((0,d.P)(L.A)))){constructor(e){if(super(e),this.url=null,this.dataPreloadedInLocalCache=!1,this.initializationLinkChartConfig=null,this.membershipModified=!0,this._currentLinkChartConfig={layoutMode:"organic-standard"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new(o.A.ofType(k.A)),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new m.A({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.operationalLayerType="LinkChartLayer",this.sublayerIdsCache=new Map,this.tables=new(o.A.ofType(k.A)),this.type="link-chart",this.chronologicalAuxiliaryGraphics=null,this._originalInclusionList=e?.initializationInclusionModeDefinition,e?.dataPreloadedInLocalCache&&!e?.initializationInclusionModeDefinition)throw new s.A("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it");this.addHandles((0,p.wB)(()=>this.layers.concat(this.tables),(e,t)=>this._handleSublayersChange(e,t),p.OH))}normalizeCtorArgs(e){if(!e)return{};let{url:t,title:a,dataPreloadedInLocalCache:i,initializationLinkChartConfig:n}=e;return{url:t,title:a,dataPreloadedInLocalCache:i,initializationLinkChartConfig:n}}_initializeLayerProperties(e){if(!this.title&&this.url){let e=this.url.split("/");this.title=e[e.length-2]}let t=new Set,a=[],i=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new s.A("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.inclusionModeDefinition?.generateAllSublayers?(a=e.knowledgeGraph.dataModel.entityTypes??[],i=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach((n,r)=>{let o=this._graphTypeLookup.get(r);if(!o)return l.A.getLogger(this).warn(`A named type, ${r}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(r);"relationship"===o.type?t.has(r)||(t.add(r),i.push(o)):"entity"===o.type?t.has(r)||(t.add(r),a.push(o)):(l.A.getLogger(this).warn(`A named type, ${r}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(r))}):(a=e.knowledgeGraph.dataModel.entityTypes??[],i=e.knowledgeGraph.dataModel.relationshipTypes??[]);let n=new T.P({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=a,this.memberRelationshipTypes=i,this.dataManager=n}load(e){let t=async()=>{let e=[],t=[];this.loadLayerAssumingLocalCache(),this._layersLoadedFromAuthoritativeItem()||await (0,C.qN)(this),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(e=>{e.useAllData=!1}),await this._initializeDiagram(),this.layers.forEach(a=>{t.push(a.refreshCachedQueryEngine()),e.push(new Promise(e=>{a.on("layerview-create",()=>{e(null)})}))}),this.tables.forEach(e=>{t.push(e.refreshCachedQueryEngine())}),await Promise.all(t)};return this.addResolvingPromise(new Promise(a=>{(0,A.fetchKnowledgeGraph)(this.url).then(async i=>{i.dataModel.entityTypes?.forEach(e=>{e.name&&this._graphTypeLookup.set(e.name,e)}),i.dataModel.relationshipTypes?.forEach(e=>{e.name&&this._graphTypeLookup.set(e.name,e)});let n=this.linkChart?.linkChartProperties;if(n?.originIdOf("entitiesUrl")===c.Gr.LINK_CHART&&(this.membershipModified=!1,this._originalInclusionList=await r.XW.fetchAndConvertSerializedLinkChart({entitiesUrl:n?.entitiesUrl,relationshipsUrl:n?.relationshipsUrl}),this._alignLayersDataModelAndInclusionDefinition(i.dataModel),this.initializationLinkChartConfig={layoutSettings:n?.layoutSettings??void 0,layoutMode:(0,v.k5)(n.layoutType)}),this._initializeLayerProperties({knowledgeGraph:i,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach(e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})}),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach(e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})})),this.dataPreloadedInLocalCache){let e=N.A.getInstance();for(let[t,a]of this.dataManager.inclusionModeDefinition?.namedTypeDefinitions??[])for(let i of a.members?.values()??[]){let a=e.readFromStoreById(`${t}__${i.id}`);a&&(0,h.tE)(this.dataManager.sublayerCaches,t,()=>new Map).set(i.id,a)}await t()}else{let a="geographic-organic-standard"===this.initializationLinkChartConfig?.layoutMode;this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,a,!0).then(async()=>{(0,u.Te)(e),await t()}))}a(null)})})),Promise.resolve(this)}set initializationInclusionModeDefinition(e){"loaded"!==this.loadStatus&&"failed"!==this.loadStatus?this._set("initializationInclusionModeDefinition",e):l.A.getLogger(this).error("#initializationInclusionModeDefinition","initializationInclusionModeDefinition cannot be changed after the layer is loaded.")}get linkChart(){return this.parent}async addRecords(e,t){let a=[];t?.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(a=await (0,v.aq)(e,this.dataManager.knowledgeGraph));let i=e.concat(a).filter(e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id));i.length>0&&(this.membershipModified=!0),await this._handleNewRecords(i,t)}async removeRecords(e,{cascadeRemoveRelationships:t=!0,recalculateLayout:a=!1,overrideMembershipCheck:i=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1,overrideMembershipCheck:!1}){let n=[];for(let t of e)(i||!1===this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(t.typeName)?.useAllData&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(t.typeName)?.members?.has(t.id))&&n.push(t);if(t){let e=new Set,t=[];for(let t of n)if(this.dataManager.nodeConnectionsLookup.has(t.id))for(let a of this.dataManager.nodeConnectionsLookup.get(t.id))e.add(a);for(let a of e)if(this.dataManager.memberIdTypeLookup.has(a))for(let e of this.dataManager.memberIdTypeLookup.get(a))this.dataManager.relationshipTypeNames.has(e)&&t.push({id:a,typeName:e});n=n.concat(t)}for(let e of(this.dataManager.removeFromLayer(n),n))this.sublayerIdsCache.get(e.typeName)?.delete(e.id),this.dataManager.relationshipTypeNames.has(e.typeName)?this.relationshipLinkChartDiagramLookup.delete(e.id):this.entityLinkChartDiagramLookup.delete(e.id);a&&await this._calculateLayoutWithSublayerTimeInfo(this._currentLinkChartConfig.layoutMode,{layoutSettings:this._currentLinkChartConfig.layoutSettings}),n.length>0&&(this.membershipModified=!0);let r=[];return this.layers.forEach(e=>{r.push(e.refreshCachedQueryEngine())}),await Promise.all(r),this._refreshNamedTypes(),n}async expand(e,t){let a=[];try{let i=await this.dataManager.getConnectedRecordIds(e,t?.relationshipTypeNames,t);a=i.filter(e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id)),await this._handleNewRecords(i,t),i.length>0&&(this.membershipModified=!0),(0,u.Te)(t?.signal)}catch(e){throw(0,u.zf)(e)&&a.length>0&&this.removeRecords(a,{overrideMembershipCheck:!0}),e}return{records:a}}loadLayerAssumingLocalCache(){let e=[...this.memberRelationshipTypes,...this.memberEntityTypes];this.originIdOf("layers")===c.Gr.DEFAULTS?this._createSublayers(e,this.layers,e=>!!e.geometryType):this._updateSublayers(e,this.layers),this.originIdOf("tables")===c.Gr.DEFAULTS?this._createSublayers(e,this.tables,e=>!e.geometryType):this._updateSublayers(e,this.tables),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e,t)=>{let a=(0,h.tE)(this.sublayerIdsCache,t,()=>new Set);e.members?.forEach(({id:e,linkChartLocation:i})=>{if(a.add(e),i){let a="coords"in i&&"lengths"in i?i:(0,b.Ux)(i);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(e,a):this.entityLinkChartDiagramLookup.set(e,a)}})})}async calculateLinkChartLayout(e="organic-standard",t){let a=[],i=[],n=[];this.dataManager.sublayerCaches.forEach((e,t)=>{this.dataManager.entityTypeNames.has(t)?e.forEach(e=>{a.push({typeName:t,feature:e})}):this.dataManager.relationshipTypeNames.has(t)&&e.forEach(e=>{i.push({typeName:t,feature:e})})}),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;let r=new Map,o=new Map,d=new Map,p=new Map,y=new Uint8Array(a.length),g=new Float64Array(a.length),c=new Float64Array(a.length),L=new Float64Array(a.length),T=new Float64Array(a.length),k=new Uint32Array(i.length),C=new Uint32Array(i.length),N=new Float64Array(i.length),v=new Float64Array(i.length),x=[],D=new m.A({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),E,_=0,A=0,S=I.i6.apply;switch("geographic-organic-standard"===e?"organic-standard":e){case"organic-standard":E=I.pM.apply;break;case"organic-community":E=I.Tu.apply;break;case"hierarchical-bottom-to-top":E=I.$C.apply;break;case"radial-root-centric":E=I.vJ.apply;break;case"tree-left-to-right":E=I.Xq.apply;break;default:E=I.Wg.apply}let R=!1;a.forEach(({typeName:a,feature:i})=>{if("chronological-mono-timeline"!==e&&"chronological-multi-timeline"!==e&&t?.lockedNodeLocations?.has(i.attributes[w.dr])){"geographic-organic-standard"===e&&this.dataManager.geographicLookup.has(a)?y[_]=I.tx.IsGeographic:y[_]=I.tx.None;let n=t.lockedNodeLocations.get(i.attributes[w.dr]);g[_]=n.x,c[_]=n.y}else if("geographic-organic-standard"===e&&this.dataManager.geographicLookup.has(a)){y[_]=I.tx.IsGeographic;let e=null,t=i.attributes[this.dataManager.geographicLookup.get(a).name];switch(this.dataManager.geographicLookup.get(a)?.geometryType){case"esriGeometryPoint":g[_]=t?.x,c[_]=t?.y;break;case"esriGeometryPolygon":e=t?.centroid,null!=e?.x&&null!=e?.y?(g[_]=e.x,c[_]=e.y):y[_]=I.tx.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":e=t?.extent?.center,null!=e?.x&&null!=e?.y?(g[_]=e.x,c[_]=e.y):y[_]=I.tx.IsMovable;break;default:y[_]=I.tx.IsMovable}(null==g[_]||null==c[_]||Number.isNaN(g[_])||Number.isNaN(c[_]))&&(y[_]=I.tx.IsMovable,g[_]=0,c[_]=0)}else if("chronological-mono-timeline"===e||"chronological-multi-timeline"===e){!R&&t?.lockedNodeLocations?.has(i.attributes[w.dr])&&(R=!0);let e=t?.timeInfoByTypeName?.get(a),n=e?.startField,r=n&&e?.startField?i.attributes[n]:null;L[_]=r?new Date(r).getTime():NaN;let o=e?.endField,s=o&&e?.endField?i.attributes[o]:null;T[_]=s?new Date(s).getTime():NaN,g[_]=0,c[_]=0,y[_]=I.tx.IsMovable}else y[_]=I.tx.IsMovable,g[_]=0,c[_]=0;p.set(i.attributes[w.dr],_),x[_]={feature:i,typeName:a},_++}),R&&l.A.getLogger(this).warn("Locked node locations are not supported for chronological layout at this time.  Requested node locations were ignored");let z=!1,G=new Map;i.forEach(a=>{let i=a.feature.attributes[w.Cz],r=a.feature.attributes[w.KQ],o=p.get(i),s=p.get(r),l=t?.timeInfoByTypeName?.get(a.typeName),h=t?.timeInfoByTypeName?l?.startField:null,d=h?a.feature.attributes[h]:null,u=l?.endField,y=u?a.feature.attributes[u]:null;if(void 0!==o&&void 0!==s){let t=i+"-"+r;"chronological-mono-timeline"!==e&&"chronological-multi-timeline"!==e||(t=t+"-"+d+"-"+y);let l=G.get(t);l?.has(a.typeName)||(k[A]=o,C[A]=s,"chronological-mono-timeline"!==e&&"chronological-multi-timeline"!==e||(N[A]=d?new Date(d).getTime():NaN,v[A]=y?new Date(y).getTime():NaN),void 0===l?G.set(t,new Map([[a.typeName,A]])):l.set(a.typeName,A),A++),n.push(a)}else z=!0,this.relationshipLinkChartDiagramLookup.set(i,null)}),z&&l.A.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null");let P=this._validateOrganicLayoutSettings(e,t?.layoutSettings?.organicLayoutSettings),F=this._convertValidatedOrganicSettingsToCalculationSettings(P);await (0,I.Hh)();let O=I.JT.Error,U=null;if("chronological-mono-timeline"===e||"chronological-multi-timeline"===e){let a;({status:O,links:U,graphics:a}=S(()=>t?.signal?.aborted??!1,y,g,c,L,T,k.subarray(0,A),C.subarray(0,A),N.subarray(0,A),v.subarray(0,A),"chronological-multi-timeline"===e,t?.layoutSettings?.chronologicalLayoutSettings)),O===I.JT.Success&&(this.chronologicalAuxiliaryGraphics=a)}else({status:O,links:U}=E(()=>t?.signal?.aborted??!1,y,g,c,k.subarray(0,A),C.subarray(0,A),F.computationBudgetTime,F.idealEdgeLengthMultiplier,F.repulsionRadiusMultiplier));if((0,u.Te)(t?.signal),O===I.JT.Error)throw new s.A("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");if(O===I.JT.Canceled)throw(0,u.NK)();for(let e=0;e<x.length;e++){if(c[e]>84.9999?c[e]=84.9999:c[e]<-84.9999&&(c[e]=-84.9999),g[e]>179.9999?g[e]=179.9999:g[e]<-179.9999&&(g[e]=-179.9999),x[e].feature.attributes[w.T1]=new f.A(g[e],c[e]),r.has(x[e].typeName)){let t=r.get(x[e].typeName);t?.set(x[e].feature.attributes[w.dr],x[e].feature)}else{let t=new Map;t.set(x[e].feature.attributes[w.dr],x[e].feature),r.set(x[e].typeName,t)}d.set(x[e].feature.attributes[w.dr],x[e].feature);let t=(0,b.Ux)(x[e].feature.attributes[w.T1]);this.entityLinkChartDiagramLookup.set(x[e].feature.attributes[w.dr],x[e].feature.attributes[w.T1]?t:null);let a=(0,h.tE)(this.dataManager.inclusionModeDefinition.namedTypeDefinitions,x[e].typeName,()=>({useAllData:!1,members:new Map}));(0,h.tE)(a.members,x[e].feature.attributes[w.dr],()=>({id:x[e].feature.attributes[w.dr],linkChartLocation:void 0})).linkChartLocation=x[e].feature.attributes[w.T1],x[e].feature.attributes[w.T1].x<D.xmin&&(D.xmin=x[e].feature.attributes[w.T1].x),x[e].feature.attributes[w.T1].x>D.xmax&&(D.xmax=x[e].feature.attributes[w.T1].x),x[e].feature.attributes[w.T1].y<D.ymin&&(D.ymin=x[e].feature.attributes[w.T1].y),x[e].feature.attributes[w.T1].y>D.ymax&&(D.ymax=x[e].feature.attributes[w.T1].y)}if(this.linkChartExtent.xmin=D.xmin,this.linkChartExtent.xmax=D.xmax,this.linkChartExtent.ymin=D.ymin,this.linkChartExtent.ymax=D.ymax,!U)throw new s.A("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");let Z=new Map,B=new Map,j=new Map,Q=new Set;for(let a=0;a<n.length;a++){let i=[],r=n[a],s=r.feature.attributes[w.Cz],u=r.feature.attributes[w.KQ],y=s+"-"+u;if("chronological-mono-timeline"===e||"chronological-multi-timeline"===e){let e=t?.timeInfoByTypeName?.get(r.typeName),a=t?.timeInfoByTypeName?e?.startField:null,i=a?r.feature.attributes[a]:null,n=e?.endField;y+="-"+i+"-"+(n?r.feature.attributes[n]:null)}let g=G.get(y).get(r.typeName),c=0===g?0:U?.vertexEndIndex[g-1];if(!Q.has(g)){if(Q.add(g),U.types[g]===I.J.Recursive){let e=[U.vertices[2*c],U.vertices[2*c+1]],t=[U.vertices[2*(c+1)],U.vertices[2*(c+1)+1]],a=[.5*(e[0]+t[0]),.5*(e[1]+t[1])],n=[a[0]-e[0],a[1]-e[1]],r=[a[0]+n[1],a[1]-n[0]],o=[a[0]-n[1],a[1]+n[0]];i.push(e),i.push(r),i.push(t),i.push(o),i.push(e)}else{if(U.types[g]!==I.J.Regular){l.A.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let e=c;e<U.vertexEndIndex[g];e++)i.push([U.vertices[2*e],U.vertices[2*e+1]])}if("chronological-mono-timeline"!==e&&"chronological-multi-timeline"!==e){let e=x[p.get(s)]?.feature.attributes[w.T1],t=x[p.get(u)]?.feature.attributes[w.T1];i[0][0]===e.x&&i[0][1]===e.y||(i[0]=[e.x,e.y]),i[i.length-1][0]===t.x&&i[i.length-1][1]===t.y||(i[i.length-1]=[t.x,t.y])}for(let e=1;e<i.length-1;e++)i[e][1]>85.5?i[e][1]=85.5:i[e][1]<-85.5&&(i[e][1]=-85.5),i[e][0]>179.9999?i[e][0]=179.9999:i[e][0]<-179.9999&&(i[e][0]=-179.9999);Z.has(y)?Z.get(y).push(i):Z.set(y,[i])}let m=Z.get(y);B.has(y)||(B.set(y,new Map),j.set(y,new Map));let f=B.get(y),L=j.get(y);f.has(r.typeName)||(f.set(r.typeName,m.shift()),L.set(r.typeName,0));let T=f.get(r.typeName);L.set(r.typeName,L.get(r.typeName)+1);let k=new M.A({paths:[T]});if(r.feature.attributes[w.T1]=k,o.has(r.typeName)){let e=o.get(r.typeName);e?.set(r.feature.attributes[w.dr],r.feature)}else{let e=new Map;e.set(r.feature.attributes[w.dr],r.feature),o.set(r.typeName,e)}d.set(r.feature.attributes[w.dr],r.feature);let C=(0,b.Ux)(r.feature.attributes[w.T1]);this.relationshipLinkChartDiagramLookup.set(r.feature.attributes[w.dr],r.feature.attributes[w.T1]?C:null);let N=(0,h.tE)(this.dataManager.inclusionModeDefinition.namedTypeDefinitions,r.typeName,()=>({useAllData:!1,members:new Map}));(0,h.tE)(N.members,r.feature.attributes[w.dr],()=>({id:r.feature.attributes[w.dr],linkChartLocation:void 0})).linkChartLocation=C}for(let e of n)e.feature.attributes[w.M1]=j.get(e.feature.attributes[w.Cz]+"-"+e.feature.attributes[w.KQ])?.get(e.typeName)??null;return this._currentLinkChartConfig={layoutMode:e,layoutSettings:t?.layoutSettings?.clone()},{nodes:r,links:o,idMap:d}}async applyNewLinkChartLayout(e="organic-standard",t){let a=[];await this._calculateLayoutWithSublayerTimeInfo(e,t),this.layers.forEach(e=>{a.push(e.refreshCachedQueryEngine())}),this.membershipModified=!0,await Promise.all(a),this._refreshNamedTypes()}getCurrentNodeLocations(){let e=new Map;for(let[t,a]of this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.entries()??[])this.dataManager.relationshipTypeNames.has(t)||a?.members?.forEach(t=>{let a,i=t.linkChartLocation,n=t.id;i&&(a="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]},e.set(n,new f.A({x:a.x,y:a.y})))});return e}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);let t=[];this.layers.forEach(e=>{t.push(e.refreshCachedQueryEngine())}),await Promise.all(t),this._refreshNamedTypes()}async connectBetweenEntities(e,t){if(!e.length)return{records:[]};let a=[];try{let i=[];for(let e of this.dataManager.relationshipTypeNames){let t=this.sublayerIdsCache.get(e);t&&(i=i.concat(Array.from(t.keys())))}a=await this.dataManager.getRelationshipsBetweenNodes(e,i,t),await this._handleNewRecords(a,t),(0,u.Te)(t)}catch(e){throw(0,u.zf)(e)&&this.removeRecords(a),e}return{records:a}}async connectFromEntities(e,t){if(!e.length)return{records:[]};let a=[];try{let i=[];for(let e of this.dataManager.relationshipTypeNames){let t=this.sublayerIdsCache.get(e);t&&(i=i.concat(Array.from(t.keys())))}let n=[];for(let e of this.dataManager.entityTypeNames){let t=this.sublayerIdsCache.get(e);t&&(n=n.concat(Array.from(t)))}a=await this.dataManager.getRelationshipsFromNodes(e,n,i,t),await this._handleNewRecords(a,t),a.length>0&&(this.membershipModified=!0),(0,u.Te)(t)}catch(e){throw(0,u.zf)(e)&&this.removeRecords(a),e}return{records:a}}getCurrentLayout(){return this._currentLinkChartConfig.layoutMode}async _calculateLayoutWithSublayerTimeInfo(e="organic-standard",t){let a=new Map;this.layers.forEach(e=>{a.set(e.objectType.name,e.timeInfo)}),await this.calculateLinkChartLayout(e,{timeInfoByTypeName:a,...t}),this.linkChart?.handleChronologicalOverlay()}async _handleNewRecords(e,t){let a=[];for(let t of(this.dataManager.addToLayer(e),e))this.sublayerIdsCache.has(t.typeName)||(this.sublayerIdsCache.set(t.typeName,new Set),a.push(t.typeName)),this.sublayerIdsCache.get(t.typeName).add(t.id);for(let e of a){let t=this._graphTypeLookup.get(e);if(t){let a=this._createSublayer(t);"entity"===t.type?this.dataManager.entityTypeNames.add(e):this.dataManager.relationshipTypeNames.add(e),a.geometryType?this.layers.push(a):this.tables.push(a),this.dataManager.sublayerCaches.set(e,new Map)}}await (0,C.qN)(this,a,t),await this.dataManager.refreshCacheContent(e.map(e=>e.id),void 0,void 0,void 0,t);let i={layoutSettings:this._currentLinkChartConfig.layoutSettings,lockedNodeLocations:new Map};for(let[e,t]of this.entityLinkChartDiagramLookup.entries())t&&i.lockedNodeLocations.set(e,new f.A(t.coords[0],t.coords[1]));await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,i)}_createSublayers(e,t,a){e.forEach(e=>{let i=this._createSublayer(e);a(i)&&t.push(i),this._updateSublayerCaches(e)})}_updateSublayers(e,t){t.forEach(t=>{t.parentCompositeLayer=this;let a=e.find(e=>e.type===t.graphType&&e.name===t.graphTypeName);a&&(t.objectType=a,t.read({title:a.name},{origin:"service"}),this._updateSublayerCaches(a))})}_updateSublayerCaches(e){let t=this.dataManager.sublayerCaches;t.has(e.name)||t.set(e.name,new Map)}_layersLoadedFromAuthoritativeItem(){let e=this.originIdOf("layers");return e>=c.Gr.PORTAL_ITEM&&e<c.Gr.USER}async _initializeDiagram(){this.initializationLinkChartConfig?this.initializationLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e,t)=>{e?.members?.forEach(e=>{let a,i=e.linkChartLocation,n=e.id;if(!i)return;a="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]};let r=(0,b.Ux)(a);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(n,r):this.entityLinkChartDiagramLookup.set(n,r),this.linkChartExtent.xmin>a.x&&(this.linkChartExtent.xmin=a.x),this.linkChartExtent.xmax<a.x&&(this.linkChartExtent.xmax=a.x),this.linkChartExtent.ymin>a.y&&(this.linkChartExtent.ymin=a.y),this.linkChartExtent.ymax<a.y&&(this.linkChartExtent.ymax=a.y)})}),this.memberRelationshipTypes.forEach(e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach(e=>{let t=this.relationshipLinkChartDiagramLookup.get(e.attributes[w.Cz]),a=this.relationshipLinkChartDiagramLookup.get(e.attributes[w.KQ]);if(t&&a){let i=(0,b.Ux)(new M.A({paths:[[[t.coords[0],t.coords[1]],[a.coords[0],a.coords[1]]]]}));this.relationshipLinkChartDiagramLookup.set(e.attributes[w.dr],i)}else this.relationshipLinkChartDiagramLookup.set(e.attributes[w.dr],null)})})):await this._calculateLayoutWithSublayerTimeInfo(this.initializationLinkChartConfig.layoutMode,{lockedNodeLocations:this.getCurrentNodeLocations(),...this.initializationLinkChartConfig||{}}):await this._calculateLayoutWithSublayerTimeInfo("organic-standard",{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(let e of this.layers)e.emit("refresh",{dataChanged:!0});for(let e of this.tables)e.emit("refresh",{dataChanged:!0})}_validateOrganicLayoutSettings(e,t){let a=e=>"number"==typeof e&&!isNaN(e),n=e=>a(e)&&e>=0,r={};if(!new Set(["organic-standard","organic-community","geographic-organic-standard","chronological-multi-timeline","chronological-mono-timeline"]).has(e)||!t)return r;let{computationBudgetTime:o,autoRepulsionRadius:s,repulsionRadiusMultiplier:h,absoluteIdealEdgeLength:d,multiplicativeIdealEdgeLength:u,idealEdgeLengthType:p}=t;return a(o)&&o>=1?r.computationBudgetTime=o:o&&l.A.getLogger(this).warn("Invalid layout computationBudgetTime setting, will revert to default setting"),r.autoRepulsionRadius=s,!s&&a(h)&&h>=1?r.repulsionRadiusMultiplier=h:s||(r.autoRepulsionRadius=!0,l.A.getLogger(this).warn("Invalid layout repulsionRadiusMultiplier setting, will revert to default setting")),"geographic-organic-standard"===e&&(Object.values(i).includes(p)?r.idealEdgeLengthType=p:void 0!==p&&l.A.getLogger(this).warn('Invalid layout idealEdgeLengthType setting, will revert to "multiplier" setting'),"absolute-value"===p&&n(d)?r.absoluteIdealEdgeLength=d:"absolute-value"===p&&void 0!==d?l.A.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting"):"multiplier"===p&&n(u)?r.multiplicativeIdealEdgeLength=u:"multiplier"===p&&void 0!==u&&l.A.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting")),r}_convertValidatedOrganicSettingsToCalculationSettings(e){let t=e.idealEdgeLengthType===i.ABSOLUTE?e.absoluteIdealEdgeLength:e.multiplicativeIdealEdgeLength;return e.idealEdgeLengthType===i.ABSOLUTE&&(void 0===t?t=-1:t*=-1),{computationBudgetTime:e.computationBudgetTime??void 0,repulsionRadiusMultiplier:e.repulsionRadiusMultiplier&&!e.autoRepulsionRadius?e.repulsionRadiusMultiplier:void 0,idealEdgeLengthMultiplier:t}}_createSublayer(e){return new k.A({objectType:e,parentCompositeLayer:this,graphType:e.type})}_handleSublayersChange(e,t){t&&(t.forEach(e=>{e.parent=null}),this.removeHandles("sublayers-owner")),e&&(e.forEach(e=>{e.parent=this}),this.addHandles([e.on("after-add",({item:e})=>{e.parent=this}),e.on("after-remove",({item:e})=>{e.parent=null})],"sublayers-owner"))}_alignLayersDataModelAndInclusionDefinition(e){let t=new Set((e.entityTypes??[]).map(e=>e.name).concat((e.relationshipTypes??[]).map(e=>e.name))),a=new Set((e.entityTypes??[]).map(e=>e.name)),i=new Set((e.relationshipTypes??[]).map(e=>e.name));if(this.layers){for(let e of this.layers)!e.graphType&&t.has(e.graphTypeName)&&(e.graphType=a.has(e.graphTypeName)?"entity":"relationship");let e=this.layers.filter(e=>t.has(e.graphTypeName)&&("entity"===e.graphType?a.has(e.graphTypeName):i.has(e.graphTypeName)));this.setAtOrigin("layers",e,(0,c.OL)(this.originIdOf("layers")))}else this.layers=new o.A;if(this.layers&&this._originalInclusionList){let e=new Set(this._originalInclusionList.namedTypeDefinitions.keys()),t=this.tables?.map(e=>e.graphTypeName)??[],a=this.layers.map(e=>e.graphTypeName).concat(t);for(let t of a)e.has(t)||this._originalInclusionList.namedTypeDefinitions.set(t,{useAllData:!1,members:new Map});let i=[];for(let e of this._originalInclusionList.namedTypeDefinitions.keys())a.includes(e)||(l.A.getLogger(this).warn(`A named type, ${e}, was in the serialized feature collection but did not have a sublayer config in the item, so will be removed`),i.push(e));for(let e of i)this._originalInclusionList.namedTypeDefinitions.delete(e)}}};(0,n._)([(0,y.MZ)(_.OZ)],S.prototype,"url",void 0),(0,n._)([(0,y.MZ)()],S.prototype,"dataPreloadedInLocalCache",void 0),(0,n._)([(0,y.MZ)()],S.prototype,"initializationLinkChartConfig",void 0),(0,n._)([(0,y.MZ)()],S.prototype,"membershipModified",void 0),(0,n._)([(0,y.MZ)()],S.prototype,"dataManager",void 0),(0,n._)([(0,y.MZ)()],S.prototype,"initializationInclusionModeDefinition",null),(0,n._)([(0,y.MZ)()],S.prototype,"knowledgeGraph",void 0),(0,n._)([(0,y.MZ)({type:o.A.ofType(k.A),json:{write:{ignoreOrigin:!0}}})],S.prototype,"layers",void 0),(0,n._)([(0,y.MZ)({readOnly:!0})],S.prototype,"linkChart",null),(0,n._)([(0,y.MZ)()],S.prototype,"entityLinkChartDiagramLookup",void 0),(0,n._)([(0,y.MZ)()],S.prototype,"relationshipLinkChartDiagramLookup",void 0),(0,n._)([(0,y.MZ)()],S.prototype,"linkChartExtent",void 0),(0,n._)([(0,y.MZ)()],S.prototype,"memberEntityTypes",void 0),(0,n._)([(0,y.MZ)()],S.prototype,"memberRelationshipTypes",void 0),(0,n._)([(0,y.MZ)({type:["LinkChartLayer"]})],S.prototype,"operationalLayerType",void 0),(0,n._)([(0,y.MZ)()],S.prototype,"sublayerIdsCache",void 0),(0,n._)([(0,y.MZ)({type:o.A.ofType(k.A),json:{write:{ignoreOrigin:!0}}})],S.prototype,"tables",void 0),(0,n._)([(0,y.MZ)({json:{read:!1}})],S.prototype,"type",void 0),(0,n._)([(0,y.MZ)({json:{read:!1}})],S.prototype,"chronologicalAuxiliaryGraphics",void 0);let R=S=(0,n._)([(0,g.$)("esri.layers.LinkChartLayer")],S)}}]);