"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3047],{6272:(e,r,a)=>{a.d(r,{X:()=>s});let s=Symbol("WebScene")},33023:(e,r,a)=>{a.d(r,{A:()=>M});var s=a(81856),n=a(28690);a(57845);var l=a(92753),o=a(91838);a(61939),a(33638);var h=a(12709),p=a(84766),d=a(71760),u=a(33768);let m=Math.PI/180;var g=a(56587),y=a(61849),c=a(79378);let f=(0,p.vt)(),_=[0,0],v=new c.A(0,0,0,0),x={imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1},b=class extends n.A{constructor(e){super(e),this._imagePromise=null,this.bitmaps=[],this.hidpi=x.hidpi,this.imageMaxWidth=x.imageMaxWidth,this.imageMaxHeight=x.imageMaxHeight,this.imageRotationSupported=x.imageRotationSupported,this.imageNormalizationSupported=x.imageNormalizationSupported,this.update=(0,l.sg)(async(e,r)=>{if((0,l.Te)(r),!e.stationary||this.destroyed)return;let a=e.state,s=(0,d.Vp)(a.spatialReference),n=this.hidpi?e.pixelRatio:1,o=a.worldScreenWidth>0,h=o&&this.imageNormalizationSupported&&a.worldScreenWidth<a.size[0],p=Math.round((this.imageMaxWidth??0)/n),u=Math.round((this.imageMaxHeight??0)/n);h?(_[0]=a.worldScreenWidth,_[1]=a.size[1]):this.imageRotationSupported?(_[0]=a.size[0],_[1]=a.size[1]):function(e,r){let a=r.rotation*m,s=Math.abs(Math.cos(a)),n=Math.abs(Math.sin(a)),[l,o]=r.size;e[0]=Math.round(o*n+l*s),e[1]=Math.round(o*s+l*n)}(_,a);let g=Math.floor(_[0])>p||Math.floor(_[1])>u,y=s&&(a.extent.xmin<s.valid[0]||a.extent.xmax>s.valid[1]),c=!this.imageNormalizationSupported&&y,f=this.imageRotationSupported?a.rotation:0,v=this.container.children.slice();if(g||c){let e=Math.min(p,u);o&&(e=Math.min(a.worldScreenWidth,e),e=Math.round(a.worldScreenWidth/Math.ceil(a.worldScreenWidth/e))),this._imagePromise=this._tiledExport(a,e,n,r)}else{let e=h?a.paddedViewState.center:a.center;this._imagePromise=this._singleExport(a,_,e,a.resolution,f,n,r)}try{let e=await this._imagePromise??[];(0,l.Te)(r);let a=[];if(this._imagePromise=null,this.destroyed)return;for(let r of(this.bitmaps=e,v))e.includes(r)||a.push(r.fadeOut().then(()=>{r.remove(),r.destroy()}));for(let r of e)a.push(r.fadeIn());await Promise.all(a)}catch(e){this._imagePromise=null,(0,l.QP)(e)}},5e3),this.updateExports=(0,l.sg)(async e=>{let r=[];for(let a of this.container.children){if(!a.visible||!a.stage)return;r.push(e(a).then(()=>{a.invalidateTexture(),a.requestRender()}))}this._imagePromise=(0,l.Lx)(r).then(()=>this._imagePromise=null),await this._imagePromise})}destroy(){this.bitmaps.forEach(e=>e.destroy()),this.bitmaps=[]}get updating(){return!this.destroyed&&null!==this._imagePromise}async _export(e,r,a,s,n,o){let h=await this.fetchSource(e,Math.floor(r*n),Math.floor(a*n),{rotation:s,pixelRatio:n,signal:o});(0,l.Te)(o);let p=new g.mb(null,!0);return p.x=e.xmin,p.y=e.ymax,p.resolution=e.width/r,p.rotation=s,p.pixelRatio=n,p.opacity=0,this.container.addChild(p),await p.setSourceAsync(h,o),(0,l.Te)(o),p}async _singleExport(e,r,a,s,n,l,o){var h=f,d=a,u=s,m=r;let[g,y]=d,[c,_]=m,v=.5*u;h[0]=g-v*c,h[1]=y-v*_,h[2]=g+v*c,h[3]=y+v*_;let x=(0,p.w1)(f,e.spatialReference);return[await this._export(x,r[0],r[1],n,l,o)]}_tiledExport(e,r,a,s){let n=u.A.create({size:r,spatialReference:e.spatialReference,scales:[e.scale]}),l=new y.A(n),o=l.getTileCoverage(e);if(!o)return null;let h=[];return o.forEach((n,o,d,u)=>{v.set(n,o,d,0),l.getTileBounds(f,v);let m=(0,p.w1)(f,e.spatialReference);h.push(this._export(m,r,r,0,a,s).then(e=>(0!==u&&(v.set(n,o,d,u),l.getTileBounds(f,v),e.x=f[0],e.y=f[3]),e)))}),Promise.all(h)}};(0,s._)([(0,o.MZ)()],b.prototype,"_imagePromise",void 0),(0,s._)([(0,o.MZ)()],b.prototype,"bitmaps",void 0),(0,s._)([(0,o.MZ)()],b.prototype,"container",void 0),(0,s._)([(0,o.MZ)()],b.prototype,"fetchSource",void 0),(0,s._)([(0,o.MZ)()],b.prototype,"hidpi",void 0),(0,s._)([(0,o.MZ)()],b.prototype,"imageMaxWidth",void 0),(0,s._)([(0,o.MZ)()],b.prototype,"imageMaxHeight",void 0),(0,s._)([(0,o.MZ)()],b.prototype,"imageRotationSupported",void 0),(0,s._)([(0,o.MZ)()],b.prototype,"imageNormalizationSupported",void 0),(0,s._)([(0,o.MZ)()],b.prototype,"requestUpdate",void 0),(0,s._)([(0,o.MZ)()],b.prototype,"updating",null);let M=b=(0,s._)([(0,h.$)("esri.views.2d.layers.support.ExportStrategy")],b)},37779:(e,r,a)=>{a.d(r,{g:()=>g});var s=a(81856),n=a(28690),l=a(97409),o=a(91838);a(57845),a(61939),a(33638);var h=a(12709),p=a(70429),d=a(98569),u=a(85312);let m={visible:"visibleSublayers",definitionExpression:"layerDefs",labelingInfo:"hasDynamicLayers",labelsVisible:"hasDynamicLayers",opacity:"hasDynamicLayers",minScale:"visibleSublayers",maxScale:"visibleSublayers",renderer:"hasDynamicLayers",source:"hasDynamicLayers"},g=class extends n.A{constructor(e){super(e),this.floors=null,this.scale=0}destroy(){this.layer=null}get dynamicLayers(){if(!this.hasDynamicLayers)return null;let e=this.visibleSublayers.map(e=>{let r=(0,d.f)(this.floors,e);return e.toExportImageJSON(r)});return e.length?JSON.stringify(e):null}get hasDynamicLayers(){return this.layer&&(0,u.Sk)(this.visibleSublayers,this.layer.serviceSublayers,this.layer.gdbVersion)}set layer(e){this._get("layer")!==e&&(this._set("layer",e),this.removeHandles("layer"),e&&this.addHandles([e.allSublayers.on("change",()=>this.notifyChange("visibleSublayers")),e.on("sublayer-update",e=>this.notifyChange(m[e.propertyName]))],"layer"))}get layers(){let e=this.visibleSublayers;return e?e.length?"show:"+e.map(e=>e.id).join(","):"show:-1":null}get layerDefs(){let e=!!this.floors?.length,r=this.visibleSublayers.filter(r=>null!=r.definitionExpression||e&&null!=r.floorInfo);return r.length?JSON.stringify(r.reduce((e,r)=>{let a=(0,d.f)(this.floors,r),s=(0,l.mA)(a,r.definitionExpression);return null!=s&&(e[r.id]=s),e},{})):null}get version(){this.commitProperty("layers"),this.commitProperty("layerDefs"),this.commitProperty("dynamicLayers");let e=this.layer;return e&&(e.commitProperty("dpi"),e.commitProperty("imageFormat"),e.commitProperty("imageTransparency"),e.commitProperty("gdbVersion")),(this._get("version")||0)+1}get visibleSublayers(){let e=[];if(!this.layer)return e;let r=this.layer.sublayers,a=this.scale,s=r=>{r.visible&&(0===a||(0,p.zx)(a,r.minScale,r.maxScale))&&(r.sublayers?r.sublayers.forEach(s):e.unshift(r))};r&&r.forEach(s);let n=this._get("visibleSublayers");return!n||n.length!==e.length||n.some((r,a)=>e[a]!==r)?e:n}toJSON(){let e=this.layer,r={dpi:e.dpi,format:e.imageFormat,transparent:e.imageTransparency,gdbVersion:e.gdbVersion||null};return this.hasDynamicLayers&&this.dynamicLayers?r.dynamicLayers=this.dynamicLayers:r={...r,layers:this.layers,layerDefs:this.layerDefs},r}};(0,s._)([(0,o.MZ)({readOnly:!0})],g.prototype,"dynamicLayers",null),(0,s._)([(0,o.MZ)()],g.prototype,"floors",void 0),(0,s._)([(0,o.MZ)({readOnly:!0})],g.prototype,"hasDynamicLayers",null),(0,s._)([(0,o.MZ)()],g.prototype,"layer",null),(0,s._)([(0,o.MZ)({readOnly:!0})],g.prototype,"layers",null),(0,s._)([(0,o.MZ)({readOnly:!0})],g.prototype,"layerDefs",null),(0,s._)([(0,o.MZ)({type:Number})],g.prototype,"scale",void 0),(0,s._)([(0,o.MZ)({readOnly:!0})],g.prototype,"version",null),(0,s._)([(0,o.MZ)({readOnly:!0})],g.prototype,"visibleSublayers",null),g=(0,s._)([(0,h.$)("esri.layers.support.ExportImageParameters")],g)},54506:(e,r,a)=>{a.d(r,{l:()=>o});var s=a(52548),n=a(24080),l=a(42271);class o extends n.A{constructor(){super(...arguments),this._hasCrossfade=!1,this._bitmapTechnique=null}get requiresDedicatedFBO(){return super.requiresDedicatedFBO||this._hasCrossfade}beforeRender(e){super.beforeRender(e),this._manageFade()}onAttach(){super.onAttach(),this._bitmapTechnique=new l.C}onDetach(){super.onDetach(),this._bitmapTechnique?.shutdown(),this._bitmapTechnique=null}renderChildren(e){super.renderChildren(e),this.visible&&e.drawPhase===s.S5.MAP&&null!=this._bitmapTechnique&&this._bitmapTechnique.render(e,{bitmaps:this.children})}_manageFade(){this.children.reduce((e,r)=>e+ +!!r.inFadeTransition,0)>=2?(this.children.forEach(e=>e.blendFunction="additive"),this._hasCrossfade=!0):(this.children.forEach(e=>e.blendFunction="standard"),this._hasCrossfade=!1)}}},63047:(e,r,a)=>{a.r(r),a.d(r,{default:()=>H});var s=a(81856),n=a(19158),l=a(61939),o=a(92753),h=a(45257),p=a(91838);a(57845),a(33638);var d=a(12709),u=a(65372),m=a(54506),g=a(88230),y=a(40479),c=a(15137),f=a(33023),_=a(69931),v=a(85511),x=a(37779),b=a(72145);let M=e=>{let r=class extends e{initialize(){this.exportImageParameters=new x.g({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get floors(){return this.view?.floors??null}get exportImageVersion(){return this.exportImageParameters?.commitProperty("version"),this.commitProperty("timeExtent"),this.commitProperty("floors"),(this._get("exportImageVersion")||0)+1}get timeExtent(){return(0,b.F)(this.layer,this.view?.timeExtent,this._get("timeExtent"))}canResume(){return!!super.canResume()&&!this.timeExtent?.isEmpty}};return(0,s._)([(0,p.MZ)()],r.prototype,"exportImageParameters",void 0),(0,s._)([(0,p.MZ)({readOnly:!0})],r.prototype,"floors",null),(0,s._)([(0,p.MZ)({readOnly:!0})],r.prototype,"exportImageVersion",null),(0,s._)([(0,p.MZ)()],r.prototype,"layer",void 0),(0,s._)([(0,p.MZ)()],r.prototype,"suspended",void 0),(0,s._)([(0,p.MZ)({readOnly:!0})],r.prototype,"timeExtent",null),r=(0,s._)([(0,d.$)("esri.views.layers.MapImageLayerView")],r)};var S=a(80468),w=a(28322),E=a(66241),P=a(28544);let T=class extends M((0,S.A)((0,g.e)(v.A))){constructor(){super(...arguments),this._highlightGraphics=new u.Y,this._updateHash=""}fetchPopupFeaturesAtLocation(e,r){return this._popupHighlightHelper.fetchPopupFeaturesAtLocation(e,r)}update(e){let r=`${this.exportImageVersion}/${e.state.id}/${e.pixelRatio}/${e.stationary}`;this._updateHash!==r&&(this._updateHash=r,this.strategy.update(e).catch(e=>{(0,o.zf)(e)||l.A.getLogger(this).error(e)}),e.stationary&&this._popupHighlightHelper.updateHighlightedFeatures(e.state.resolution)),this._highlightView.processUpdate(e)}attach(){let{imageMaxWidth:e,imageMaxHeight:r,version:a}=this.layer;this._bitmapContainer=new m.l,this.container.addChild(this._bitmapContainer),this._highlightView=new y.A({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new c.A(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1}),this.container.addChild(this._highlightView.container),this._popupHighlightHelper=new w.Uh({createFetchPopupFeaturesQueryGeometry:(e,r)=>(0,E.V)(e,r,this.view),highlightGraphics:this._highlightGraphics,highlightGraphicUpdated:(e,r)=>{this._highlightView.graphicUpdateHandler({graphic:e,property:r})},layerView:this,updatingHandles:this._updatingHandles}),this.strategy=new f.A({container:this._bitmapContainer,fetchSource:this.fetchImageBitmap.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:e,imageMaxHeight:r,imageRotationSupported:a>=10.3,imageNormalizationSupported:a>=10,hidpi:!0}),this.addAttachHandles((0,h.wB)(()=>this.exportImageVersion,()=>this.requestUpdate())),this.requestUpdate()}detach(){this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren(),this._highlightView.destroy(),this._popupHighlightHelper.destroy()}viewChange(){}moveEnd(){this.requestUpdate()}supportsSpatialReference(e){return this.layer.serviceSupportsSpatialReference(e)}async doRefresh(){this._updateHash="",this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(e,r,a,s){return this.layer.fetchImage(e,r,a,{timeExtent:this.timeExtent,floors:this.floors,...s})}fetchImageBitmap(e,r,a,s){return this.layer.fetchImageBitmap(e,r,a,{timeExtent:this.timeExtent,floors:this.floors,...s})}highlight(e,r){let a=(0,_.Oq)(e);if(0===a.length)return(0,n.hA)();let s=r?.name??P.Tv;return this._addHighlightGraphics(a,s),(0,n.hA)(()=>!this.destroyed&&this._removeHighlightGraphics(a,s))}_processHighlight(){let e=this._getHighlights();this._highlightView?.setHighlight(e)}_addHighlightGraphics(e,r){this._highlightGraphics.addMany(e),this._addHighlights(e.map(e=>e.uid),r)}_removeHighlightGraphics(e,r){this._highlightGraphics.removeMany(e),this._removeHighlights(e.map(e=>e.uid),r)}};(0,s._)([(0,p.MZ)()],T.prototype,"strategy",void 0),(0,s._)([(0,p.MZ)()],T.prototype,"updating",void 0);let H=T=(0,s._)([(0,d.$)("esri.views.2d.layers.MapImageLayerView2D")],T)},72145:(e,r,a)=>{a.d(r,{F:()=>h}),a(31461),a(33715);var s=a(72359),n=a(47840);function l(e){return void 0!==e.timeInfo}a(24927),a(6272);async function o(e,r){if(0===e.length)return i.allTime;await Promise.all(e.map(e=>e.load({signal:r})));let a=e.filter(l),s=e.filter(e=>!l(e)&&null!=e.visibilityTimeExtent);if(0===a.length&&0===s.length)return i.allTime;let n=[],o=[];for(let e of a)("feature"===e?.type||"map-image"===e?.type)&&e.timeInfo?.hasLiveData?n.push(e):o.push(e);let h=e=>null==e||e.isAllTime,p=[...o.map(e=>{let r=e.timeInfo?.fullTimeExtent,{visibilityTimeExtent:a}=e;return r?.intersection(a)??a}),...s.map(e=>e.visibilityTimeExtent)];if(p.some(h))return i.allTime;let d=n.map(async e=>{let a=(await e.fetchRecomputedExtents({signal:r}))?.timeExtent??e.timeInfo?.fullTimeExtent,{visibilityTimeExtent:s}=e;return a?.intersection(s)??s}),u=(await Promise.allSettled(d)).map(e=>"fulfilled"===e.status?e.value:null);if(u.some(h))return i.allTime;let m=[...u,...p].filter(t);return 0===m.length?i.allTime:m.reduce((e,r)=>e.union(r))}function h(e,r,a){if(null==e?.timeInfo)return null;let{datesInUnknownTimezone:l=!1,timeOffset:o,useViewTime:h}=e,p=e.timeExtent;l&&(p=function(e){if(!e)return e;let{start:r,end:a}=e;return new n.A({start:null!=r?(0,s.S1)(r,r.getTimezoneOffset(),"minutes"):r,end:null!=a?(0,s.S1)(a,a.getTimezoneOffset(),"minutes"):a})}(p));let d=h?r&&p?r.intersection(p):r||p:p;return!d||d.isEmpty||d.isAllTime?d:(o&&(d=d.offset(-o.value,o.unit)),l&&(d=function(e){if(!e)return e;let{start:r,end:a}=e;return new n.A({start:null!=r?(0,s.S1)(r,-r.getTimezoneOffset(),"minutes"):r,end:null!=a?(0,s.S1)(a,-a.getTimezoneOffset(),"minutes"):a})}(d)),d.equals(a)?a:d)}}}]);